<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNets FX AI Trading System v3.0 | Professional Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* MetaTrader 5 Color Palette */
            --mt5-bg-primary: #0c141f;
            --mt5-bg-secondary: #1e2a38;
            --mt5-bg-tertiary: #2d3b4d;
            --mt5-border: #3c4d60;
            --mt5-text-primary: #e0e7f0;
            --mt5-text-secondary: #8a9aad;
            --mt5-accent-blue: #4a9eff;
            --mt5-accent-green: #4caf50;
            --mt5-accent-red: #f44336;
            --mt5-accent-yellow: #ffc107;
            --mt5-accent-teal: #00b4a0;
            
            /* Trading Colors */
            --buy-color: #26a69a;
            --sell-color: #ef5350;
            --neutral-color: #78909c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            background: var(--mt5-bg-primary);
            color: var(--mt5-text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 12px;
        }
        
        /* Main Container */
        .mt5-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            flex-direction: column;
        }
        
        /* Top Navigation Bar */
        .top-nav {
            background: var(--mt5-bg-secondary);
            border-bottom: 1px solid var(--mt5-border);
            height: 24px;
            display: flex;
            align-items: center;
            padding: 0 8px;
        }
        
        .nav-item {
            padding: 0 10px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
            color: var(--mt5-text-primary);
            position: relative;
            border-right: 1px solid var(--mt5-border);
        }
        
        .nav-item:hover {
            background: var(--mt5-bg-tertiary);
        }
        
        .nav-item.active {
            background: var(--mt5-bg-primary);
        }
        
        .nav-item.has-dropdown::after {
            content: "â–¼";
            font-size: 8px;
            margin-left: 4px;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--mt5-bg-secondary);
            border: 1px solid var(--mt5-border);
            border-radius: 2px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid rgba(60, 77, 96, 0.3);
        }
        
        .dropdown-item:hover {
            background: var(--mt5-bg-tertiary);
        }
        
        .dropdown-item i {
            width: 16px;
            text-align: center;
            color: var(--mt5-text-secondary);
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--mt5-border);
            margin: 4px 0;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Left Sidebar - Navigator */
        .left-sidebar {
            width: 240px;
            background: var(--mt5-bg-secondary);
            border-right: 1px solid var(--mt5-border);
            display: flex;
            flex-direction: column;
        }
        
        .navigator-header {
            padding: 8px 12px;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--mt5-text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navigator-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .nav-section {
            margin-bottom: 12px;
        }
        
        .nav-section-title {
            padding: 6px 8px;
            font-weight: 600;
            color: var(--mt5-text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            background: rgba(60, 77, 96, 0.2);
            border-radius: 2px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-section-title:hover {
            background: rgba(60, 77, 96, 0.4);
        }
        
        .nav-item-list {
            padding-left: 16px;
        }
        
        .nav-subitem {
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border-radius: 2px;
            margin-bottom: 2px;
        }
        
        .nav-subitem:hover {
            background: var(--mt5-bg-tertiary);
        }
        
        .nav-subitem.active {
            background: var(--mt5-accent-blue);
            color: white;
        }
        
        .nav-subitem i {
            width: 16px;
            text-align: center;
            font-size: 10px;
            color: var(--mt5-text-secondary);
        }
        
        /* Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* Chart Tabs Area */
        .chart-tabs-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--mt5-bg-primary);
            min-height: 300px;
        }
        
        .chart-tabs-header {
            display: flex;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            height: 28px;
            overflow-x: auto;
        }
        
        .chart-tab {
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-right: 1px solid var(--mt5-border);
            white-space: nowrap;
            min-width: 120px;
            font-size: 11px;
        }
        
        .chart-tab:hover {
            background: var(--mt5-bg-secondary);
        }
        
        .chart-tab.active {
            background: var(--mt5-bg-primary);
            border-bottom: 2px solid var(--mt5-accent-teal);
        }
        
        .chart-tab-close {
            margin-left: auto;
            opacity: 0.5;
            font-size: 10px;
        }
        
        .chart-tab-close:hover {
            opacity: 1;
            color: var(--mt5-accent-red);
        }
        
        .add-chart-tab {
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border-right: 1px solid var(--mt5-border);
            color: var(--mt5-text-secondary);
        }
        
        .add-chart-tab:hover {
            background: var(--mt5-bg-secondary);
            color: var(--mt5-accent-teal);
        }
        
        /* Chart Container */
        .chart-container {
            flex: 1;
            position: relative;
            background: #0a141f;
            overflow: hidden;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
        }
        
        .symbol-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .symbol-price {
            font-size: 18px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .price-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 2px;
            background: rgba(244, 67, 54, 0.2);
            color: var(--mt5-accent-red);
            font-weight: 600;
        }
        
        .price-change.positive {
            background: rgba(76, 175, 80, 0.2);
            color: var(--mt5-accent-green);
        }
        
        .price-info {
            color: var(--mt5-text-secondary);
            font-size: 10px;
        }
        
        .price-bid {
            color: var(--buy-color);
            font-weight: 600;
        }
        
        .price-ask {
            color: var(--sell-color);
            font-weight: 600;
        }
        
        /* Toolbar with Shortcuts */
        .toolbar-shortcuts {
            display: flex;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            padding: 4px 8px;
            gap: 8px;
            overflow-x: auto;
        }
        
        .shortcut-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--mt5-border);
            border-radius: 2px;
            color: var(--mt5-text-primary);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .shortcut-btn:hover {
            background: var(--mt5-bg-secondary);
        }
        
        .shortcut-btn.active {
            background: var(--mt5-accent-teal);
            border-color: var(--mt5-accent-teal);
            color: white;
        }
        
        /* Bottom Panel Container */
        .bottom-panel-container {
            display: flex;
            flex-direction: column;
            height: 250px;
            min-height: 200px;
            max-height: 400px;
            border-top: 1px solid var(--mt5-border);
            background: var(--mt5-bg-secondary);
        }
        
        /* Bottom Panel Tabs */
        .bottom-panel-tabs {
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            height: 28px;
            display: flex;
            flex-shrink: 0;
        }
        
        .panel-tab {
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border-right: 1px solid var(--mt5-border);
            font-size: 11px;
            color: var(--mt5-text-secondary);
            white-space: nowrap;
        }
        
        .panel-tab:hover {
            background: var(--mt5-bg-secondary);
            color: var(--mt5-text-primary);
        }
        
        .panel-tab.active {
            background: var(--mt5-bg-primary);
            color: var(--mt5-text-primary);
            border-bottom: 2px solid var(--mt5-accent-teal);
        }
        
        .panel-content-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .panel-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--mt5-bg-secondary);
            display: none;
            overflow-y: auto;
        }
        
        .panel-content.active {
            display: block;
        }
        
        /* Trade Panel */
        .trade-panel {
            padding: 12px;
        }
        
        .order-form {
            display: grid;
            gap: 8px;
        }
        
        .order-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .order-label {
            color: var(--mt5-text-secondary);
            font-size: 10px;
        }
        
        .order-value {
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 11px;
        }
        
        .btn-buy {
            background: var(--buy-color);
            color: white;
        }
        
        .btn-buy:hover {
            background: #208d83;
        }
        
        .btn-sell {
            background: var(--sell-color);
            color: white;
        }
        
        .btn-sell:hover {
            background: #d32f2f;
        }
        
        /* Consistent Panel Styles */
        .panel-inner {
            padding: 12px;
            height: auto;
            min-height: 100%;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--mt5-text-primary);
        }

        .panel-actions {
            display: flex;
            gap: 4px;
        }

        .panel-btn-small {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--mt5-border);
            border-radius: 2px;
            color: var(--mt5-text-secondary);
            cursor: pointer;
            font-size: 10px;
        }

        .panel-btn-small:hover {
            background: var(--mt5-bg-tertiary);
        }

        .panel-btn-small.active {
            background: var(--mt5-accent-teal);
            border-color: var(--mt5-accent-teal);
            color: white;
        }

        /* Content Sections */
        .content-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 11px;
            color: var(--mt5-text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Card Styles */
        .info-card {
            padding: 10px;
            background: var(--mt5-bg-tertiary);
            border-radius: 4px;
            text-align: center;
        }

        .info-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--mt5-text-primary);
            margin-bottom: 4px;
        }

        .info-label {
            font-size: 10px;
            color: var(--mt5-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Alert/Notification Cards */
        .alert-card {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid var(--mt5-border);
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: var(--mt5-accent-green);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: var(--mt5-accent-yellow);
        }

        .alert-danger {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: var(--mt5-accent-red);
        }

        .alert-info {
            background: rgba(0, 180, 160, 0.1);
            border-left-color: var(--mt5-accent-teal);
        }

        /* Data Grid */
        .data-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .data-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        /* Form Controls */
        .form-control-small {
            width: 100%;
            padding: 6px 8px;
            background: var(--mt5-bg-primary);
            border: 1px solid var(--mt5-border);
            border-radius: 3px;
            color: var(--mt5-text-primary);
            font-size: 11px;
        }

        .form-control-small:focus {
            outline: none;
            border-color: var(--mt5-accent-teal);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        .data-table th {
            padding: 8px;
            text-align: left;
            background: var(--mt5-bg-tertiary);
            color: var(--mt5-text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--mt5-border);
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(60, 77, 96, 0.3);
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--mt5-border);
            border-radius: 4px;
            margin-bottom: 16px;
        }

        /* Scrollable Areas */
        .scrollable-area {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .scrollable-area::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-area::-webkit-scrollbar-thumb {
            background: var(--mt5-border);
            border-radius: 2px;
        }

        /* Market Watch Sidebar (now on left) */
        .market-watch-sidebar {
            width: 0;
            background: var(--mt5-bg-secondary);
            border-right: 1px solid var(--mt5-border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        
        .market-watch-sidebar.show {
            width: 280px;
        }
        
        .market-watch {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            width: 280px;
        }
        
        .market-watch-header {
            padding: 8px 12px;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .market-watch-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .symbol-row {
            display: grid;
            grid-template-columns: 70px 1fr 1fr;
            padding: 6px 12px;
            border-bottom: 1px solid rgba(60, 77, 96, 0.3);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .symbol-row:hover {
            background: var(--mt5-bg-tertiary);
        }
        
        .symbol-row.active {
            background: rgba(74, 158, 255, 0.2);
        }
        
        .symbol-name {
            font-weight: 600;
        }
        
        .symbol-bid {
            text-align: right;
            color: var(--buy-color);
        }
        
        .symbol-ask {
            text-align: right;
            color: var(--sell-color);
        }
        
        /* Status Bar */
        .status-bar {
            background: var(--mt5-bg-tertiary);
            border-top: 1px solid var(--mt5-border);
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--mt5-text-secondary);
            align-items: center;
            flex-shrink: 0;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--mt5-accent-green);
        }
        
        /* Modal Windows */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--mt5-bg-secondary);
            border: 1px solid var(--mt5-border);
            border-radius: 4px;
            z-index: 2000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-header {
            padding: 10px 16px;
            background: var(--mt5-bg-tertiary);
            border-bottom: 1px solid var(--mt5-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .modal-close {
            cursor: pointer;
            color: var(--mt5-text-secondary);
        }
        
        .modal-close:hover {
            color: var(--mt5-accent-red);
        }
        
        .modal-content {
            padding: 16px;
            min-width: 400px;
        }
        
        /* New Order Modal */
        .new-order-form {
            display: grid;
            gap: 12px;
        }
        
        .form-group {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 8px;
            align-items: center;
        }
        
        .form-label {
            color: var(--mt5-text-secondary);
            font-size: 11px;
        }
        
        .form-control {
            padding: 6px 8px;
            background: var(--mt5-bg-primary);
            border: 1px solid var(--mt5-border);
            border-radius: 3px;
            color: var(--mt5-text-primary);
            font-family: 'Courier New', monospace;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--mt5-accent-teal);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--mt5-bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--mt5-border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--mt5-accent-blue);
        }

        /* Table specific styles */
        .pl-positive {
            color: var(--mt5-accent-green);
            font-weight: 600;
        }

        .pl-negative {
            color: var(--mt5-accent-red);
            font-weight: 600;
        }

        .trade-buy {
            color: var(--mt5-accent-green);
            text-transform: uppercase;
            font-weight: 600;
        }

        .trade-sell {
            color: var(--mt5-accent-red);
            text-transform: uppercase;
            font-weight: 600;
        }

        .history-number {
            font-family: 'Courier New', monospace;
        }

        /* Strategy Panel Styles */
        .active-strategy {
            border: 2px solid var(--mt5-accent-teal) !important;
        }

        .checkmark {
            transition: all 0.3s ease;
        }
        
        /* Panel resize handle */
        .panel-resize-handle {
            height: 4px;
            background: var(--mt5-border);
            cursor: ns-resize;
            position: relative;
        }
        
        .panel-resize-handle:hover {
            background: var(--mt5-accent-teal);
        }
        
        .panel-resize-handle:after {
            content: "";
            position: absolute;
            top: 1px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--mt5-text-secondary);
        }
        
        /* Panel content adjustments for scrolling */
        .panel-content .panel-inner {
            height: auto;
            min-height: calc(100% - 24px);
        }
        
        /* Market Watch toggle button */
        .market-watch-toggle {
            margin-right: 8px;
        }
        
        .market-watch-toggle.active {
            background: var(--mt5-accent-teal);
            border-color: var(--mt5-accent-teal);
            color: white;
        }
    </style>
</head>
<body>
    <div class="mt5-container">
        <!-- Top Navigation Bar -->
        <div class="top-nav">
            <div class="nav-item has-dropdown" id="fileMenu">
                <span>File</span>
                <div class="dropdown-menu" id="fileDropdown">
                    <div class="dropdown-item has-dropdown">
                        <i class="fas fa-chart-line"></i>
                        <span>New Chart</span>
                        <div class="dropdown-menu" style="left: 100%; top: 0;">
                            <div class="dropdown-item"><span>MBTUSD</span></div>
                            <div class="dropdown-item"><span>MBTUSDm</span></div>
                            <div class="dropdown-item"><span>USDAED</span></div>
                            <div class="dropdown-item"><span>USDAMD</span></div>
                            <div class="dropdown-item"><span>USDARS</span></div>
                            <div class="dropdown-item"><span>USDAZN</span></div>
                        </div>
                    </div>
                    <div class="dropdown-item has-dropdown">
                        <i class="fas fa-chart-bar"></i>
                        <span>Forex_Indicator</span>
                    </div>
                    <div class="dropdown-item has-dropdown">
                        <i class="fas fa-bars"></i>
                        <span>Standard</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item has-dropdown">
                        <i class="fas fa-folder-open"></i>
                        <span>Open Deleted</span>
                    </div>
                    <div class="dropdown-item has-dropdown">
                        <i class="fas fa-user"></i>
                        <span>Profiles</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item">
                        <i class="fas fa-times"></i>
                        <span>Close</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-save"></i>
                        <span>Save</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-image"></i>
                        <span>Save as Picture</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-folder"></i>
                        <span>Open Data Folder</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item">
                        <i class="fas fa-print"></i>
                        <span>Print</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-eye"></i>
                        <span>Print View</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Print Setup</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item">
                        <i class="fas fa-plus"></i>
                        <span>Open an account</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-arrow-down"></i>
                        <span>Deposit</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-arrow-up"></i>
                        <span>Withdraw</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login with trade account</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-globe"></i>
                        <span>Login to Web Trader</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-users"></i>
                        <span>Login to MQL5.community</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Exit</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>View</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item"><i class="fas fa-eye"></i><span>Languages</span></div>
                    <div class="dropdown-item"><i class="fas fa-palette"></i><span>Color Themes</span></div>
                    <div class="dropdown-item"><i class="fas fa-toolbox"></i><span>Toolbars</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-window-maximize"></i><span>Status Bar</span></div>
                    <div class="dropdown-item"><i class="fas fa-chart-bar"></i><span>Chart Bar</span></div>
                    <div class="dropdown-item"><i class="fas fa-dollar-sign"></i><span>Symbols</span></div>
                    <div class="dropdown-item"><i class="fas fa-chart-line"></i><span>Depth of Market</span></div>
                    <div class="dropdown-item"><i class="fas fa-eye"></i><span>Market Watch</span></div>
                    <div class="dropdown-item"><i class="fas fa-database"></i><span>Data Window</span></div>
                    <div class="dropdown-item"><i class="fas fa-compass"></i><span>Navigator</span></div>
                    <div class="dropdown-item"><i class="fas fa-toolbox"></i><span>Toolbox</span></div>
                    <div class="dropdown-item"><i class="fas fa-flask"></i><span>Strategy tester</span></div>
                    <div class="dropdown-item"><i class="fas fa-chart-area"></i><span>Charts</span></div>
                    <div class="dropdown-item"><i class="fas fa-file-alt"></i><span>Reports</span></div>
                    <div class="dropdown-item"><i class="fas fa-expand"></i><span>Fullscreen</span></div>
                </div>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>Insert</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item"><i class="fas fa-chart-line"></i><span>Indicators</span></div>
                    <div class="dropdown-item"><i class="fas fa-shapes"></i><span>Objects</span></div>
                    <div class="dropdown-item"><i class="fas fa-robot"></i><span>Experts</span></div>
                    <div class="dropdown-item"><i class="fas fa-code"></i><span>Scripts</span></div>
                </div>
            </div>
            
            <div class="nav-item">
                <span>Candles</span>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>Charts</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item"><i class="fas fa-chart-line"></i><span>Depth of Market</span></div>
                    <div class="dropdown-item"><i class="fas fa-shapes"></i><span>Objects</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-chart-bar"></i><span>Bar charts</span></div>
                    <div class="dropdown-item"><i class="fas fa-fire"></i><span>Candlesticks</span></div>
                    <div class="dropdown-item"><i class="fas fa-chart-line"></i><span>Line Charts</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-clock"></i><span>Timeframes</span></div>
                    <div class="dropdown-item"><i class="fas fa-layer-group"></i><span>Templates</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-th"></i><span>Grid</span></div>
                    <div class="dropdown-item"><i class="fas fa-scroll"></i><span>Auto scroll</span></div>
                    <div class="dropdown-item"><i class="fas fa-arrows-alt-h"></i><span>Chart Shift</span></div>
                    <div class="dropdown-item"><i class="fas fa-chart-bar"></i><span>Volumes</span></div>
                    <div class="dropdown-item"><i class="fas fa-wave-square"></i><span>Tick Volumes</span></div>
                    <div class="dropdown-item"><i class="fas fa-signal"></i><span>Trade Levels</span></div>
                    <div class="dropdown-item"><i class="fas fa-history"></i><span>Trade History</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-search-plus"></i><span>Zoom In</span></div>
                    <div class="dropdown-item"><i class="fas fa-search-minus"></i><span>Zoom Out</span></div>
                    <div class="dropdown-item"><i class="fas fa-step-forward"></i><span>Step by Step</span></div>
                    <div class="dropdown-item"><i class="fas fa-cog"></i><span>Properties</span></div>
                </div>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>Tools</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item" id="newOrderBtn">
                        <i class="fas fa-plus"></i>
                        <span>New Order</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-calculator"></i><span>Calculator</span></div>
                    <div class="dropdown-item"><i class="fas fa-history"></i><span>History Center</span></div>
                    <div class="dropdown-item"><i class="fas fa-cog"></i><span>Global Variables</span></div>
                    <div class="dropdown-item"><i class="fas fa-flask"></i><span>MetaEditor</span></div>
                    <div class="dropdown-item"><i class="fas fa-database"></i><span>Options</span></div>
                </div>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>Window</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item"><i class="fas fa-th"></i><span>Tile Windows</span></div>
                    <div class="dropdown-item"><i class="fas fa-layer-group"></i><span>Cascade</span></div>
                    <div class="dropdown-item"><i class="fas fa-grip-horizontal"></i><span>Tile Horizontally</span></div>
                    <div class="dropdown-item"><i class="fas fa-grip-vertical"></i><span>Tile Vertically</span></div>
                    <div class="dropdown-item"><i class="fas fa-th-list"></i><span>Arrange Icons</span></div>
                    <div class="dropdown-item"><i class="fas fa-undo"></i><span>Reset to Default</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-desktop"></i><span>Resolution</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-chart-line"></i><span>XAUUSDm,M30</span></div>
                </div>
            </div>
            
            <div class="nav-item has-dropdown">
                <span>Help</span>
                <div class="dropdown-menu" style="min-width: 250px;">
                    <div class="dropdown-item"><i class="fas fa-question-circle"></i><span>Help Topics</span></div>
                    <div class="dropdown-item"><i class="fas fa-star"></i><span>What's New</span></div>
                    <div class="dropdown-item"><i class="fab fa-telegram"></i><span>MQL5 Telegram Channel</span></div>
                    <div class="dropdown-item"><i class="fas fa-video"></i><span>Video Guides</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-globe"></i><span>MQL5 Web Trader</span></div>
                    <div class="dropdown-item"><i class="fas fa-book"></i><span>MQL5 Documentation</span></div>
                    <div class="dropdown-item"><i class="fas fa-graduation-cap"></i><span>MQL5 AngloBook</span></div>
                    <div class="dropdown-item"><i class="fas fa-brain"></i><span>MQL5 NeuroBook</span></div>
                    <div class="dropdown-item"><i class="fas fa-newspaper"></i><span>MQL5 Articles</span></div>
                    <div class="dropdown-item"><i class="fas fa-code"></i><span>MQL5 Code Base</span></div>
                    <div class="dropdown-item"><i class="fas fa-briefcase"></i><span>MQL5 Jobs</span></div>
                    <div class="dropdown-item"><i class="fas fa-store"></i><span>MQL5 Markets</span></div>
                    <div class="dropdown-item"><i class="fas fa-signal"></i><span>MQL5 Signals</span></div>
                    <div class="dropdown-item"><i class="fas fa-quote-right"></i><span>MQL5 Quotes</span></div>
                    <div class="dropdown-item"><i class="fas fa-comments"></i><span>MQL5 Forum</span></div>
                    <div class="dropdown-item"><i class="fas fa-server"></i><span>MQL5 Virtual Hosting</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-calendar-alt"></i><span>Economic Calendar Mobile</span></div>
                    <div class="dropdown-item"><i class="fas fa-mobile-alt"></i><span>MQL5 Messenger Mobile</span></div>
                    <div class="dropdown-item"><i class="fas fa-mobile-alt"></i><span>MetaTrader 5 Mobile</span></div>
                    <div class="dropdown-item"><i class="fab fa-apple"></i><span>MetaTrader 5 for Mac</span></div>
                    <div class="dropdown-item"><i class="fab fa-linux"></i><span>MetaTrader 5 for Linux</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item"><i class="fas fa-sync"></i><span>Check for Updates</span></div>
                    <div class="dropdown-item"><i class="fas fa-info-circle"></i><span>About</span></div>
                </div>
            </div>
            
            <div style="flex: 1;"></div>
            
            <div class="nav-item">
                <span style="color: var(--mt5-accent-teal); font-weight: 600;">
                    <i class="fas fa-bolt"></i>
                    XNets FX AI Trading System v3.0
                </span>
            </div>
        </div>
        
        <!-- Toolbar with Shortcuts -->
        <div class="toolbar-shortcuts">
            <button class="shortcut-btn market-watch-toggle" id="marketWatchToggle">
                <i class="fas fa-eye"></i> Market Watch
            </button>
            <div style="width: 1px; background: var(--mt5-border); margin: 0 4px;"></div>
            <button class="shortcut-btn"><i class="fas fa-plus"></i> New</button>
            <button class="shortcut-btn"><i class="fas fa-folder-open"></i> Open</button>
            <button class="shortcut-btn"><i class="fas fa-save"></i> Save</button>
            <button class="shortcut-btn"><i class="fas fa-print"></i> Print</button>
            <div style="width: 1px; background: var(--mt5-border); margin: 0 4px;"></div>
            <button class="shortcut-btn"><i class="fas fa-undo"></i> Undo</button>
            <button class="shortcut-btn"><i class="fas fa-redo"></i> Redo</button>
            <div style="width: 1px; background: var(--mt5-border); margin: 0 4px;"></div>
            <button class="shortcut-btn"><i class="fas fa-chart-line"></i> Line</button>
            <button class="shortcut-btn active"><i class="fas fa-fire"></i> Candles</button>
            <button class="shortcut-btn"><i class="fas fa-chart-bar"></i> Bars</button>
            <div style="width: 1px; background: var(--mt5-border); margin: 0 4px;"></div>
            <button class="shortcut-btn"><i class="fas fa-search-plus"></i> Zoom In</button>
            <button class="shortcut-btn"><i class="fas fa-search-minus"></i> Zoom Out</button>
            <button class="shortcut-btn"><i class="fas fa-expand"></i> Fit</button>
            <div style="width: 1px; background: var(--mt5-border); margin: 0 4px;"></div>
            <button class="shortcut-btn"><i class="fas fa-m1">M1</i></button>
            <button class="shortcut-btn"><i class="fas fa-m5">M5</i></button>
            <button class="shortcut-btn"><i class="fas fa-m15">M15</i></button>
            <button class="shortcut-btn active"><i class="fas fa-h1">H1</i></button>
            <button class="shortcut-btn"><i class="fas fa-h4">H4</i></button>
            <button class="shortcut-btn"><i class="fas fa-d1">D1</i></button>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Market Watch Sidebar (left side, initially hidden) -->
            <div class="market-watch-sidebar" id="marketWatchSidebar">
                <div class="market-watch">
                    <div class="market-watch-header">
                        <span>Market Watch</span>
                        <i class="fas fa-cog" style="color: var(--mt5-text-secondary); font-size: 10px; cursor: pointer;"></i>
                    </div>
                    <div class="market-watch-content">
                        <div class="symbol-row active">
                            <div class="symbol-name">XAUUSDm</div>
                            <div class="symbol-bid">2025.46</div>
                            <div class="symbol-ask">2025.56</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">EURUSD</div>
                            <div class="symbol-bid">1.08032</div>
                            <div class="symbol-ask">1.08042</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">GBPUSD</div>
                            <div class="symbol-bid">1.24742</div>
                            <div class="symbol-ask">1.24752</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">USDJPY</div>
                            <div class="symbol-bid">148.420</div>
                            <div class="symbol-ask">148.421</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">USDCAD</div>
                            <div class="symbol-bid">1.41456</div>
                            <div class="symbol-ask">1.41466</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">AUDUSD</div>
                            <div class="symbol-bid">0.66129</div>
                            <div class="symbol-ask">0.66139</div>
                        </div>
                        <div class="symbol-row">
                            <div class="symbol-name">BTCUSD</div>
                            <div class="symbol-bid">42653.9</div>
                            <div class="symbol-ask">42663.9</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Left Sidebar - Navigator -->
            <div class="left-sidebar">
                <div class="navigator-header">
                    <span>Navigator</span>
                    <i class="fas fa-search" style="color: var(--mt5-text-secondary); font-size: 10px; cursor: pointer;"></i>
                </div>
                <div class="navigator-content">
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <span>Accounts</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="nav-item-list">
                            <div class="nav-subitem active">
                                <i class="fas fa-user-circle"></i>
                                <span>12345678</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-user-plus"></i>
                                <span>Open New Account</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <span>Indicators</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="nav-item-list">
                            <div class="nav-subitem">
                                <i class="fas fa-chart-line"></i>
                                <span>Trend</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-wave-square"></i>
                                <span>Oscillators</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-ruler"></i>
                                <span>Volumes</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-bullseye"></i>
                                <span>Bill Williams</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-star"></i>
                                <span>Custom</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <span>Expert Advisors</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="nav-item-list">
                            <div class="nav-subitem">
                                <i class="fas fa-robot"></i>
                                <span>FX AI Trading System</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-bolt"></i>
                                <span>Adaptive AI v2.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <span>Scripts</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="nav-item-list">
                            <div class="nav-subitem">
                                <i class="fas fa-code"></i>
                                <span>Trade Copier</span>
                            </div>
                            <div class="nav-subitem">
                                <i class="fas fa-calculator"></i>
                                <span>Position Calculator</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workspace -->
            <div class="workspace">
                <!-- Chart Area -->
                <div class="chart-tabs-area">
                    <div class="chart-tabs-header">
                        <div class="chart-tab active">
                            <i class="fas fa-chart-line"></i>
                            XAUUSDm,M30
                            <span class="chart-tab-close">&times;</span>
                        </div>
                        <div class="chart-tab">
                            <i class="fas fa-chart-line"></i>
                            EURUSD,H1
                            <span class="chart-tab-close">&times;</span>
                        </div>
                        <div class="add-chart-tab">
                            <i class="fas fa-plus"></i>
                            Add
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="symbol-info">
                                <div class="symbol-price">2025.46</div>
                                <div class="price-change positive">+0.10%</div>
                                <div class="price-info">
                                    Bid: <span class="price-bid">2025.46</span> | 
                                    Ask: <span class="price-ask">2025.56</span> | 
                                    Spread: <span>1.0</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="shortcut-btn"><i class="fas fa-plus"></i></button>
                                <button class="shortcut-btn"><i class="fas fa-minus"></i></button>
                                <button class="shortcut-btn"><i class="fas fa-arrows-alt-h"></i></button>
                                <button class="shortcut-btn"><i class="fas fa-crosshairs"></i></button>
                            </div>
                        </div>
                        <div style="height: calc(100% - 40px); display: flex; align-items: center; justify-content: center; color: var(--mt5-text-secondary);">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px; color: var(--mt5-accent-teal);"></i>
                                <div style="font-size: 18px; margin-bottom: 8px; font-weight: 600;">XAUUSDm (Gold) Chart</div>
                                <div style="font-size: 12px; max-width: 400px; line-height: 1.5;">
                                    Real-time chart with candlestick patterns, technical indicators, and AI trading signals
                                </div>
                                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                                    <div style="padding: 10px; background: rgba(0, 180, 160, 0.1); border-radius: 4px; border-left: 3px solid var(--mt5-accent-teal);">
                                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">AI SIGNAL</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--mt5-accent-teal);">NEUTRAL â€¢ 46%</div>
                                    </div>
                                    <div style="padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 4px; border-left: 3px solid var(--mt5-accent-yellow);">
                                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">MARKET REGIME</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--mt5-accent-yellow);">RANGING â€¢ 85%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Panel Container -->
                <div class="bottom-panel-container" id="bottomPanel">
                    <!-- Bottom Panel Tabs -->
                    <div class="bottom-panel-tabs">
                        <div class="panel-tab active" data-panel="trade">
                            <i class="fas fa-exchange-alt"></i>
                            Trade
                        </div>
                        <div class="panel-tab" data-panel="exposure">
                            <i class="fas fa-chart-pie"></i>
                            Exposure
                        </div>
                        <div class="panel-tab" data-panel="history">
                            <i class="fas fa-history"></i>
                            History
                        </div>
                        <div class="panel-tab" data-panel="news">
                            <i class="fas fa-newspaper"></i>
                            News
                        </div>
                        <div class="panel-tab" data-panel="mailbox">
                            <i class="fas fa-envelope"></i>
                            Mailbox
                        </div>
                        <div class="panel-tab" data-panel="calendar">
                            <i class="fas fa-calendar-alt"></i>
                            Calendar
                        </div>
                        <div class="panel-tab" data-panel="company">
                            <i class="fas fa-building"></i>
                            Company
                        </div>
                        <div class="panel-tab" data-panel="alerts">
                            <i class="fas fa-bell"></i>
                            Alerts
                        </div>
                        <div class="panel-tab" data-panel="articles">
                            <i class="fas fa-newspaper"></i>
                            Articles
                        </div>
                        <div class="panel-tab" data-panel="codebase">
                            <i class="fas fa-code"></i>
                            Code Base
                        </div>
                        <div class="panel-tab" data-panel="experts">
                            <i class="fas fa-robot"></i>
                            Experts
                        </div>
                        <div class="panel-tab" data-panel="journal">
                            <i class="fas fa-book"></i>
                            Journal
                        </div>
                        <div class="panel-tab" data-panel="strategies">
                            <i class="fas fa-chess-knight"></i>
                            Strategies
                        </div>

                        <div style="flex: 1;"></div>
                        <div style="display: flex; align-items: center; gap: 8px; padding-right: 12px;">
                            <i class="fas fa-store" style="color: var(--mt5-text-secondary); cursor: pointer;" title="Market"></i>
                            <i class="fas fa-signal" style="color: var(--mt5-text-secondary); cursor: pointer;" title="Signals"></i>
                            <i class="fas fa-server" style="color: var(--mt5-text-secondary); cursor: pointer;" title="VPS"></i>
                            <i class="fas fa-flask" style="color: var(--mt5-text-secondary); cursor: pointer;" title="Tester"></i>
                        </div>
                    </div>
                
                    <!-- Panel Content Container -->
                    <div class="panel-content-container">
                        <!-- Trade Panel -->
                        <div class="panel-content active" id="tradePanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Trade</div>
                                    <div class="panel-actions">
                                        <span style="color: var(--mt5-accent-yellow); font-size: 11px; font-weight: 700;">AI LOCKED</span>
                                    </div>
                                </div>
                                
                                <div class="order-form">
                                    <div class="order-row">
                                        <span class="order-label">Symbol</span>
                                        <span class="order-value">XAUUSDm</span>
                                    </div>
                                    <div class="order-row">
                                        <span class="order-label">Volume</span>
                                        <span class="order-value">0.10</span>
                                    </div>
                                    <div class="order-row">
                                        <span class="order-label">Stop Loss</span>
                                        <span class="order-value">2015.00</span>
                                    </div>
                                    <div class="order-row">
                                        <span class="order-label">Take Profit</span>
                                        <span class="order-value">2040.00</span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-buy">BUY</button>
                                        <button class="btn btn-sell">SELL</button>
                                    </div>
                                    <div class="account-summary">
                                        <div class="summary-row">
                                            <span class="summary-label">Balance</span>
                                            <span class="summary-value">$10,000.00</span>
                                        </div>
                                        <div class="summary-row">
                                            <span class="summary-label">Equity</span>
                                            <span class="summary-value">$10,007.70</span>
                                        </div>
                                        <div class="summary-row">
                                            <span class="summary-label">Free Margin</span>
                                            <span class="summary-value">$10,007.70</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Exposure Panel -->
                        <div class="panel-content" id="exposurePanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Portfolio Exposure</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Refresh</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Risk Exposure</div>
                                    <div class="alert-card alert-info">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-size: 12px; font-weight: 600;">Overall Risk Level</div>
                                            <div style="font-size: 14px; font-weight: 700; color: var(--mt5-accent-green);">42% (Low)</div>
                                        </div>
                                        <div style="height: 6px; background: var(--mt5-border); border-radius: 3px; overflow: hidden;">
                                            <div style="width: 42%; height: 100%; background: linear-gradient(90deg, var(--mt5-accent-green), var(--mt5-accent-yellow));"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Instrument Exposure</div>
                                    <div class="scrollable-area">
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>XAUUSD</span>
                                                <span style="color: var(--mt5-accent-yellow); font-weight: 600;">32%</span>
                                            </div>
                                        </div>
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>EURUSD</span>
                                                <span style="color: var(--mt5-accent-green); font-weight: 600;">18%</span>
                                            </div>
                                        </div>
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>GBPUSD</span>
                                                <span style="color: var(--mt5-accent-green); font-weight: 600;">12%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Margin Information</div>
                                    <div class="data-grid-2">
                                        <div class="info-card">
                                            <div class="info-value">$4,200.00</div>
                                            <div class="info-label">Margin Used</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value">$5,807.70</div>
                                            <div class="info-label">Free Margin</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert-card alert-info">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                        <i class="fas fa-robot" style="color: var(--mt5-accent-teal);"></i>
                                        <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal);">AI RISK ASSESSMENT</div>
                                    </div>
                                    <div style="font-size: 11px; line-height: 1.4;">
                                        Portfolio risk level: <strong style="color: var(--mt5-accent-green);">LOW</strong>. 
                                        Current exposure is within safe limits.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- History Panel -->
                        <div class="panel-content" id="historyPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Trade History</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Today</button>
                                        <button class="panel-btn-small">Week</button>
                                        <button class="panel-btn-small active">Month</button>
                                        <button class="panel-btn-small">All</button>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Symbol</th>
                                                <th>Type</th>
                                                <th>Volume</th>
                                                <th>Price</th>
                                                <th>S/L</th>
                                                <th>T/P</th>
                                                <th>P/L</th>
                                                <th>Commission</th>
                                                <th>Swap</th>
                                                <th>Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>15:32:31</td>
                                                <td>EURUSD</td>
                                                <td class="trade-buy">buy</td>
                                                <td class="history-number">0.10</td>
                                                <td class="history-number">1.08096</td>
                                                <td class="history-number">1.07500</td>
                                                <td class="history-number">1.09000</td>
                                                <td class="pl-positive">+5.20</td>
                                                <td class="history-number">-0.50</td>
                                                <td class="history-number">0.00</td>
                                                <td class="pl-positive">+4.70</td>
                                            </tr>
                                            <tr>
                                                <td>15:32:28</td>
                                                <td>EURUSD</td>
                                                <td class="trade-sell">sell</td>
                                                <td class="history-number">0.10</td>
                                                <td class="history-number">1.08083</td>
                                                <td class="history-number">1.08500</td>
                                                <td class="history-number">1.07000</td>
                                                <td class="pl-negative">-3.10</td>
                                                <td class="history-number">-0.50</td>
                                                <td class="history-number">0.00</td>
                                                <td class="pl-negative">-3.60</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Summary</div>
                                    <div class="data-grid-2">
                                        <div class="info-card">
                                            <div class="info-value">4</div>
                                            <div class="info-label">Total Trades</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-green);">+$13.55</div>
                                            <div class="info-label">Net Profit</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- News Panel -->
                        <div class="panel-content" id="newsPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Market News</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">All</button>
                                        <button class="panel-btn-small active">Forex</button>
                                        <button class="panel-btn-small">Gold</button>
                                        <button class="panel-btn-small">Stocks</button>
                                    </div>
                                </div>
                                
                                <div class="scrollable-area">
                                    <div class="alert-card alert-danger">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">Fed Rate Decision</div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">15:30 â€¢ Today</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                            Federal Reserve maintains interest rates at 5.25%-5.50%.
                                        </div>
                                        <div style="font-size: 10px; color: var(--mt5-accent-red); font-weight: 600;">IMPACT: HIGH â€¢ USD PAIRS</div>
                                    </div>
                                    
                                    <div class="alert-card alert-warning">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">Gold Hits 2-Month High</div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">14:15 â€¢ Today</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                            Gold prices surge to $2025 as geopolitical tensions rise.
                                        </div>
                                        <div style="font-size: 10px; color: var(--mt5-accent-yellow); font-weight: 600;">IMPACT: MEDIUM â€¢ XAUUSD</div>
                                    </div>
                                </div>
                                
                                <div class="alert-card alert-info">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                        <i class="fas fa-robot" style="color: var(--mt5-accent-teal);"></i>
                                        <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal);">AI NEWS ANALYSIS</div>
                                    </div>
                                    <div style="font-size: 11px; line-height: 1.4;">
                                        <strong>Market Sentiment:</strong> Risk-off due to Fed announcement.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mailbox Panel -->
                        <div class="panel-content" id="mailboxPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Mailbox</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small"><i class="fas fa-redo"></i></button>
                                        <button class="panel-btn-small"><i class="fas fa-pen"></i></button>
                                        <button class="panel-btn-small"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                
                                <div class="scrollable-area">
                                    <div class="alert-card alert-info">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                Account Statement
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Today â€¢ 09:30</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4;">
                                            Your monthly account statement is ready.
                                        </div>
                                    </div>
                                    
                                    <div class="alert-card">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                Platform Maintenance
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Yesterday â€¢ 18:45</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4;">
                                            Scheduled maintenance on February 5.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Status</div>
                                    <div class="data-grid-2">
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-blue);">1</div>
                                            <div class="info-label">Unread</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value">4</div>
                                            <div class="info-label">Total</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calendar Panel -->
                        <div class="panel-content" id="calendarPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Economic Calendar</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Today</button>
                                        <button class="panel-btn-small active">Week</button>
                                        <button class="panel-btn-small">Month</button>
                                    </div>
                                </div>
                                
                                <div class="scrollable-area">
                                    <div class="alert-card alert-danger">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                US Non-Farm Payrolls
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-accent-red); font-weight: 600;">15:30 TODAY</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 6px;">
                                            Forecast: 180K, Previous: 216K
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="font-size: 10px; padding: 2px 6px; background: var(--mt5-accent-red); color: white; border-radius: 2px; font-weight: 600;">HIGH</div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Impact: USD, Gold</div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-card alert-warning">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                Eurozone CPI
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-accent-yellow); font-weight: 600;">10:00 TODAY</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 6px;">
                                            Forecast: 2.4%, Previous: 2.9%
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="font-size: 10px; padding: 2px 6px; background: var(--mt5-accent-yellow); color: black; border-radius: 2px; font-weight: 600;">MEDIUM</div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Impact: EUR Pairs</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert-card alert-info">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                        <i class="fas fa-robot" style="color: var(--mt5-accent-teal);"></i>
                                        <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal);">AI CALENDAR ANALYSIS</div>
                                    </div>
                                    <div style="font-size: 11px; line-height: 1.4;">
                                        <strong>Today's Focus:</strong> NFP data expected to cause USD volatility.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Company Panel -->
                        <div class="panel-content" id="companyPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">XNets Technologies</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Website</button>
                                        <button class="panel-btn-small">Contact</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">About Us</div>
                                    <div class="alert-card">
                                        <div style="font-size: 11px; color: var(--mt5-text-primary); line-height: 1.5;">
                                            XNets Technologies is a leading financial technology provider specializing in AI-driven trading solutions since 2010.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Regulation</div>
                                    <div class="data-grid-2">
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-green);">FCA</div>
                                            <div class="info-label">UK Regulation</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-green);">CySEC</div>
                                            <div class="info-label">EU Regulation</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert-card alert-warning">
                                    <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-yellow); margin-bottom: 6px;">
                                        <i class="fas fa-exclamation-circle"></i> IMPORTANT NOTICE
                                    </div>
                                    <div style="font-size: 11px; color: var(--mt5-text-primary); line-height: 1.4;">
                                        Trading involves risk. Past performance is not indicative of future results.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerts Panel -->
                        <div class="panel-content" id="alertsPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Alerts</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small"><i class="fas fa-plus"></i> New</button>
                                        <button class="panel-btn-small"><i class="fas fa-trash"></i> Clear</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Active Alerts (3)</div>
                                    <div class="scrollable-area">
                                        <div class="alert-card alert-success">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    EURUSD Buy Signal
                                                </div>
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Active</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 6px;">
                                                Trigger: Price > 1.08500 â€¢ Timeframe: H1
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card alert-warning">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    Gold Oversold
                                                </div>
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Active</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 6px;">
                                                Trigger: RSI(14) < 30 â€¢ Timeframe: D1
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Create New Alert</div>
                                    <div style="display: grid; gap: 8px;">
                                        <select class="form-control-small">
                                            <option>Select Symbol</option>
                                            <option>XAUUSD</option>
                                            <option>EURUSD</option>
                                        </select>
                                        <select class="form-control-small">
                                            <option>Condition</option>
                                            <option>Price Above</option>
                                            <option>Price Below</option>
                                        </select>
                                        <input type="text" class="form-control-small" placeholder="Value">
                                        <button class="panel-btn-small" style="background: var(--mt5-accent-teal); color: white;">Create Alert</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Articles Panel -->
                        <div class="panel-content" id="articlesPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">MQL5 Articles</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Latest</button>
                                        <button class="panel-btn-small active">Popular</button>
                                        <button class="panel-btn-small">AI Trading</button>
                                    </div>
                                </div>
                                
                                <div class="scrollable-area">
                                    <div class="alert-card">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-size: 13px; font-weight: 600; color: var(--mt5-accent-teal);">
                                                Neural Networks for Forex
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Feb 2, 2024</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                            Learn how to implement LSTM networks for time series forecasting.
                                        </div>
                                    </div>
                                    
                                    <div class="alert-card">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-size: 13px; font-weight: 600; color: var(--mt5-accent-teal);">
                                                Risk Management
                                            </div>
                                            <div style="font-size: 10px; color: var(--mt5-text-secondary);">Jan 28, 2024</div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                            Implement Monte Carlo methods to optimize position sizing.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert-card alert-info">
                                    <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal); margin-bottom: 6px;">
                                        <i class="fas fa-star"></i> FEATURED ARTICLE
                                    </div>
                                    <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary); margin-bottom: 6px;">
                                        FX AI Trading System v3.0 Guide
                                    </div>
                                    <button class="panel-btn-small" style="width: 100%;">
                                        <i class="fas fa-book-open"></i> Read Full Article
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Code Base Panel -->
                        <div class="panel-content" id="codebasePanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">MQL5 Code Base</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Search</button>
                                        <button class="panel-btn-small active">EAs</button>
                                        <button class="panel-btn-small">Indicators</button>
                                        <button class="panel-btn-small">Scripts</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Popular Code Examples</div>
                                    <div class="scrollable-area">
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    Adaptive Moving Average EA
                                                </div>
                                                <div style="font-size: 10px; color: var(--mt5-accent-green); font-weight: 600;">4.8 â˜…</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                                Self-adjusting moving average crossover system.
                                            </div>
                                            <button class="panel-btn-small">Download</button>
                                        </div>
                                        
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    Neural Network Indicator
                                                </div>
                                                <div style="font-size: 10px; color: var(--mt5-accent-green); font-weight: 600;">4.6 â˜…</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary); line-height: 1.4; margin-bottom: 8px;">
                                                ML-based indicator for pattern recognition.
                                            </div>
                                            <button class="panel-btn-small">Download</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Your Projects (2)</div>
                                    <div class="data-grid-2">
                                        <div class="info-card" style="background: rgba(0, 180, 160, 0.1);">
                                            <div class="info-value" style="color: var(--mt5-accent-teal);">FX AI v3.0</div>
                                            <div class="info-label">Private</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value">Risk Toolkit</div>
                                            <div class="info-label">Public</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Experts Panel -->
                        <div class="panel-content" id="expertsPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Expert Advisors</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small"><i class="fas fa-plus"></i> New</button>
                                        <button class="panel-btn-small"><i class="fas fa-upload"></i> Import</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Running EAs (3)</div>
                                    <div class="scrollable-area">
                                        <div class="alert-card alert-success">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                        FX AI Trading System v3.0
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 2px;">
                                                        Running on: XAUUSDm (M30)
                                                    </div>
                                                </div>
                                                <div style="font-size: 10px; padding: 2px 6px; background: var(--mt5-accent-green); color: white; border-radius: 2px; font-weight: 600;">
                                                    ACTIVE
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 4px;">
                                                <button class="panel-btn-small">Settings</button>
                                                <button class="panel-btn-small" style="color: var(--mt5-accent-red);">Stop</button>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                        Adaptive AI v2.0
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 2px;">
                                                        Running on: EURUSD (H1)
                                                    </div>
                                                </div>
                                                <div style="font-size: 10px; padding: 2px 6px; background: var(--mt5-accent-yellow); color: black; border-radius: 2px; font-weight: 600;">
                                                    PAUSED
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 4px;">
                                                <button class="panel-btn-small">Settings</button>
                                                <button class="panel-btn-small" style="background: var(--mt5-accent-teal); color: white;">Start</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Performance Summary</div>
                                    <div class="data-grid-4">
                                        <div class="info-card">
                                            <div class="info-value">42</div>
                                            <div class="info-label">Total Trades</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-green);">68.4%</div>
                                            <div class="info-label">Win Rate</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-green);">2.14</div>
                                            <div class="info-label">Profit Factor</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value" style="color: var(--mt5-accent-yellow);">8.2%</div>
                                            <div class="info-label">Max DD</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Journal Panel -->
                        <div class="panel-content" id="journalPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Journal</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small">Clear</button>
                                        <button class="panel-btn-small">Export</button>
                                        <button class="panel-btn-small">Save</button>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Log Entries</div>
                                    <div class="scrollable-area" style="max-height: 250px;">
                                        <div class="alert-card alert-success">
                                            <div style="display: flex; align-items: start; gap: 8px;">
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary); min-width: 40px;">15:42:31</div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 11px; color: var(--mt5-text-primary);">
                                                        Trade executed: BUY 0.10 XAUUSDm @ 2025.46
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 2px;">
                                                        Ticket: 12345678 â€¢ SL: 2015.00 â€¢ TP: 2040.00
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card alert-info">
                                            <div style="display: flex; align-items: start; gap: 8px;">
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary); min-width: 40px;">15:40:12</div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 11px; color: var(--mt5-text-primary);">
                                                        FX AI System: Market regime updated to RANGING
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 2px;">
                                                        Adaptive threshold adjusted to 65%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card alert-warning">
                                            <div style="display: flex; align-items: start; gap: 8px;">
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary); min-width: 40px;">15:38:05</div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 11px; color: var(--mt5-text-primary);">
                                                        AI confidence below threshold: 46% < 65%
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 2px;">
                                                        Trade locking activated.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="content-section">
                                    <div class="section-title">Statistics</div>
                                    <div class="data-grid-2">
                                        <div class="info-card">
                                            <div class="info-value">6</div>
                                            <div class="info-label">Entries Shown</div>
                                        </div>
                                        <div class="info-card">
                                            <div class="info-value">142</div>
                                            <div class="info-label">Total Entries</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Strategies Panel -->
                        <div class="panel-content" id="strategiesPanel">
                            <div class="panel-inner">
                                <div class="panel-header">
                                    <div class="panel-title">Trading Strategies</div>
                                    <div class="panel-actions">
                                        <button class="panel-btn-small" id="refreshStrategies"><i class="fas fa-sync"></i></button>
                                        <button class="panel-btn-small" id="runBacktest"><i class="fas fa-chart-line"></i> Backtest</button>
                                        <button class="panel-btn-small" id="scanPatterns"><i class="fas fa-search"></i> Scan</button>
                                    </div>
                                </div>
                                
                                <!-- Strategy Selection -->
                                <div class="content-section">
                                    <div class="section-title">Active Strategy</div>
                                    <div class="data-grid-2">
                                        <div class="info-card active-strategy" style="background: rgba(0, 180, 160, 0.1); cursor: pointer;" data-strategy="ibrahim">
                                            <div class="info-value" style="color: var(--mt5-accent-teal);">Ibrahim Abu</div>
                                            <div class="info-label">Manual Forex Strategy</div>
                                        </div>
                                        <div class="info-card" style="cursor: pointer;" data-strategy="marketdna">
                                            <div class="info-value">Market DNA</div>
                                            <div class="info-label">AI Pattern Bot</div>
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- Ibrahim Abu Strategy Checklist -->
                                <div class="content-section" id="ibrahimStrategy" style="display: block;">
                                    <div class="section-title">Ibrahim Abu - Simple Trading Strategy</div>
                                    <div class="scrollable-area" style="max-height: 300px;">
                                        <div class="alert-card" style="margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    <i class="fas fa-newspaper" style="color: var(--mt5-accent-teal); margin-right: 6px;"></i>
                                                    1. Check Fundamentals
                                                </div>
                                                <div class="checkmark" style="color: var(--mt5-accent-green); font-size: 12px;">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                <button class="panel-btn-small" style="margin-top: 4px; font-size: 9px;" onclick="window.openNews()">
                                                    <i class="fas fa-external-link-alt"></i> Open News
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card" style="margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    <i class="fas fa-chart-line" style="color: var(--mt5-accent-teal); margin-right: 6px;"></i>
                                                    2. Identify Trend (4H)
                                                </div>
                                                <div class="checkmark" style="color: var(--mt5-accent-green); font-size: 12px;">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                <select class="form-control-small" id="trendDirection" style="margin-top: 4px;">
                                                    <option value="uptrend">ðŸ“ˆ Uptrend</option>
                                                    <option value="downtrend">ðŸ“‰ Downtrend</option>
                                                    <option value="ranging">âž¡ï¸ Ranging</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card" style="margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    <i class="fas fa-search" style="color: var(--mt5-accent-teal); margin-right: 6px;"></i>
                                                    3. Break of Structure (Lower TF)
                                                </div>
                                                <div class="checkmark" style="color: var(--mt5-accent-green); font-size: 12px; display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                <div style="display: flex; gap: 8px; margin-top: 4px;">
                                                    <button class="panel-btn-small" onclick="detectBOS()" style="font-size: 9px;">
                                                        <i class="fas fa-bolt"></i> Detect BOS
                                                    </button>
                                                    <select class="form-control-small" style="flex: 1;">
                                                        <option>M30</option>
                                                        <option>H1</option>
                                                        <option>M15</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card" style="margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    <i class="fas fa-bullseye" style="color: var(--mt5-accent-teal); margin-right: 6px;"></i>
                                                    4. Area of Interest
                                                </div>
                                                <div class="checkmark" style="color: var(--mt5-accent-yellow); font-size: 12px;">
                                                    <i class="fas fa-hourglass-half"></i>
                                                </div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                <input type="text" class="form-control-small" placeholder="AOI Price Level" style="margin-top: 4px;">
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card" style="margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                    <i class="fas fa-star" style="color: var(--mt5-accent-teal); margin-right: 6px;"></i>
                                                    5. Candle Confirmation
                                                </div>
                                                <div class="checkmark" style="color: var(--mt5-accent-red); font-size: 12px;">
                                                    <i class="fas fa-times-circle"></i>
                                                </div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                <select class="form-control-small" style="margin-top: 4px;">
                                                    <option>Select Pattern</option>
                                                    <option>Bullish Engulfing</option>
                                                    <option>Bearish Engulfing</option>
                                                    <option>Morning Star</option>
                                                    <option>Evening Star</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="alert-card alert-info">
                                            <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal); margin-bottom: 6px;">
                                                <i class="fas fa-robot"></i> STRATEGY STATUS
                                            </div>
                                            <div style="font-size: 11px; color: var(--mt5-text-primary);">
                                                <strong>Current Step:</strong> Step 3 - Break of Structure Detection<br>
                                                <strong>Confidence:</strong> 65% â€¢ <strong>Signal:</strong> NEUTRAL
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 12px;">
                                        <button class="panel-btn-small" style="background: var(--mt5-accent-teal); color: white; width: 100%;">
                                            <i class="fas fa-play"></i> Execute Trade When Ready
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Market DNA Strategy Interface -->
                                <div class="content-section" id="marketDNAStrategy" style="display: none;">
                                    <div class="section-title">Market DNA Trading Bot</div>
                                    
                                    <div class="alert-card alert-success">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">
                                                <i class="fas fa-brain"></i> AI Pattern Detection
                                            </div>
                                            <div style="font-size: 10px; padding: 2px 6px; background: var(--mt5-accent-green); color: white; border-radius: 2px; font-weight: 600;">
                                                ACTIVE
                                            </div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                            Detecting Classical, Harmonic & Elliott patterns in real-time
                                        </div>
                                    </div>
                                    
                                    <div class="content-section">
                                        <div class="section-title">Live Pattern Detections</div>
                                        <div class="scrollable-area" style="max-height: 200px;" id="patternDetections">
                                            <div class="alert-card">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                    <div>
                                                        <div style="font-size: 12px; font-weight: 600; color: var(--mt5-accent-teal);">
                                                            Double Bottom â€¢ XAUUSD
                                                        </div>
                                                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">
                                                            4H â€¢ Confidence: 78%
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-accent-green); font-weight: 600;">
                                                        BULLISH
                                                    </div>
                                                </div>
                                                <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                    Entry: 2025.50 â€¢ SL: 2015.00 â€¢ TP1: 2035.50 â€¢ TP2: 2045.50
                                                </div>
                                                <button class="panel-btn-small" style="margin-top: 6px; font-size: 9px; width: 100%;">
                                                    <i class="fas fa-chart-line"></i> Plot on Chart
                                                </button>
                                            </div>
                                            
                                            <div class="alert-card">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                    <div>
                                                        <div style="font-size: 12px; font-weight: 600; color: var(--mt5-accent-teal);">
                                                            AB=CD â€¢ BTCUSD
                                                        </div>
                                                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">
                                                            1H â€¢ Confidence: 65%
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 10px; color: var(--mt5-accent-red); font-weight: 600;">
                                                        BEARISH
                                                    </div>
                                                </div>
                                                <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                                    Entry: 42500 â€¢ SL: 42800 â€¢ TP1: 42200 â€¢ TP2: 41900
                                                </div>
                                                <button class="panel-btn-small" style="margin-top: 6px; font-size: 9px; width: 100%;">
                                                    <i class="fas fa-chart-line"></i> Plot on Chart
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="content-section">
                                        <div class="section-title">Pattern Statistics</div>
                                        <div class="data-grid-4">
                                            <div class="info-card">
                                                <div class="info-value">42</div>
                                                <div class="info-label">Detected</div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-value" style="color: var(--mt5-accent-green);">68%</div>
                                                <div class="info-label">Win Rate</div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-value" style="color: var(--mt5-accent-green);">2.3</div>
                                                <div class="info-label">Avg R:R</div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-value" style="color: var(--mt5-accent-yellow);">7.8%</div>
                                                <div class="info-label">Max DD</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-card alert-warning">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-yellow); margin-bottom: 6px;">
                                            <i class="fas fa-cog"></i> BOT SETTINGS
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Risk/Trade</div>
                                                <div style="font-size: 11px; font-weight: 600;">0.5%</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Max Trades</div>
                                                <div style="font-size: 11px; font-weight: 600;">4</div>
                                            </div>
                                        </div>
                                        <button class="panel-btn-small" style="margin-top: 8px; width: 100%;">
                                            <i class="fas fa-sliders-h"></i> Configure Bot
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Strategy Backtesting Interface -->
                                <div class="content-section">
                                    <div class="section-title">Quick Backtest</div>
                                    <div style="display: grid; gap: 8px;">
                                        <select class="form-control-small">
                                            <option>Select Strategy</option>
                                            <option>Ibrahim Abu (Manual)</option>
                                            <option>Market DNA (Classical)</option>
                                            <option>Market DNA (Harmonic)</option>
                                            <option>Market DNA (Elliott)</option>
                                        </select>
                                        <select class="form-control-small">
                                            <option>XAUUSD</option>
                                            <option>BTCUSD</option>
                                            <option>EURUSD</option>
                                        </select>
                                        <select class="form-control-small">
                                            <option>Last 30 Days</option>
                                            <option>Last 90 Days</option>
                                            <option>Last 6 Months</option>
                                            <option>Last Year</option>
                                        </select>
                                        <button class="panel-btn-small" style="background: var(--mt5-accent-teal); color: white;">
                                            <i class="fas fa-chart-bar"></i> Run Backtest
                                        </button>
                                    </div>
                                    
                                    <div class="alert-card alert-info" style="margin-top: 12px;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--mt5-accent-teal); margin-bottom: 6px;">
                                            <i class="fas fa-lightbulb"></i> STRATEGY INSIGHTS
                                        </div>
                                        <div style="font-size: 11px; color: var(--mt5-text-primary);">
                                            <strong>Market DNA Bot:</strong> Best performance in trending markets with composite score >0.68<br>
                                            <strong>Ibrahim Abu:</strong> Most effective on XAUUSD M30-H4 confluence
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <div class="connection-dot"></div>
                <span>Connected to XNets Broker Server â€¢ Last quote: 02:45:17</span>
            </div>
            <div>
                <span>FX AI Trading System v3.0 â€¢ RANGING â€¢ AI Confidence: 46% â€¢ Threshold: 65%</span>
            </div>
            <div>
                <span>Zoom: 100% â€¢ X: 0.00 â€¢ Y: 0.00</span>
            </div>
        </div>
        
        <!-- Overlay for Modals -->
        <div class="overlay" id="modalOverlay"></div>
        
        <!-- New Order Modal -->
        <div class="modal" id="newOrderModal">
            <div class="modal-header">
                <span>New Order - XAUUSDm</span>
                <span class="modal-close" id="closeNewOrder">&times;</span>
            </div>
            <div class="modal-content">
                <div class="new-order-form">
                    <div class="form-group">
                        <span class="form-label">Symbol:</span>
                        <select class="form-control">
                            <option>XAUUSDm</option>
                            <option>EURUSD</option>
                            <option>GBPUSD</option>
                            <option>USDJPY</option>
                            <option>USDCAD</option>
                            <option>AUDUSD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <span class="form-label">Type:</span>
                        <select class="form-control">
                            <option>Market Execution</option>
                            <option>Pending Order</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <span class="form-label">Volume:</span>
                        <div style="display: flex; gap: 4px;">
                            <button class="shortcut-btn" style="padding: 4px 8px;">-</button>
                            <input type="text" class="form-control" value="0.10" style="text-align: center;">
                            <button class="shortcut-btn" style="padding: 4px 8px;">+</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <span class="form-label">Stop Loss:</span>
                            <div style="display: flex; gap: 4px;">
                                <button class="shortcut-btn" style="padding: 4px 8px;">-</button>
                                <input type="text" class="form-control" value="2015.00" style="text-align: center;">
                                <button class="shortcut-btn" style="padding: 4px 8px;">+</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <span class="form-label">Take Profit:</span>
                            <div style="display: flex; gap: 4px;">
                                <button class="shortcut-btn" style="padding: 4px 8px;">-</button>
                                <input type="text" class="form-control" value="2040.00" style="text-align: center;">
                                <button class="shortcut-btn" style="padding: 4px 8px;">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <span class="form-label">Fill policy:</span>
                        <select class="form-control">
                            <option>Fill or Kill</option>
                            <option>Immediate or Cancel</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <span class="form-label">Comment:</span>
                        <input type="text" class="form-control" placeholder="Optional comment">
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <div style="flex: 1; padding: 12px; background: var(--mt5-bg-tertiary); border-radius: 4px; border: 1px solid var(--mt5-border);">
                            <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 4px;">Trading Signals</div>
                            <div style="font-size: 10px; color: var(--mt5-text-primary);">
                                <div>AI Signal: <span style="color: var(--mt5-accent-teal);">NEUTRAL</span></div>
                                <div>Confidence: <span style="color: var(--mt5-accent-red);">46%</span></div>
                                <div>Market: <span style="color: var(--mt5-accent-yellow);">RANGING</span></div>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; font-family: 'Courier New';">2025.46</div>
                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">Bid/Ask: 2025.46/2025.56</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                        <button class="btn btn-buy" style="padding: 12px;">Buy</button>
                        <button class="btn btn-sell" style="padding: 12px;">Sell</button>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(60, 77, 96, 0.3); border-radius: 4px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <div>
                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Balance</div>
                                <div style="font-weight: 600; font-family: 'Courier New';">$10,000.00</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Equity</div>
                                <div style="font-weight: 600; font-family: 'Courier New';">$10,007.70</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">Free Margin</div>
                                <div style="font-weight: 600; font-family: 'Courier New';">$10,007.70</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // XNets FX AI Trading System - Complete MT5 Clone
        class XNetsTradingPlatform {
            constructor() {
                this.panelHeight = 250;
                this.minPanelHeight = 150;
                this.maxPanelHeight = 400;
                this.isResizing = false;
                this.marketWatchVisible = false;
                this.init();
            }
            
            init() {
                this.setupDropdowns();
                this.setupNewOrderModal();
                this.setupBottomPanels();
                this.setupMarketWatch();
                this.updateStatusBar();
                this.setupChartTabs();
                this.setupStrategyPanel();
                this.setupPanelResize();
                this.setupMarketWatchToggle();
            }
            
            setupDropdowns() {
                // File menu dropdown
                const fileMenu = document.getElementById('fileMenu');
                const fileDropdown = document.getElementById('fileDropdown');
                
                fileMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fileDropdown.classList.toggle('show');
                });
                
                // Close dropdowns when clicking elsewhere
                document.addEventListener('click', () => {
                    document.querySelectorAll('.dropdown-menu.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                });
                
                // Prevent dropdowns from closing when clicking inside them
                document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
                    dropdown.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
                
                // Setup nested dropdowns
                document.querySelectorAll('.has-dropdown').forEach(item => {
                    item.addEventListener('mouseenter', (e) => {
                        const dropdown = item.querySelector('.dropdown-menu');
                        if (dropdown) {
                            dropdown.classList.add('show');
                        }
                    });
                    
                    item.addEventListener('mouseleave', (e) => {
                        const dropdown = item.querySelector('.dropdown-menu');
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    });
                });
            }
            
            setupNewOrderModal() {
                const newOrderBtn = document.getElementById('newOrderBtn');
                const newOrderModal = document.getElementById('newOrderModal');
                const modalOverlay = document.getElementById('modalOverlay');
                const closeNewOrder = document.getElementById('closeNewOrder');
                
                if (newOrderBtn) {
                    newOrderBtn.addEventListener('click', () => {
                        newOrderModal.classList.add('show');
                        modalOverlay.classList.add('show');
                    });
                }
                
                if (closeNewOrder) {
                    closeNewOrder.addEventListener('click', () => {
                        newOrderModal.classList.remove('show');
                        modalOverlay.classList.remove('show');
                    });
                }
                
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', () => {
                        newOrderModal.classList.remove('show');
                        modalOverlay.classList.remove('show');
                    });
                }
                
                // Setup volume controls
                document.querySelectorAll('.form-group').forEach(group => {
                    const minusBtn = group.querySelector('.shortcut-btn:nth-child(1)');
                    const plusBtn = group.querySelector('.shortcut-btn:nth-child(3)');
                    const input = group.querySelector('input[type="text"]');
                    
                    if (minusBtn && plusBtn && input) {
                        minusBtn.addEventListener('click', () => {
                            const value = parseFloat(input.value) || 0;
                            const step = input.parentElement.querySelector('.form-label').textContent.includes('Volume') ? 0.01 : 0.1;
                            input.value = (value - step).toFixed(2);
                        });
                        
                        plusBtn.addEventListener('click', () => {
                            const value = parseFloat(input.value) || 0;
                            const step = input.parentElement.querySelector('.form-label').textContent.includes('Volume') ? 0.01 : 0.1;
                            input.value = (value + step).toFixed(2);
                        });
                    }
                });
            }
            
            setupBottomPanels() {
                const panelTabs = document.querySelectorAll('.panel-tab');
                
                panelTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        panelTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Hide all panel content
                        document.querySelectorAll('.panel-content').forEach(panel => {
                            panel.classList.remove('active');
                        });
                        
                        // Show corresponding panel content
                        const panelId = tab.dataset.panel + 'Panel';
                        const panel = document.getElementById(panelId);
                        if (panel) {
                            panel.classList.add('active');
                        }
                    });
                });
            }
            
            setupMarketWatch() {
                const symbolRows = document.querySelectorAll('.symbol-row');
                
                symbolRows.forEach(row => {
                    row.addEventListener('click', () => {
                        // Remove active class from all rows
                        symbolRows.forEach(r => r.classList.remove('active'));
                        
                        // Add active class to clicked row
                        row.classList.add('active');
                        
                        // Update chart symbol
                        const symbol = row.querySelector('.symbol-name').textContent;
                        const chartTab = document.querySelector('.chart-tab.active');
                        if (chartTab) {
                            chartTab.innerHTML = `<i class="fas fa-chart-line"></i> ${symbol},H1 <span class="chart-tab-close">&times;</span>`;
                        }
                        
                        // Update chart price
                        const bid = row.querySelector('.symbol-bid').textContent;
                        const ask = row.querySelector('.symbol-ask').textContent;
                        const chartPrice = document.querySelector('.symbol-price');
                        const priceInfo = document.querySelector('.price-info');
                        
                        if (chartPrice) chartPrice.textContent = bid;
                        if (priceInfo) {
                            priceInfo.innerHTML = `
                                Bid: <span class="price-bid">${bid}</span> | 
                                Ask: <span class="price-ask">${ask}</span> | 
                                Spread: <span>1.0</span>
                            `;
                        }
                    });
                });
            }
            
            updateStatusBar() {
                setInterval(() => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    const statusBar = document.querySelector('.status-bar .connection-status span');
                    if (statusBar) {
                        statusBar.textContent = `Connected to XNets Broker Server â€¢ Last quote: ${timeStr}`;
                    }
                }, 1000);
            }
            
            // Add chart tab functionality
            setupChartTabs() {
                const addChartBtn = document.querySelector('.add-chart-tab');
                const chartTabsHeader = document.querySelector('.chart-tabs-header');
                
                if (addChartBtn) {
                    addChartBtn.addEventListener('click', () => {
                        // Add new chart tab
                        const newTab = document.createElement('div');
                        newTab.className = 'chart-tab';
                        newTab.innerHTML = `
                            <i class="fas fa-chart-line"></i>
                            EURUSD,H1
                            <span class="chart-tab-close">&times;</span>
                        `;
                        
                        // Insert before add button
                        chartTabsHeader.insertBefore(newTab, addChartBtn);
                        
                        // Setup close button
                        const closeBtn = newTab.querySelector('.chart-tab-close');
                        closeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            newTab.remove();
                        });
                        
                        // Setup tab click
                        newTab.addEventListener('click', () => {
                            document.querySelectorAll('.chart-tab').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            newTab.classList.add('active');
                        });
                    });
                }
                
                // Setup existing close buttons
                document.querySelectorAll('.chart-tab-close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tab = closeBtn.closest('.chart-tab');
                        if (tab) {
                            tab.remove();
                        }
                    });
                });
            }
            
            setupPanelResize() {
                const bottomPanel = document.getElementById('bottomPanel');
                if (!bottomPanel) return;
                
                // Set initial height
                bottomPanel.style.height = this.panelHeight + 'px';
                
                // Create resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'panel-resize-handle';
                resizeHandle.style.cursor = 'ns-resize';
                
                // Insert at the top of the bottom panel
                bottomPanel.parentNode.insertBefore(resizeHandle, bottomPanel);
                
                // Add resize functionality
                resizeHandle.addEventListener('mousedown', (e) => {
                    this.isResizing = true;
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    
                    const startY = e.clientY;
                    const startHeight = bottomPanel.offsetHeight;
                    
                    const onMouseMove = (e) => {
                        if (!this.isResizing) return;
                        
                        const deltaY = startY - e.clientY;
                        let newHeight = startHeight + deltaY;
                        
                        // Constrain height
                        newHeight = Math.max(this.minPanelHeight, Math.min(this.maxPanelHeight, newHeight));
                        
                        bottomPanel.style.height = newHeight + 'px';
                        this.panelHeight = newHeight;
                    };
                    
                    const onMouseUp = () => {
                        this.isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                
                // Prevent text selection while resizing
                resizeHandle.addEventListener('selectstart', (e) => {
                    e.preventDefault();
                });
            }
            
            setupMarketWatchToggle() {
                const toggleBtn = document.getElementById('marketWatchToggle');
                const sidebar = document.getElementById('marketWatchSidebar');
                
                if (toggleBtn && sidebar) {
                    toggleBtn.addEventListener('click', () => {
                        this.marketWatchVisible = !this.marketWatchVisible;
                        
                        if (this.marketWatchVisible) {
                            sidebar.classList.add('show');
                            toggleBtn.classList.add('active');
                        } else {
                            sidebar.classList.remove('show');
                            toggleBtn.classList.remove('active');
                        }
                    });
                }
            }
            
            setupStrategyPanel() {
                const strategyCards = document.querySelectorAll('[data-strategy]');
                const ibrahimSection = document.getElementById('ibrahimStrategy');
                const marketDNASection = document.getElementById('marketDNAStrategy');
                
                strategyCards.forEach(card => {
                    card.addEventListener('click', () => {
                        strategyCards.forEach(c => c.classList.remove('active-strategy'));
                        card.classList.add('active-strategy');
                        
                        const strategy = card.dataset.strategy;
                        if (strategy === 'ibrahim') {
                            if (ibrahimSection) ibrahimSection.style.display = 'block';
                            if (marketDNASection) marketDNASection.style.display = 'none';
                        } else if (strategy === 'marketdna') {
                            if (ibrahimSection) ibrahimSection.style.display = 'none';
                            if (marketDNASection) marketDNASection.style.display = 'block';
                            this.startMarketDNABot();
                        }
                    });
                });
                
                // Button event listeners
                document.getElementById('refreshStrategies')?.addEventListener('click', () => {
                    this.refreshStrategyData();
                });
                
                document.getElementById('scanPatterns')?.addEventListener('click', () => {
                    this.scanForPatterns();
                });
                
                document.getElementById('runBacktest')?.addEventListener('click', () => {
                    this.runStrategyBacktest();
                });
            }

            refreshStrategyData() {
                const btn = document.getElementById('refreshStrategies');
                if (!btn) return;
                
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                setTimeout(() => {
                    btn.innerHTML = original;
                    this.showNotification('Strategy data refreshed', 'success');
                }, 1000);
            }

            startMarketDNABot() {
                console.log('Market DNA Bot started');
                this.simulatePatternDetection();
            }

            simulatePatternDetection() {
                const container = document.getElementById('patternDetections');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="alert-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-accent-teal);">
                                    Double Bottom â€¢ XAUUSD
                                </div>
                                <div style="font-size: 10px; color: var(--mt5-text-secondary);">
                                    4H â€¢ Confidence: 78%
                                </div>
                            </div>
                            <div style="font-size: 10px; color: var(--mt5-accent-green); font-weight: 600;">
                                BULLISH
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                            Entry: 2025.50 â€¢ SL: 2015.00 â€¢ TP1: 2035.50 â€¢ TP2: 2045.50
                        </div>
                        <button class="panel-btn-small" style="margin-top: 6px; font-size: 9px; width: 100%;">
                            <i class="fas fa-chart-line"></i> Plot on Chart
                        </button>
                    </div>
                `;
            }

            scanForPatterns() {
                const btn = document.getElementById('scanPatterns');
                if (!btn) return;
                
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning';
                
                setTimeout(() => {
                    btn.innerHTML = original;
                    this.simulatePatternDetection();
                    this.showNotification('Pattern scan complete', 'success');
                }, 1500);
            }

            runStrategyBacktest() {
                const btn = document.getElementById('runBacktest');
                if (!btn) return;
                
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backtesting';
                
                setTimeout(() => {
                    btn.innerHTML = original;
                    this.showNotification('Backtest completed successfully', 'success');
                }, 2000);
            }

            showNotification(message, type = 'info') {
                // Create a simple notification
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }

        // Add these helper functions to the window object
        window.openNews = function() {
            const newsTab = document.querySelector('[data-panel="news"]');
            if (newsTab) {
                newsTab.click();
            }
        }

        window.detectBOS = function() {
            const checkmark = event.target.closest('.alert-card').querySelector('.checkmark');
            if (checkmark) {
                checkmark.innerHTML = '<i class="fas fa-check-circle"></i>';
                checkmark.style.color = 'var(--mt5-accent-green)';
                checkmark.style.display = 'block';
            }
        }

        // Initialize platform
        document.addEventListener('DOMContentLoaded', () => {
            window.xnetsPlatform = new XNetsTradingPlatform();
            
            // Test that all panels are accessible
            console.log('Platform initialized. Testing panel accessibility...');
            const panels = ['trade', 'exposure', 'history', 'news', 'mailbox', 'calendar', 
                          'company', 'alerts', 'articles', 'codebase', 'experts', 'journal', 'strategies'];
            
            panels.forEach(panel => {
                const element = document.getElementById(panel + 'Panel');
                if (element) {
                    console.log(`${panel} panel: âœ“ Found`);
                } else {
                    console.log(`${panel} panel: âœ— Missing`);
                }
            });
        });

        // ==============================================
// XNets ULTIMATE Trading System
// ENHANCED WORKING VERSION with Ultimate Features
// PROFESSIONAL STRATEGY CONTROL PANEL
// INCLUDING QUICK ACTION BUTTONS WITH SCROLLABLE HEADER
// ==============================================

class XNetsUltimateTradingSystem {
    constructor() {
        // Bot states
        this.isRunning = false;
        this.isPaused = false;
        this.botStatus = 'stopped';
        this.currentView = 'dashboard';
        
        // Comprehensive strategy library with initial states
        this.strategies = {
            ibrahim: {
                name: 'Ibrahim Abu Strategy',
                active: true,
                color: '#00b4a0',
                description: 'Identifies and rides established market trends',
                confidence: 0.72,
                winRate: 0.68,
                signals: [],
                // NEW: Exact strategy execution tracking
                exactExecution: {
                    enabled: true,
                    lastExecution: null,
                    executionCount: 0,
                    parameters: {
                        entryType: 'strict', // strict, adaptive
                        confirmationCandles: 2,
                        requireVolume: true
                    }
                }
            },
            marketdna: {
                name: 'Market DNA Bot',
                active: false,
                color: '#4a9eff',
                description: 'Capitalizes on price deviations from average',
                confidence: 0.65,
                winRate: 0.62,
                signals: []
            },
            scalping: {
                name: 'AI Scalping Engine',
                active: false,
                color: '#26c6da',
                description: 'High-frequency short-term trading',
                confidence: 0.60,
                winRate: 0.75,
                signals: []
            },
            harmonic: {
                name: 'Harmonic Pattern Finder',
                active: true,
                color: '#9c27b0',
                description: 'Identifies Fibonacci-based harmonic patterns',
                confidence: 0.75,
                winRate: 0.71,
                signals: []
            },
            momentum: {
                name: 'Momentum Trading',
                active: false,
                color: '#ffa726',
                description: 'Analyzes market momentum and trend strength',
                confidence: 0.68,
                winRate: 0.64,
                signals: []
            },
            breakout: {
                name: 'Breakout Scanner',
                active: true,
                color: '#ff6b6b',
                description: 'Detects price breakouts from consolidation',
                confidence: 0.70,
                winRate: 0.59,
                signals: []
            }
        };
        
        // NEW: Multiple accounts management
        this.accounts = [
            {
                id: 'acc_1',
                name: 'Main Trading',
                balance: 10000.00,
                equity: 10000.00,
                margin: 0.00,
                freeMargin: 10000.00,
                marginLevel: 0,
                leverage: 100,
                currency: 'USD',
                isActive: true,
                broker: 'Demo',
                server: 'ICMarkets-Demo'
            },
            {
                id: 'acc_2',
                name: 'Conservative',
                balance: 5000.00,
                equity: 5000.00,
                margin: 0.00,
                freeMargin: 5000.00,
                marginLevel: 0,
                leverage: 50,
                currency: 'USD',
                isActive: false,
                broker: 'Demo',
                server: 'FXCM-Demo'
            },
            {
                id: 'acc_3',
                name: 'Aggressive',
                balance: 15000.00,
                equity: 15000.00,
                margin: 0.00,
                freeMargin: 15000.00,
                marginLevel: 0,
                leverage: 200,
                currency: 'USD',
                isActive: false,
                broker: 'Demo',
                server: 'Pepperstone-Demo'
            }
        ];
        
        // Current active account
        this.currentAccount = this.accounts[0];
        
        // NEW: Economic calendar data
        this.economicCalendar = {
            events: [
                {
                    id: 'eco_1',
                    title: 'FOMC Interest Rate Decision',
                    country: 'USA',
                    impact: 'high',
                    forecast: '5.50%',
                    previous: '5.50%',
                    actual: null,
                    date: new Date(Date.now() + 86400000), // Tomorrow
                    currency: 'USD',
                    symbol: 'EURUSD, XAUUSD'
                },
                {
                    id: 'eco_2',
                    title: 'Non-Farm Employment Change',
                    country: 'USA',
                    impact: 'high',
                    forecast: '185K',
                    previous: '216K',
                    actual: null,
                    date: new Date(Date.now() + 172800000), // 2 days
                    currency: 'USD',
                    symbol: 'EURUSD, XAUUSD, US30'
                },
                {
                    id: 'eco_3',
                    title: 'ECB Interest Rate Decision',
                    country: 'EU',
                    impact: 'high',
                    forecast: '4.00%',
                    previous: '4.00%',
                    actual: null,
                    date: new Date(Date.now() + 259200000), // 3 days
                    currency: 'EUR',
                    symbol: 'EURUSD'
                },
                {
                    id: 'eco_4',
                    title: 'CPI Inflation Rate (YoY)',
                    country: 'USA',
                    impact: 'high',
                    forecast: '3.1%',
                    previous: '3.4%',
                    actual: null,
                    date: new Date(Date.now() + 432000000), // 5 days
                    currency: 'USD',
                    symbol: 'XAUUSD, EURUSD, US30'
                },
                {
                    id: 'eco_5',
                    title: 'BOE Interest Rate Decision',
                    country: 'UK',
                    impact: 'high',
                    forecast: '5.25%',
                    previous: '5.25%',
                    actual: null,
                    date: new Date(Date.now() + 345600000), // 4 days
                    currency: 'GBP',
                    symbol: 'GBPUSD'
                }
            ],
            filteredEvents: [],
            lastUpdate: null
        };
        
        // NEW: Confidence level explanations
        this.confidenceExplanations = {
            high: {
                threshold: 0.75,
                color: 'var(--mt5-accent-green)',
                icon: 'fa-check-circle',
                description: 'Strong signal - Multiple timeframe alignment, high volume confirmation, and favorable market conditions',
                action: 'Recommended for execution',
                riskLevel: 'Low'
            },
            medium: {
                threshold: 0.60,
                color: 'var(--mt5-accent-yellow)',
                icon: 'fa-exclamation-triangle',
                description: 'Moderate signal - Some timeframe alignment, average volume, neutral market conditions',
                action: 'Consider with proper risk management',
                riskLevel: 'Medium'
            },
            low: {
                threshold: 0.50,
                color: 'var(--mt5-accent-orange)',
                icon: 'fa-question-circle',
                description: 'Weak signal - Limited timeframe alignment, low volume confirmation, uncertain conditions',
                action: 'Caution advised or wait for confirmation',
                riskLevel: 'High'
            }
        };
        
        // NEW: Position size calculator based on risk per trade
        this.positionSizeCalculator = {
            riskAmount: 0,
            calculatedLots: 0,
            pipValue: 0,
            maxLoss: 0
        };
        
        // NEW: Trade timing status
        this.tradeTiming = {
            dependentTP: 0,
            dependentSL: 0,
            manualExits: 0
        };
        
        // Advanced configuration
        this.config = {
            // Instrument groups
            instrumentGroups: {
                forex: ['EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCAD', 'NZDUSD'],
                commodities: ['XAUUSD', 'XAGUSD', 'OILUSD', 'NATGAS'],
                indices: ['US30', 'SPX500', 'NAS100', 'GER40', 'UK100'],
                crypto: ['BTCUSD', 'ETHUSD', 'XRPUSD', 'ADAUSD']
            },
            selectedSymbols: ['XAUUSD', 'EURUSD', 'BTCUSD'],
            
            // Timeframes for multi-timeframe analysis
            timeframes: ['M5', 'M15', 'H1', 'H4', 'D1'],
            activeTimeframes: ['H1', 'H4'],
            
            // Advanced risk management
            riskManagement: {
                riskPerTrade: 0.005,
                maxDailyLoss: 0.03,
                maxConcurrentTrades: 8,
                maxSameSymbolTrades: 2,
                trailingStop: false,
                trailingDistance: 0.002,
                breakevenAt: 1.5,
                partialTakeProfit: [0.5, 0.5],
                martingale: false,
                recoveryMode: false
            },
            
            // Signal filtering
            signalFilters: {
                minConfidence: 0.65,
                minVolume: 0.5,
                maxSlippage: 0.0005,
                timeFilter: 'all',
                avoidNews: true,
                newsImpactLevel: 'medium'
            },
            
            // Execution settings
            execution: {
                mode: 'manual',
                autoExecuteAbove: 0.75,
                confirmationRequired: true,
                delayExecution: 2,
                useVirtualSLTP: true,
                allowModification: true
            },
            
            // Analytics
            analytics: {
                trackPerformance: true,
                generateReports: true,
                saveTradeHistory: true,
                calculateMetrics: true,
                backtestMode: false
            },
            
            // Alerts & notifications
            notifications: {
                desktopAlerts: true,
                soundAlerts: true,
                emailAlerts: false,
                telegramAlerts: false,
                alertLevels: ['high', 'medium']
            },
            
            // Basic config (compatibility)
            symbols: ['XAUUSD', 'EURUSD', 'GBPUSD', 'BTCUSD'],
            updateInterval: 3000,
            demoMode: true,
            autoExecuteSignals: false
        };
        
        // Advanced market data
        this.marketData = {
            prices: {},
            trends: {},
            volatility: {},
            volume: {},
            supportResistance: {},
            pivots: {},
            news: [],
            economicCalendar: []
        };
        
        // Comprehensive trading data
        this.trading = {
            activeTrades: [],
            pendingOrders: [],
            tradeHistory: [],
            signals: [],
            watchlist: [],
            selectedItems: new Set(),
            tradeJournal: []
        };
        
        // Advanced performance metrics
        this.performance = {
            totalTrades: 0,
            winningTrades: 0,
            losingTrades: 0,
            totalProfit: 0,
            winRate: 0,
            profitFactor: 0,
            averageWin: 0,
            averageLoss: 0,
            largestWin: 0,
            largestLoss: 0,
            maxDrawdown: 0,
            maxConsecutiveWins: 0,
            maxConsecutiveLosses: 0,
            sharpeRatio: 0,
            expectancy: 0,
            recoveryFactor: 0,
            dailyProfit: 0,
            weeklyProfit: 0,
            monthlyProfit: 0,
            strategyPerformance: {},
            riskRewardRatio: 0,
            averageRR: 0,
            riskOfRuin: 0
        };
        
        // Enhanced account management
        this.account = {
            balance: 10000.00,
            equity: 10000.00,
            margin: 0.00,
            freeMargin: 10000.00,
            marginLevel: 0,
            leverage: 100,
            currency: 'USD',
            dailyPnL: 0,
            weeklyPnL: 0,
            monthlyPnL: 0,
            peakEquity: 10000.00,
            valleyEquity: 10000.00,
            dailyLimit: -500,
            weeklyLimit: -2000,
            monthlyLimit: -5000
        };
        
        // Session management
        this.session = {
            startTime: null,
            totalRuntime: 0,
            tradeCount: 0,
            currentProfit: 0,
            bestTrade: null,
            worstTrade: null,
            activeAlerts: []
        };
        
        // UI state
        this.ui = {
            currentTab: 'signals',
            chartVisible: true,
            darkMode: true,
            compactView: false,
            soundEnabled: true,
            animationsEnabled: true
        };
        
        // Selected trades (for compatibility)
        this.selectedTrades = new Set();
        this.tradingSignals = [];
        
        // UI references
        this.botContainer = null;
        this.botTab = null;
        this.ultimateContainer = null;
        
        // Initialize
        setTimeout(() => this.init(), 1000);
    }
    
    init() {
        console.log('ðŸš€ Initializing Ultimate Trading System...');
        
        this.initializeMarketData();
        this.setupWorkspaceIntegration();
        this.setupAdvancedEventListeners();
        this.loadPreferences();
        
        // Start background services
        this.startMarketDataStream();
        this.startNewsFeed();
        
        this.log('Ultimate Trading System initialized successfully', 'success');
        this.showWelcomeMessage();
    }
    
    // ==================== MARKET DATA ====================
    
    initializeMarketData() {
        const basePrices = {
            'XAUUSD': 2025.46,
            'EURUSD': 1.08032,
            'GBPUSD': 1.24742,
            'BTCUSD': 42653.9,
            'USDJPY': 148.50,
            'AUDUSD': 0.6575,
            'USDCAD': 1.3520,
            'NZDUSD': 0.6125,
            'XAGUSD': 23.15,
            'OILUSD': 78.40
        };
        
        // Initialize all symbols from config
        const allSymbols = [
            ...this.config.symbols,
            ...this.config.instrumentGroups.forex,
            ...this.config.instrumentGroups.commodities,
            ...this.config.instrumentGroups.crypto
        ];
        
        allSymbols.forEach(symbol => {
            this.marketData.prices[symbol] = basePrices[symbol] || 100.00;
            this.marketData.trends[symbol] = Math.random() > 0.5 ? 'bullish' : 'bearish';
            this.marketData.volatility[symbol] = 0.002 + Math.random() * 0.003;
        });
    }
    
    startMarketDataStream() {
        // MODIFIED: Pause option removed - market data always streams when system is running
        setInterval(() => {
            // Only stream data if system is running
            if (this.isRunning) {
                Object.keys(this.marketData.prices).forEach(symbol => {
                    const trend = this.marketData.trends[symbol];
                    const volatility = this.marketData.volatility[symbol] || 0.002;
                    
                    // Simulate price movement
                    let change = (Math.random() - 0.5) * volatility;
                    
                    // Add trend bias
                    if (trend === 'bullish') change += Math.random() * volatility * 0.1;
                    else if (trend === 'bearish') change -= Math.random() * volatility * 0.1;
                    
                    this.marketData.prices[symbol] *= (1 + change);
                    
                    // Occasionally change trend
                    if (Math.random() > 0.98) {
                        this.marketData.trends[symbol] = Math.random() > 0.5 ? 'bullish' : 'bearish';
                    }
                });
                
                // Update active trades
                this.updateActiveTrades();
                
                // Update market overview if visible
                this.updateMarketOverview();
                
                // Update trade timing statistics
                this.updateTradeTimingStats();
            }
        }, 2000);
    }
    
    // NEW: Update trade timing statistics
    updateTradeTimingStats() {
        this.tradeTiming.dependentTP = this.trading.tradeHistory.filter(t => 
            t.closeReason && t.closeReason.includes('TAKE_PROFIT')).length;
        this.tradeTiming.dependentSL = this.trading.tradeHistory.filter(t => 
            t.closeReason === 'STOP_LOSS').length;
        this.tradeTiming.manualExits = this.trading.tradeHistory.filter(t => 
            t.closeReason === 'MANUAL_CLOSE').length;
    }
    
    // NEW: Calculate position size based on risk per trade
    calculatePositionSize(symbol, entryPrice, stopLoss, direction) {
        const riskAmount = this.currentAccount.equity * this.config.riskManagement.riskPerTrade;
        const riskPerUnit = Math.abs(entryPrice - stopLoss);
        
        // Calculate pip value and lot size
        let pipSize = 0.0001;
        if (symbol.includes('JPY')) pipSize = 0.01;
        if (symbol.includes('XAU') || symbol.includes('XAG')) pipSize = 0.1;
        
        const pipValue = (entryPrice * 0.0001) * 100000; // Simplified pip value
        const stopLossPips = riskPerUnit / pipSize;
        const lotSize = riskAmount / (stopLossPips * pipValue * 10);
        
        // Round to standard lot sizes
        const roundedLots = Math.max(0.01, Math.min(Math.round(lotSize * 100) / 100, 10.0));
        
        this.positionSizeCalculator = {
            riskAmount: riskAmount,
            calculatedLots: roundedLots,
            pipValue: pipValue * 10,
            maxLoss: riskAmount,
            stopLossPips: stopLossPips,
            accountRisk: (riskAmount / this.currentAccount.equity * 100).toFixed(2)
        };
        
        return roundedLots;
    }
    
    // NEW: Execute Ibrahim Abu Strategy exactly as computed
    executeIbrahimAbuStrategy(signal) {
        const strategy = this.strategies.ibrahim;
        
        // Check if exact execution is enabled
        if (!strategy.exactExecution.enabled) return false;
        
        // Apply strict entry criteria
        const price = this.marketData.prices[signal.symbol];
        const trend = this.marketData.trends[signal.symbol];
        
        // Verify trend matches signal direction
        if ((signal.direction === 'BUY' && trend !== 'bullish') ||
            (signal.direction === 'SELL' && trend !== 'bearish')) {
            this.log('Ibrahim Abu Strategy: Signal rejected - trend mismatch', 'warning');
            return false;
        }
        
        // Verify volume condition
        if (strategy.exactExecution.parameters.requireVolume) {
            const volume = this.marketData.volume[signal.symbol] || 0.5;
            if (volume < 0.6) {
                this.log('Ibrahim Abu Strategy: Signal rejected - insufficient volume', 'warning');
                return false;
            }
        }
        
        // Execute the trade
        const orderParams = {
            strategy: strategy.name,
            symbol: signal.symbol,
            direction: signal.direction,
            entryPrice: signal.entryPrice,
            stopLoss: this.calculateStopLoss(signal.entryPrice, signal.direction, 'ibrahim'),
            takeProfit: this.calculateTakeProfit(signal.entryPrice, signal.direction, 'ibrahim')
        };
        
        const trade = this.executeAdvancedOrder('market', orderParams);
        
        if (trade) {
            strategy.exactExecution.lastExecution = new Date();
            strategy.exactExecution.executionCount++;
            
            this.log(`Ibrahim Abu Strategy: Exact trade executed for ${signal.symbol}`, 'success');
            return true;
        }
        
        return false;
    }
    
    startNewsFeed() {
        // Simulate news updates
        setInterval(() => {
            if (Math.random() > 0.7) {
                const newsItems = [
                    "FED announces interest rate decision",
                    "ECB maintains current policy stance",
                    "Gold prices surge on safe-haven demand",
                    "Bitcoin volatility increases ahead of halving",
                    "Major currency pairs experiencing heightened volatility"
                ];
                
                const news = {
                    id: `NEWS_${Date.now()}`,
                    title: newsItems[Math.floor(Math.random() * newsItems.length)],
                    impact: Math.random() > 0.5 ? 'high' : 'medium',
                    timestamp: new Date(),
                    symbol: ['XAUUSD', 'EURUSD', 'BTCUSD'][Math.floor(Math.random() * 3)]
                };
                
                this.marketData.news.unshift(news);
                if (this.marketData.news.length > 10) this.marketData.news.pop();
                
                // Show notification for high-impact news
                if (news.impact === 'high') {
                    this.showAdvancedNotification('Market News', news.title, 'info');
                }
            }
            
            // Update economic calendar on the dashboard if visible
            this.updateEconomicCalendarDisplay();
            
        }, 10000);
    }
    
    // ==================== WORKSPACE INTEGRATION ====================
    
    setupWorkspaceIntegration() {
        console.log('Setting up workspace integration...');
        this.createBotContainer();
        this.createUltimateContainer();
        this.createBotChartTab();
        this.addEnhancedStyles();
        this.addToolbarButtons();
    }
    
    createUltimateContainer() {
        // Remove existing
        const existing = document.getElementById('ultimateTradingSystem');
        if (existing) existing.remove();
        
        // Create main container
        this.ultimateContainer = document.createElement('div');
        this.ultimateContainer.id = 'ultimateTradingSystem';
        this.ultimateContainer.className = 'ultimate-trading-system';
        this.ultimateContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--mt5-bg-primary);
            z-index: 9999;
            display: none;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        document.body.appendChild(this.ultimateContainer);
    }
    
    createBotChartTab() {
        console.log('Creating bot chart tab...');
        const chartTabsHeader = document.querySelector('.chart-tabs-header');
        if (!chartTabsHeader) {
            setTimeout(() => this.createBotChartTab(), 500);
            return;
        }
        
        // Remove existing bot tab if any
        const existingBotTab = document.querySelector('.chart-tab[data-bot]');
        if (existingBotTab) existingBotTab.remove();
        
        // Create new bot tab
        this.botTab = document.createElement('div');
        this.botTab.className = 'chart-tab';
        this.botTab.dataset.bot = 'true';
        this.botTab.innerHTML = `
            <i class="fas fa-robot" style="color: var(--mt5-accent-teal);"></i>
            Ultimate Trading
            <span class="chart-tab-close">&times;</span>
        `;
        
        // Insert before add button
        const addBtn = document.querySelector('.add-chart-tab');
        if (addBtn) {
            chartTabsHeader.insertBefore(this.botTab, addBtn);
        } else {
            chartTabsHeader.appendChild(this.botTab);
        }
        
        // Tab click handler
        this.botTab.addEventListener('click', (e) => {
            if (e.target.classList.contains('chart-tab-close')) return;
            this.showBotInterface();
            this.updateTabStates();
        });
        
        // Close handler
        const closeBtn = this.botTab.querySelector('.chart-tab-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.hideBotInterface();
                this.botTab.remove();
                this.botTab = null;
            });
        }
        
        console.log('Bot tab created successfully');
    }
    
    createBotContainer() {
        console.log('Creating bot container...');
        
        // Remove existing container if any
        const existingContainer = document.getElementById('tradingBotWorkspace');
        if (existingContainer) existingContainer.remove();
        
        // Create container
        this.botContainer = document.createElement('div');
        this.botContainer.id = 'tradingBotWorkspace';
        this.botContainer.className = 'bot-workspace-container';
        this.botContainer.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--mt5-bg-primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        `;
        
        // Create interface
        this.botContainer.innerHTML = this.getBotInterfaceHTML();
        
        // Add to chart container
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            chartContainer.appendChild(this.botContainer);
            console.log('Bot container added to chart container');
        } else {
            setTimeout(() => this.createBotContainer(), 500);
        }
    }
    
    getBotInterfaceHTML() {
        return `
            <!-- Bot Header with Ultimate Features - FIXED SCROLLABLE LAYOUT -->
            <div class="bot-header" style="background: linear-gradient(135deg, var(--mt5-bg-tertiary) 0%, #1a1f2e 100%); padding: 12px 20px; border-bottom: 1px solid var(--mt5-border); display: flex; justify-content: space-between; align-items: center; min-height: 68px; flex-wrap: wrap; gap: 12px;">
                <!-- Left Section: Logo and Status -->
                <div style="display: flex; align-items: center; gap: 12px; min-width: 280px; flex-shrink: 0;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--mt5-accent-teal), #26c6da); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-robot" style="color: white; font-size: 18px;"></i>
                    </div>
                    <div style="min-width: 240px;">
                        <div style="font-size: 16px; font-weight: 700; color: white; letter-spacing: 0.5px; white-space: nowrap;">
                            XNets Ultimate Trading System
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span id="botStatusBadge" style="color: var(--mt5-accent-red);">â— STOPPED</span>
                            <span>â€¢</span>
                            <span>Equity: <strong style="color: var(--mt5-accent-teal);">$${this.account.equity.toFixed(2)}</strong></span>
                            <span>â€¢</span>
                            <span>Active: <strong style="color: var(--mt5-accent-yellow);">0</strong></span>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Section: QUICK ACTION BUTTONS - MT5 STYLE WITH SCROLL -->
                <div class="quick-actions-container" style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 6px; overflow-x: auto; padding: 4px 0; scrollbar-width: thin; scrollbar-color: var(--mt5-accent-teal) transparent;">
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; padding: 0 8px;">
                        <button class="quick-action-trade-btn" data-action="buy" style="background: var(--mt5-accent-green); color: white; border: none; border-radius: 4px; padding: 8px 16px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-arrow-up"></i> BUY
                        </button>
                        <button class="quick-action-trade-btn" data-action="sell" style="background: var(--mt5-accent-red); color: white; border: none; border-radius: 4px; padding: 8px 16px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-arrow-down"></i> SELL
                        </button>
                        <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 4px; flex-shrink: 0;"></div>
                        <button class="quick-action-trade-btn" data-action="closeSelected" style="background: var(--mt5-accent-yellow); color: white; border: none; border-radius: 4px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-times-circle"></i> Close Selected
                        </button>
                        <button class="quick-action-trade-btn" data-action="closeAll" style="background: var(--mt5-accent-orange); color: white; border: none; border-radius: 4px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-times"></i> Close All
                        </button>
                        <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 4px; flex-shrink: 0;"></div>
                        <button class="quick-action-trade-btn" data-action="moveToBreakeven" style="background: var(--mt5-accent-teal); color: white; border: none; border-radius: 4px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-balance-scale"></i> Move to BE
                        </button>
                        <button class="quick-action-trade-btn" data-action="enableTrailing" style="background: var(--mt5-accent-purple); color: white; border: none; border-radius: 4px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0;">
                            <i class="fas fa-sliders-h"></i> Enable Trailing
                        </button>
                    </div>
                </div>
                
                <!-- Right Section: Stats and Control Buttons -->
                <div style="display: flex; align-items: center; gap: 16px; min-width: 320px; flex-shrink: 0; justify-content: flex-end;">
                    <!-- Quick Stats -->
                    <div style="display: flex; gap: 16px; margin-right: 16px; flex-shrink: 0;">
                        <div style="text-align: center; min-width: 60px;">
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); white-space: nowrap;">Win Rate</div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--mt5-accent-green);" id="navWinRate">0%</div>
                        </div>
                        <div style="text-align: center; min-width: 70px;">
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); white-space: nowrap;">Today's P&L</div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--mt5-accent-teal);" id="navDailyPnL">$0.00</div>
                        </div>
                    </div>
                    <!-- Control Buttons -->
                    <div style="display: flex; gap: 8px; flex-wrap: nowrap; flex-shrink: 0;">
                        <button id="ultimateSystemBtn" class="bot-control-btn" style="background: var(--mt5-accent-teal); color: white; font-weight: 600; white-space: nowrap; padding: 8px 12px;">
                            <i class="fas fa-rocket"></i> Dashboard
                        </button>
                        <button id="botStartBtn" class="bot-control-btn" style="background: var(--mt5-accent-green); color: white; white-space: nowrap; padding: 8px 12px;">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button id="botPauseBtn" class="bot-control-btn" disabled style="background: var(--mt5-bg-tertiary); white-space: nowrap; padding: 8px 12px;">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button id="botStopBtn" class="bot-control-btn" disabled style="background: var(--mt5-bg-tertiary); white-space: nowrap; padding: 8px 12px;">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Bot Content with Enhanced Layout -->
            <div class="bot-content" style="flex: 1; display: grid; grid-template-columns: 320px 1fr; gap: 0; overflow: hidden;">
                <!-- Left Panel - Enhanced Controls -->
                <div class="bot-left-panel" style="background: var(--mt5-bg-secondary); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid var(--mt5-border);">
                    ${this.getEnhancedControlsHTML()}
                </div>
                
                <!-- Right Panel - Enhanced Trading -->
                <div class="bot-right-panel" style="background: var(--mt5-bg-primary); display: flex; flex-direction: column; overflow: hidden;">
                    ${this.getEnhancedTradingPanelHTML()}
                </div>
            </div>
        `;
    }
    
    getEnhancedControlsHTML() {
        return `
            <!-- Professional Strategy Control Panel -->
            <div class="strategy-panel-container">
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-brain"></i> Advanced Strategies
                </div>
                <div class="strategy-control-panel" style="background: var(--mt5-bg-tertiary); border-radius: 8px; padding: 16px; border: 1px solid var(--mt5-border);">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${Object.entries(this.strategies).map(([key, strategy]) => `
                            <div class="strategy-control-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; transition: all 0.2s;">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <div class="strategy-status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: ${strategy.active ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};"></div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--mt5-text-primary);">${strategy.name}</div>
                                    ${key === 'ibrahim' ? `
                                        <span style="font-size: 10px; background: rgba(0, 180, 160, 0.2); color: var(--mt5-accent-teal); padding: 2px 6px; border-radius: 10px;">
                                            <i class="fas fa-check-circle"></i> Exact Execution
                                        </span>
                                    ` : ''}
                                    <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-left: auto;">${strategy.description}</div>
                                </div>
                                <div class="strategy-toggle-switch" style="margin-left: 16px; cursor: pointer;">
                                    <input type="checkbox" class="strategy-toggle-input" data-strategy="${key}" ${strategy.active ? 'checked' : ''} style="display: none;">
                                    <span class="strategy-toggle-slider" style="position: relative; display: inline-block; width: 44px; height: 24px; background: ${strategy.active ? strategy.color : 'var(--mt5-border)'}; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                                        <span style="position: absolute; top: 3px; left: ${strategy.active ? '23px' : '3px'}; width: 18px; height: 18px; background: white; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Quick Action Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                        <button id="enableAllStrategies" class="strategy-action-btn" style="background: var(--mt5-accent-teal); color: white; border: none; border-radius: 4px; padding: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-toggle-on"></i> Enable All
                        </button>
                        <button id="disableAllStrategies" class="strategy-action-btn" style="background: var(--mt5-bg-secondary); color: var(--mt5-text-secondary); border: 1px solid var(--mt5-border); border-radius: 4px; padding: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-toggle-off"></i> Disable All
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Strategy Selection -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cogs"></i> Strategy Configuration
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;" id="strategyContainer">
                    ${Object.entries(this.strategies).map(([key, strategy]) => `
                        <div class="strategy-config" style="padding: 10px 12px; background: var(--mt5-bg-tertiary); border-radius: 4px; ${!strategy.active ? 'opacity: 0.6;' : ''}">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--mt5-text-primary); display: flex; align-items: center; gap: 8px;">
                                        ${strategy.active ? '<i class="fas fa-play-circle" style="color: var(--mt5-accent-green); font-size: 12px;"></i>' : '<i class="fas fa-stop-circle" style="color: var(--mt5-accent-red); font-size: 12px;"></i>'}
                                        ${strategy.name}
                                    </div>
                                    <div style="font-size: 11px; color: var(--mt5-text-secondary);">${strategy.description}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                                    <span style="color: ${strategy.confidence >= 0.7 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-yellow)'};">${Math.round(strategy.confidence * 100)}%</span>
                                    <span style="color: var(--mt5-text-secondary);">|</span>
                                    <span style="color: ${strategy.winRate >= 0.65 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-yellow)'};">${Math.round(strategy.winRate * 100)}% win</span>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                                <div style="display: flex; justify-content: space-between;">
                                    <label>Confidence: ${Math.round(strategy.confidence * 100)}%</label>
                                    ${key === 'ibrahim' ? `
                                        <span style="color: var(--mt5-accent-teal);">
                                            <i class="fas fa-microchip"></i> Exact: ${strategy.exactExecution.enabled ? 'ON' : 'OFF'}
                                        </span>
                                    ` : ''}
                                </div>
                                <input type="range" min="50" max="95" step="5" value="${Math.round(strategy.confidence * 100)}" 
                                       class="strategy-slider" data-strategy="${key}" data-param="confidence" style="width: 100%; margin-top: 4px;" ${!strategy.active ? 'disabled' : ''}>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Multi-Timeframe Analysis - FIXED VERSION -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-clock"></i> Multi-Timeframe Analysis
                </div>
                <div style="background: var(--mt5-bg-tertiary); border-radius: 8px; padding: 16px; border: 1px solid var(--mt5-border); margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 10px;">
                        Select timeframes for consensus analysis. Signals require agreement across selected timeframes.
                    </div>
                    <div class="multi-timeframe-selector" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tfM5" value="M5" ${this.config.activeTimeframes.includes('M5') ? 'checked' : ''} class="timeframe-checkbox" style="display: none;">
                            <label for="tfM5" class="timeframe-label" 
                                onclick="window.ultimateTradingSystem.handleTimeframeSelection(event)"
                                style="flex: 1; padding: 8px 12px; background: ${this.config.activeTimeframes.includes('M5') ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)'}; border: 1px solid ${this.config.activeTimeframes.includes('M5') ? 'var(--mt5-accent-green)' : 'var(--mt5-border)'}; border-radius: 4px; text-align: center; font-size: 12px; cursor: pointer; color: ${this.config.activeTimeframes.includes('M5') ? 'white' : 'var(--mt5-text-primary)'};">
                                5 Minute
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tfM15" value="M15" ${this.config.activeTimeframes.includes('M15') ? 'checked' : ''} class="timeframe-checkbox" style="display: none;">
                            <label for="tfM15" class="timeframe-label" 
                                onclick="window.ultimateTradingSystem.handleTimeframeSelection(event)"
                                style="flex: 1; padding: 8px 12px; background: ${this.config.activeTimeframes.includes('M15') ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)'}; border: 1px solid ${this.config.activeTimeframes.includes('M15') ? 'var(--mt5-accent-green)' : 'var(--mt5-border)'}; border-radius: 4px; text-align: center; font-size: 12px; cursor: pointer; color: ${this.config.activeTimeframes.includes('M15') ? 'white' : 'var(--mt5-text-primary)'};">
                                15 Minute
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tfH1" value="H1" ${this.config.activeTimeframes.includes('H1') ? 'checked' : ''} class="timeframe-checkbox" style="display: none;">
                            <label for="tfH1" class="timeframe-label" 
                                onclick="window.ultimateTradingSystem.handleTimeframeSelection(event)"
                                style="flex: 1; padding: 8px 12px; background: ${this.config.activeTimeframes.includes('H1') ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)'}; border: 1px solid ${this.config.activeTimeframes.includes('H1') ? 'var(--mt5-accent-green)' : 'var(--mt5-border)'}; border-radius: 4px; text-align: center; font-size: 12px; cursor: pointer; color: ${this.config.activeTimeframes.includes('H1') ? 'white' : 'var(--mt5-text-primary)'};">
                                1 Hour
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tfH4" value="H4" ${this.config.activeTimeframes.includes('H4') ? 'checked' : ''} class="timeframe-checkbox" style="display: none;">
                            <label for="tfH4" class="timeframe-label" 
                                onclick="window.ultimateTradingSystem.handleTimeframeSelection(event)"
                                style="flex: 1; padding: 8px 12px; background: ${this.config.activeTimeframes.includes('H4') ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)'}; border: 1px solid ${this.config.activeTimeframes.includes('H4') ? 'var(--mt5-accent-green)' : 'var(--mt5-border)'}; border-radius: 4px; text-align: center; font-size: 12px; cursor: pointer; color: ${this.config.activeTimeframes.includes('H4') ? 'white' : 'var(--mt5-text-primary)'};">
                                4 Hour
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="tfD1" value="D1" ${this.config.activeTimeframes.includes('D1') ? 'checked' : ''} class="timeframe-checkbox" style="display: none;">
                            <label for="tfD1" class="timeframe-label" 
                                onclick="window.ultimateTradingSystem.handleTimeframeSelection(event)"
                                style="flex: 1; padding: 8px 12px; background: ${this.config.activeTimeframes.includes('D1') ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)'}; border: 1px solid ${this.config.activeTimeframes.includes('D1') ? 'var(--mt5-accent-green)' : 'var(--mt5-border)'}; border-radius: 4px; text-align: center; font-size: 12px; cursor: pointer; color: ${this.config.activeTimeframes.includes('D1') ? 'white' : 'var(--mt5-text-primary)'};">
                                Daily
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--mt5-border);">
                        <div style="font-size: 11px; color: var(--mt5-text-secondary);">
                            Selected: <span id="selectedTimeframesCount">${this.config.activeTimeframes.length}</span> timeframes
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="selectAllTimeframes" class="small-btn" style="font-size: 11px; padding: 4px 8px;"
                                    onclick="window.ultimateTradingSystem.selectAllTimeframes()">
                                Select All
                            </button>
                            <button id="unselectAllTimeframes" class="small-btn" style="font-size: 11px; padding: 4px 8px;"
                                    onclick="window.ultimateTradingSystem.unselectAllTimeframes()">
                                Unselect All
                            </button>
                        </div>
                    </div>
                    <div id="timeframeConsensusInfo" style="font-size: 10px; color: var(--mt5-text-secondary); margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; display: ${this.config.activeTimeframes.length > 1 ? 'block' : 'none'};">
                        <i class="fas fa-info-circle"></i> Consensus mode enabled: Signals require agreement across selected timeframes
                    </div>
                </div>
            </div>
            
            <!-- Instrument Selection with Groups -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-line"></i> Trading Instruments
                </div>
                <div style="display: flex; gap: 4px; margin-bottom: 12px; background: rgba(0,0,0,0.1); padding: 4px; border-radius: 6px;">
                    ${Object.entries(this.config.instrumentGroups).map(([group, symbols]) => `
                        <button class="group-btn ${this.config.selectedSymbols.some(s => symbols.includes(s)) ? 'active' : ''}" 
                                data-group="${group}" style="flex: 1; padding: 6px; font-size: 11px; border-radius: 4px; background: transparent; border: none; color: var(--mt5-text-secondary); cursor: pointer;">
                            ${group}
                        </button>
                    `).join('')}
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; max-height: 200px; overflow-y: auto;">
                    ${this.config.symbols.map(symbol => `
                        <label class="instrument-selector" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--mt5-bg-tertiary); border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                            <input type="checkbox" class="instrument-checkbox" value="${symbol}" ${this.config.selectedSymbols.includes(symbol) ? 'checked' : ''} style="display: none;">
                            <div class="instrument-checkbox-visual" style="width: 16px; height: 16px; border: 2px solid var(--mt5-border); border-radius: 3px; background: ${this.config.selectedSymbols.includes(symbol) ? 'var(--mt5-accent-teal)' : 'transparent'}; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                ${this.config.selectedSymbols.includes(symbol) ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                            </div>
                            <span style="font-size: 13px; color: var(--mt5-text-primary); flex: 1; font-weight: 500;">${symbol}</span>
                            <div class="instrument-status" style="width: 8px; height: 8px; border-radius: 50%; background: ${this.config.selectedSymbols.includes(symbol) ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};"></div>
                        </label>
                    `).join('')}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button id="selectAllInstruments" class="bot-control-btn" style="font-size: 12px; padding: 8px;">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button id="clearInstruments" class="bot-control-btn" style="font-size: 12px; padding: 8px;">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Risk Management -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-shield-alt"></i> Risk Management
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="risk-control">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 12px; color: var(--mt5-text-secondary); font-weight: 500;">Risk per Trade</span>
                            <span style="font-size: 12px; font-weight: 700; color: var(--mt5-accent-teal);" id="riskValue">${(this.config.riskManagement.riskPerTrade * 100).toFixed(1)}%</span>
                        </div>
                        <input type="range" id="riskSlider" min="0.1" max="5" step="0.1" value="${this.config.riskManagement.riskPerTrade * 100}" style="width: 100%;">
                    </div>
                    
                    <div class="risk-control">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 12px; color: var(--mt5-text-secondary); font-weight: 500;">Max Daily Loss</span>
                            <span style="font-size: 12px; font-weight: 700; color: var(--mt5-accent-teal);" id="maxDailyLossValue">${(this.config.riskManagement.maxDailyLoss * 100).toFixed(1)}%</span>
                        </div>
                        <input type="range" id="maxDailyLossSlider" min="1" max="10" step="0.5" value="${this.config.riskManagement.maxDailyLoss * 100}" style="width: 100%;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="font-size: 11px; color: var(--mt5-text-secondary); display: block; margin-bottom: 4px;">Max Trades</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="counter-btn" data-target="maxConcurrentTrades" data-change="-1" style="width: 28px; height: 28px; padding: 0; font-size: 14px; border-radius: 50%; background: var(--mt5-bg-tertiary); border: 1px solid var(--mt5-border); color: var(--mt5-text-primary); cursor: pointer;">-</button>
                                <span id="maxConcurrentTradesValue" style="min-width: 30px; text-align: center; font-weight: 700;">${this.config.riskManagement.maxConcurrentTrades}</span>
                                <button class="counter-btn" data-target="maxConcurrentTrades" data-change="1" style="width: 28px; height: 28px; padding: 0; font-size: 14px; border-radius: 50%; background: var(--mt5-bg-tertiary); border: 1px solid var(--mt5-border); color: var(--mt5-text-primary); cursor: pointer;">+</button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--mt5-text-secondary); display: block; margin-bottom: 4px;">Same Symbol</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="counter-btn" data-target="maxSameSymbol" data-change="-1" style="width: 28px; height: 28px; padding: 0; font-size: 14px; border-radius: 50%; background: var(--mt5-bg-tertiary); border: 1px solid var(--mt5-border); color: var(--mt5-text-primary); cursor: pointer;">-</button>
                                <span id="maxSameSymbolValue" style="min-width: 30px; text-align: center; font-weight: 700;">${this.config.riskManagement.maxSameSymbolTrades}</span>
                                <button class="counter-btn" data-target="maxSameSymbol" data-change="1" style="width: 28px; height: 28px; padding: 0; font-size: 14px; border-radius: 50%; background: var(--mt5-bg-tertiary); border: 1px solid var(--mt5-border); color: var(--mt5-text-primary); cursor: pointer;">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="trailingStopCheckbox" ${this.config.riskManagement.trailingStop ? 'checked' : ''} style="display: none;">
                            <div style="width: 16px; height: 16px; border: 2px solid var(--mt5-border); border-radius: 3px; background: ${this.config.riskManagement.trailingStop ? 'var(--mt5-accent-teal)' : 'transparent'}; display: flex; align-items: center; justify-content: center;">
                                ${this.config.riskManagement.trailingStop ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                            </div>
                            <span style="font-size: 12px; color: var(--mt5-text-primary);">Enable Trailing Stop</span>
                        </label>
                        
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="partialTPCheckbox" ${this.config.riskManagement.partialTakeProfit ? 'checked' : ''} style="display: none;">
                            <div style="width: 16px; height: 16px; border: 2px solid var(--mt5-border); border-radius: 3px; background: ${this.config.riskManagement.partialTakeProfit ? 'var(--mt5-accent-teal)' : 'transparent'}; display: flex; align-items: center; justify-content: center;">
                                ${this.config.riskManagement.partialTakeProfit ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                            </div>
                            <span style="font-size: 12px; color: var(--mt5-text-primary);">Partial Take Profit</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Position Size Calculator (NEW) -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calculator"></i> Position Size Calculator
                </div>
                <div style="background: linear-gradient(135deg, #1a237e, #283593); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Risk Amount</span>
                        <span style="font-size: 16px; font-weight: 800; color: white;">$${(this.currentAccount.equity * this.config.riskManagement.riskPerTrade).toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Risk % of Account</span>
                        <span style="font-size: 16px; font-weight: 800; color: white;">${(this.config.riskManagement.riskPerTrade * 100).toFixed(1)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Calculated Lots</span>
                        <span style="font-size: 20px; font-weight: 800; color: var(--mt5-accent-teal);">${this.positionSizeCalculator.calculatedLots.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Max Loss</span>
                        <span style="font-size: 14px; font-weight: 700; color: var(--mt5-accent-red);">$${this.positionSizeCalculator.maxLoss.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Trade Timing Statistics (NEW) -->
            <div>
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-hourglass-half"></i> Trade Timing Statistics
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-green);">
                        <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 4px;">TP Hit</div>
                        <div style="font-size: 18px; font-weight: 800; color: var(--mt5-accent-green);">${this.tradeTiming.dependentTP}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.6);">Dependent Take Profit</div>
                    </div>
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-red);">
                        <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 4px;">SL Hit</div>
                        <div style="font-size: 18px; font-weight: 800; color: var(--mt5-accent-red);">${this.tradeTiming.dependentSL}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.6);">Dependent Stop Loss</div>
                    </div>
                    <div style="grid-column: span 2; background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-yellow);">
                        <div style="font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 4px;">Manual Exits</div>
                        <div style="font-size: 18px; font-weight: 800; color: var(--mt5-accent-yellow);">${this.tradeTiming.manualExits}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.6);">Manual trade closure</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Dashboard -->
            <div style="margin-top: auto;">
                <div class="section-title" style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-tachometer-alt"></i> Performance
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div class="performance-card" style="background: linear-gradient(135deg, #1a237e, #283593); padding: 12px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 6px;">Win Rate</div>
                        <div id="winRateDisplay" style="font-size: 18px; font-weight: 800; color: white;">0%</div>
                    </div>
                    <div class="performance-card" style="background: linear-gradient(135deg, #1b5e20, #2e7d32); padding: 12px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 6px;">Total Profit</div>
                        <div id="totalProfitDisplay" style="font-size: 18px; font-weight: 800; color: white;">$0.00</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                    <div class="performance-card" style="background: var(--mt5-bg-tertiary); padding: 10px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">Total Trades</div>
                        <div id="totalTradesDisplay" style="font-size: 14px; font-weight: 700; color: var(--mt5-text-primary);">0</div>
                    </div>
                    <div class="performance-card" style="background: var(--mt5-bg-tertiary); padding: 10px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 10px; color: var(--mt5-text-secondary);">Active Trades</div>
                        <div id="activeTradesCountDisplay" style="font-size: 14px; font-weight: 700; color: var(--mt5-accent-yellow);">0</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--mt5-text-secondary); padding: 8px 0; border-top: 1px solid var(--mt5-border);">
                    <span>Equity: <strong style="color: var(--mt5-accent-teal);">$${this.account.equity.toFixed(2)}</strong></span>
                    <span>Free Margin: <strong style="color: ${this.account.freeMargin > 1000 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">$${this.account.freeMargin.toFixed(2)}</strong></span>
                </div>
            </div>
        `;
    }
    
    getEnhancedTradingPanelHTML() {
        return `
            <!-- Trading Tabs -->
            <div style="display: flex; background: linear-gradient(135deg, var(--mt5-bg-tertiary) 0%, #1a1f2e 100%); border-bottom: 1px solid var(--mt5-border);">
                <button class="bot-tab active" data-tab="signals" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid var(--mt5-accent-teal); color: var(--mt5-text-primary); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-bell"></i> Trading Signals
                </button>
                <button class="bot-tab" data-tab="trades" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--mt5-text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-line"></i> Active Trades
                </button>
                <button class="bot-tab" data-tab="history" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--mt5-text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-history"></i> Trade History
                </button>
                <button class="bot-tab" data-tab="analytics" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--mt5-text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-bar"></i> Analytics
                </button>
                <div style="flex: 1; display: flex; justify-content: flex-end; align-items: center; padding-right: 20px; gap: 12px;">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-filter"></i> Filter:
                    </div>
                    <select id="symbolFilter" style="font-size: 12px; padding: 6px 12px; background: var(--mt5-bg-secondary); color: var(--mt5-text-primary); border: 1px solid var(--mt5-border); border-radius: 4px; min-width: 120px;">
                        <option value="all">All Instruments</option>
                        ${this.config.symbols.map(symbol => `<option value="${symbol}">${symbol}</option>`).join('')}
                    </select>
                </div>
            </div>
            
            <!-- Signals Panel -->
            <div id="botSignalsContent" class="bot-tab-content" style="flex: 1; overflow-y: auto; padding: 20px; display: block;">
                <div id="signalsHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--mt5-border);">
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--mt5-text-primary); margin-bottom: 4px;">
                            <i class="fas fa-lightbulb"></i> AI Trading Signals
                        </div>
                        <div style="font-size: 12px; color: var(--mt5-text-secondary);">
                            Select signals to execute. Confidence â‰¥ ${Math.round(this.config.signalFilters.minConfidence * 100)}% required.
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="executeSelectedBtn" class="small-btn" style="background: var(--mt5-accent-teal); color: white; font-weight: 600;">
                            <i class="fas fa-play-circle"></i> Execute Selected
                        </button>
                        <button id="selectAllSignals" class="small-btn">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button id="clearSignals" class="small-btn">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div id="tradingSignalsList" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            
            <!-- Active Trades Panel -->
            <div id="botTradesContent" class="bot-tab-content" style="flex: 1; overflow-y: auto; padding: 20px; display: none;">
                <div id="tradesHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--mt5-border);">
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--mt5-text-primary); margin-bottom: 4px;">
                            <i class="fas fa-chart-line"></i> Active Trades Monitor
                        </div>
                        <div style="font-size: 12px; color: var(--mt5-text-secondary);">
                            ${this.trading.activeTrades.length} active trades
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="closeSelectedBtn" class="small-btn" style="background: rgba(244, 67, 54, 0.2); color: var(--mt5-accent-red); border: 1px solid var(--mt5-accent-red);">
                            <i class="fas fa-times-circle"></i> Close Selected
                        </button>
                        <button id="closeAllBtn" class="small-btn" style="background: rgba(244, 67, 54, 0.2); color: var(--mt5-accent-red); border: 1px solid var(--mt5-accent-red);">
                            <i class="fas fa-times"></i> Close All
                        </button>
                    </div>
                </div>
                <div id="activeTradesList" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            
            <!-- History Panel -->
            <div id="botHistoryContent" class="bot-tab-content" style="flex: 1; overflow-y: auto; padding: 20px; display: none;">
                <div id="historyHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--mt5-border);">
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--mt5-text-primary); margin-bottom: 4px;">
                            <i class="fas fa-history"></i> Trade History
                        </div>
                        <div style="font-size: 12px; color: var(--mt5-text-secondary);">
                            Last ${Math.min(20, this.trading.tradeHistory.length)} of ${this.trading.tradeHistory.length} trades
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="exportHistory" class="small-btn" style="background: var(--mt5-accent-blue); color: white;">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button id="clearHistory" class="small-btn">
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                </div>
                <div id="tradeHistoryList" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            
            <!-- Analytics Panel -->
            <div id="botAnalyticsContent" class="bot-tab-content" style="flex: 1; overflow-y: auto; padding: 20px; display: none;">
                <div id="analyticsHeader" style="margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: 700; color: var(--mt5-text-primary); margin-bottom: 4px;">
                        <i class="fas fa-chart-bar"></i> Trading Analytics
                    </div>
                    <div style="font-size: 12px; color: var(--mt5-text-secondary);">
                        Performance metrics and strategy analysis
                    </div>
                </div>
                <div id="analyticsContent"></div>
            </div>
            
            <!-- Status Bar -->
            <div style="border-top: 1px solid var(--mt5-border); padding: 12px 20px; background: var(--mt5-bg-tertiary); display: flex; justify-content: space-between; align-items: center;">
                <div id="statusMessage" style="font-size: 12px; color: var(--mt5-text-secondary); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-info-circle"></i> Ready to start trading. Select instruments and strategies first.
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="selectedCount" style="font-size: 11px; color: var(--mt5-text-secondary); display: none; background: var(--mt5-bg-secondary); padding: 4px 10px; border-radius: 12px;">
                        <i class="fas fa-check-circle"></i> <span id="selectedCountValue">0</span> selected
                    </div>
                    <div id="executionModeBadge" class="mode-badge" style="font-size: 11px; padding: 4px 12px; border-radius: 12px; font-weight: 600; background: rgba(255, 193, 7, 0.2); color: var(--mt5-accent-yellow); border: 1px solid var(--mt5-accent-yellow);">
                        MANUAL EXECUTION
                    </div>
                </div>
            </div>
        `;
    }
    
    // ==================== ENHANCED STYLES ====================
    
    addEnhancedStyles() {
        if (document.getElementById('ultimate-trading-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'ultimate-trading-styles';
        style.textContent = `
            /* Ultimate Trading System Styles */
            .ultimate-trading-system {
                font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            }
            
            /* Professional Cards */
            .dashboard-card {
                background: var(--mt5-bg-secondary);
                border-radius: 12px;
                border: 1px solid var(--mt5-border);
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .dashboard-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            
            .card-header {
                background: rgba(0,0,0,0.2);
                padding: 16px 20px;
                border-bottom: 1px solid var(--mt5-border);
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                color: var(--mt5-text-primary);
            }
            
            .card-content {
                padding: 20px;
            }
            
            /* Enhanced Buttons */
            .bot-control-btn {
                padding: 10px 16px;
                background: var(--mt5-bg-tertiary);
                border: 1px solid var(--mt5-border);
                border-radius: 8px;
                color: var(--mt5-text-primary);
                font-size: 13px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s;
                font-weight: 500;
            }
            
            .bot-control-btn:hover:not(:disabled) {
                background: var(--mt5-bg-secondary);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
            
            .bot-control-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .small-btn {
                padding: 8px 16px;
                background: var(--mt5-bg-tertiary);
                border: 1px solid var(--mt5-border);
                border-radius: 6px;
                color: var(--mt5-text-primary);
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .small-btn:hover {
                background: var(--mt5-bg-secondary);
                transform: translateY(-1px);
            }
            
            /* Quick Action Buttons */
            .quick-action-trade-btn {
                padding: 8px 12px;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                white-space: nowrap;
                min-width: 80px;
            }
            
            .quick-action-trade-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                filter: brightness(1.1);
            }
            
            .quick-action-trade-btn:active {
                transform: translateY(0);
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            }
            
            /* Button-specific colors */
            .quick-action-trade-btn[data-action="buy"] {
                background: var(--mt5-accent-green) !important;
                color: white !important;
            }
            
            .quick-action-trade-btn[data-action="sell"] {
                background: var(--mt5-accent-red) !important;
                color: white !important;
            }
            
            .quick-action-trade-btn[data-action="closeSelected"] {
                background: var(--mt5-accent-yellow) !important;
                color: white !important;
            }
            
            .quick-action-trade-btn[data-action="closeAll"] {
                background: var(--mt5-accent-orange) !important;
                color: white !important;
            }
            
            .quick-action-trade-btn[data-action="moveToBreakeven"] {
                background: var(--mt5-accent-teal) !important;
                color: white !important;
            }
            
            .quick-action-trade-btn[data-action="enableTrailing"] {
                background: var(--mt5-accent-purple) !important;
                color: white !important;
            }
            
            /* Scrollable Quick Actions Container */
            .quick-actions-container {
                scrollbar-width: thin;
                scrollbar-color: var(--mt5-accent-teal) transparent;
            }
            
            .quick-actions-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .quick-actions-container::-webkit-scrollbar-track {
                background: transparent;
                border-radius: 3px;
            }
            
            .quick-actions-container::-webkit-scrollbar-thumb {
                background: var(--mt5-accent-teal);
                border-radius: 3px;
            }
            
            .quick-actions-container::-webkit-scrollbar-thumb:hover {
                background: var(--mt5-accent-blue);
            }
            
            /* Professional Strategy Control Panel */
            .strategy-control-panel {
                background: linear-gradient(135deg, rgba(26, 31, 46, 0.8), rgba(30, 40, 60, 0.8));
                border: 1px solid var(--mt5-border);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }
            
            .strategy-control-item {
                background: rgba(0,0,0,0.2);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                padding: 12px 16px;
                transition: all 0.3s ease;
            }
            
            .strategy-control-item:hover {
                background: rgba(0,0,0,0.3);
                border-color: rgba(255,255,255,0.2);
                transform: translateY(-2px);
            }
            
            .strategy-toggle-switch {
                cursor: pointer;
            }
            
            .strategy-toggle-slider {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
                background: var(--mt5-border);
                border-radius: 13px;
                transition: all 0.3s;
                cursor: pointer;
            }
            
            .strategy-toggle-slider:before {
                content: '';
                position: absolute;
                top: 3px;
                left: 3px;
                width: 20px;
                height: 20px;
                background: white;
                border-radius: 50%;
                transition: all 0.3s;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            
            .strategy-toggle-input:checked + .strategy-toggle-slider {
                background: var(--mt5-accent-teal);
            }
            
            .strategy-toggle-input:checked + .strategy-toggle-slider:before {
                transform: translateX(24px);
            }
            
            .strategy-action-btn {
                padding: 10px 16px;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            .strategy-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
            
            /* Group Buttons */
            .group-btn {
                transition: all 0.2s;
            }
            
            .group-btn.active {
                background: var(--mt5-accent-teal) !important;
                color: white !important;
            }
            
            /* Timeframe Selector */
            .timeframe-label {
                transition: all 0.2s ease;
                cursor: pointer;
            }
            
            .timeframe-label:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            
            /* Sliders */
            input[type="range"] {
                -webkit-appearance: none;
                height: 6px;
                background: var(--mt5-border);
                border-radius: 3px;
                outline: none;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--mt5-accent-teal);
                cursor: pointer;
                border: 2px solid white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }
            
            /* Animations */
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            /* Tab Content */
            .bot-tab-content {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            
            .bot-tab-content.active {
                display: block;
            }
            
            /* Signal Cards */
            .signal-card {
                animation: fadeIn 0.3s ease;
                transition: all 0.2s;
            }
            
            .signal-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }
            
            /* Trade Cards */
            .trade-card {
                animation: fadeIn 0.3s ease;
                transition: all 0.2s;
            }
            
            .trade-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }
            
            /* Strategy Status Indicators */
            .strategy-status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 10px;
            }
            
            .strategy-status-indicator.active {
                background: var(--mt5-accent-green);
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            }
            
            .strategy-status-indicator.inactive {
                background: var(--mt5-accent-red);
            }
            
            /* NEW: Confidence Level Tooltip */
            .confidence-tooltip {
                position: relative;
                display: inline-block;
                cursor: help;
            }
            
            .confidence-tooltip .tooltiptext {
                visibility: hidden;
                width: 280px;
                background: linear-gradient(135deg, #1e1e2e, #2a2a3a);
                color: #fff;
                text-align: left;
                border-radius: 6px;
                padding: 12px 16px;
                position: absolute;
                z-index: 100;
                bottom: 125%;
                left: 50%;
                margin-left: -140px;
                opacity: 0;
                transition: opacity 0.3s;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                border-left: 4px solid var(--mt5-accent-teal);
                font-size: 12px;
                line-height: 1.5;
            }
            
            .confidence-tooltip:hover .tooltiptext {
                visibility: visible;
                opacity: 1;
            }
            
            /* NEW: Economic Calendar Event */
            .calendar-event {
                transition: all 0.2s;
            }
            
            .calendar-event:hover {
                transform: translateX(2px);
                background: rgba(0,0,0,0.2) !important;
            }
            
            /* NEW: Account Selector */
            .account-selector-item {
                transition: all 0.2s;
            }
            
            .account-selector-item:hover {
                background: rgba(0, 180, 160, 0.1) !important;
            }
            
            .account-selector-item.active {
                border-left: 4px solid var(--mt5-accent-teal);
                background: rgba(0, 180, 160, 0.05);
            }
            
            /* Add these color definitions if not already present */
            :root {
                --mt5-accent-orange: #ff9800;
                --mt5-accent-purple: #9c27b0;
            }
        `;
        
        document.head.appendChild(style);
    }
    
    // ==================== EVENT LISTENERS ====================
    
    setupAdvancedEventListeners() {
        console.log('Setting up advanced event listeners...');
        
        // Use event delegation for dynamic content
        document.addEventListener('click', (e) => {
            // Instrument selection
            if (e.target.closest('.instrument-selector')) {
                this.handleInstrumentSelection(e);
            }
            
            // Group selection
            if (e.target.closest('.group-btn')) {
                this.handleGroupSelection(e);
            }
            
            // Strategy toggle switches - check for clicks on the toggle switch OR slider
            if (e.target.closest('.strategy-toggle-switch') || 
                e.target.closest('.strategy-toggle-slider') ||
                e.target.classList.contains('strategy-toggle-slider')) {
                this.handleStrategyToggle(e);
            }
            
            // Timeframe selection (handled via direct onclick now)
            
            // Quick Action Buttons
            if (e.target.closest('.quick-action-trade-btn')) {
                const btn = e.target.closest('.quick-action-trade-btn');
                const action = btn.dataset.action;
                this.handleQuickAction(action);
            }
            
            // Enable/disable all strategies buttons
            if (e.target.closest('#enableAllStrategies')) {
                this.enableAllStrategies();
            }
            
            if (e.target.closest('#disableAllStrategies')) {
                this.disableAllStrategies();
            }
            
            // Ultimate System button
            if (e.target.closest('#ultimateSystemBtn')) {
                this.showUltimateDashboard();
            }
            
            // Bot control buttons
            if (e.target.closest('#botStartBtn')) this.startBot();
            if (e.target.closest('#botPauseBtn')) this.pauseBot();
            if (e.target.closest('#botStopBtn')) this.stopBot();
            
            // Execute buttons
            if (e.target.closest('#executeSelectedBtn')) this.executeSelectedSignals();
            
            // Close buttons
            if (e.target.closest('#closeSelectedBtn')) this.closeSelectedTrades();
            if (e.target.closest('#closeAllBtn')) this.closeAllTrades();
            
            // Signal selection
            if (e.target.closest('#selectAllSignals')) this.selectAllSignals();
            if (e.target.closest('#clearSignals')) this.clearSignalSelection();
            
            // History buttons
            if (e.target.closest('#clearHistory')) this.clearTradeHistory();
            if (e.target.closest('#exportHistory')) this.exportTradeHistory();
            
            // Select all instruments
            if (e.target.closest('#selectAllInstruments')) this.selectAllInstruments();
            if (e.target.closest('#clearInstruments')) this.clearInstruments();
            
            // Counter buttons
            if (e.target.closest('.counter-btn')) {
                const btn = e.target.closest('.counter-btn');
                const target = btn.dataset.target;
                const change = parseInt(btn.dataset.change);
                this.adjustSetting(target, change);
            }
            
            // Tab switching
            if (e.target.closest('.bot-tab')) {
                const tab = e.target.closest('.bot-tab');
                const tabName = tab.dataset.tab;
                this.switchTab(tabName);
            }
            
            // Signal execute/ignore buttons
            if (e.target.closest('.signal-execute-btn')) {
                const btn = e.target.closest('.signal-execute-btn');
                const signalId = btn.dataset.signalId;
                const signal = this.tradingSignals.find(s => s.id === signalId);
                if (signal) {
                    // Check if it's Ibrahim Abu Strategy - use exact execution
                    if (signal.strategy === this.strategies.ibrahim.name) {
                        this.executeIbrahimAbuStrategy(signal);
                    } else {
                        this.executeTrade(signal);
                    }
                    this.removeSignal(signalId);
                }
            }
            
            if (e.target.closest('.signal-ignore-btn')) {
                const btn = e.target.closest('.signal-ignore-btn');
                const signalId = btn.dataset.signalId;
                this.removeSignal(signalId);
            }
            
            // NEW: Account switching
            if (e.target.closest('.account-selector-item')) {
                const item = e.target.closest('.account-selector-item');
                const accountId = item.dataset.accountId;
                this.switchAccount(accountId);
            }
            
            // NEW: Refresh calendar
            if (e.target.closest('#refreshCalendarBtn')) {
                this.refreshEconomicCalendar();
            }
            
            // NEW: Export calendar
            if (e.target.closest('#exportCalendarBtn')) {
                this.exportEconomicCalendar();
            }
            
            // NEW: Confidence level help buttons
            if (e.target.closest('.confidence-help-btn')) {
                const btn = e.target.closest('.confidence-help-btn');
                const level = btn.dataset.level;
                this.showConfidenceExplanation(level);
            }
            
            // NEW: Auto/Manual Execution Mode buttons in Ultimate Dashboard
            if (e.target.closest('#autoExecutionBtn')) {
                this.setExecutionMode('auto');
            }
            
            if (e.target.closest('#manualExecutionBtn')) {
                this.setExecutionMode('manual');
            }
        });
        
        // Input events
        document.addEventListener('input', (e) => {
            // Risk sliders
            if (e.target.id === 'riskSlider') {
                this.config.riskManagement.riskPerTrade = e.target.value / 100;
                this.config.riskPerTrade = e.target.value / 100; // Compatibility
                document.getElementById('riskValue').textContent = `${e.target.value}%`;
                
                // Recalculate position size
                if (this.config.selectedSymbols.length > 0) {
                    const symbol = this.config.selectedSymbols[0];
                    const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
                    const stopLoss = price * 0.99; // Example
                    this.calculatePositionSize(symbol, price, stopLoss, 'BUY');
                }
                
                this.updateStatusMessage(`Risk per trade updated to ${e.target.value}%`);
            }
            
            if (e.target.id === 'maxDailyLossSlider') {
                this.config.riskManagement.maxDailyLoss = e.target.value / 100;
                document.getElementById('maxDailyLossValue').textContent = `${e.target.value}%`;
                this.updateStatusMessage(`Max daily loss updated to ${e.target.value}%`);
            }
            
            // Strategy confidence sliders
            if (e.target.classList.contains('strategy-slider')) {
                const strategy = e.target.dataset.strategy;
                const value = e.target.value / 100;
                
                if (this.strategies[strategy]) {
                    this.strategies[strategy].confidence = value;
                    this.config.signalFilters.minConfidence = value;
                    this.updateStatusMessage(`${this.strategies[strategy].name} confidence set to ${e.target.value}%`);
                }
            }
        });
        
        // Change events for checkboxes
        document.addEventListener('change', (e) => {
            // Timeframe checkboxes
            if (e.target.classList.contains('timeframe-checkbox')) {
                this.updateTimeframeSelection(e.target.value, e.target.checked);
            }
            
            // Risk management checkboxes
            if (e.target.id === 'trailingStopCheckbox') {
                this.config.riskManagement.trailingStop = e.target.checked;
                this.updateStatusMessage(`Trailing stop ${e.target.checked ? 'enabled' : 'disabled'}`);
            }
            
            if (e.target.id === 'partialTPCheckbox') {
                this.config.riskManagement.partialTakeProfit = e.target.checked ? [0.5, 0.5] : null;
                this.updateStatusMessage(`Partial take profit ${e.target.checked ? 'enabled' : 'disabled'}`);
            }
            
            // NEW: Ibrahim Abu Strategy exact execution toggle
            if (e.target.id === 'ibrahimExactExecution') {
                this.strategies.ibrahim.exactExecution.enabled = e.target.checked;
                this.updateStatusMessage(`Ibrahim Abu Strategy exact execution ${e.target.checked ? 'enabled' : 'disabled'}`);
            }
        });
        
        // Window events
        window.addEventListener('keydown', (e) => {
            // Keyboard shortcuts
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b': // Ctrl+B for quick buy
                        e.preventDefault();
                        this.showQuickTradeDialog('BUY');
                        break;
                    case 's': // Ctrl+S for quick sell
                        e.preventDefault();
                        this.showQuickTradeDialog('SELL');
                        break;
                    case 'p': // Ctrl+P to pause/resume
                        e.preventDefault();
                        this.pauseBot();
                        break;
                    case 'u': // Ctrl+U for ultimate dashboard
                        e.preventDefault();
                        this.showUltimateDashboard();
                        break;
                }
            }
            
            // Function keys
            switch(e.key) {
                case 'F9':
                    e.preventDefault();
                    this.startBot();
                    break;
                case 'F12':
                    e.preventDefault();
                    this.stopBot();
                    break;
            }
        });
        
        console.log('Advanced event listeners setup complete');
    }
    
    // ==================== MULTI-TIMEFRAME METHODS ====================
    
    handleTimeframeSelection(e) {
        console.log('Handling timeframe selection...');
        const label = e.target.closest('.timeframe-label');
        if (!label) return;
        
        const checkboxId = label.htmlFor;
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        
        checkbox.checked = !checkbox.checked;
        this.updateTimeframeSelection(checkbox.value, checkbox.checked);
        
        // Prevent default to avoid any issues
        e.preventDefault();
        e.stopPropagation();
    }
    
    updateTimeframeSelection(timeframe, isSelected) {
        console.log(`Updating timeframe ${timeframe} to ${isSelected ? 'selected' : 'unselected'}`);
        
        // Update config
        if (isSelected && !this.config.activeTimeframes.includes(timeframe)) {
            this.config.activeTimeframes.push(timeframe);
        } else if (!isSelected && this.config.activeTimeframes.includes(timeframe)) {
            const index = this.config.activeTimeframes.indexOf(timeframe);
            if (index > -1) {
                this.config.activeTimeframes.splice(index, 1);
            }
        }
        
        console.log('Active timeframes:', this.config.activeTimeframes);
        
        // Force UI update immediately
        this.updateTimeframeUI();
        
        // Update status message with sorted timeframe list
        this.updateTimeframeStatusMessage();
        
        // Save preferences
        this.savePreferences();
    }
    
    updateTimeframeUI() {
        // Update all timeframe labels
        const timeframes = ['M5', 'M15', 'H1', 'H4', 'D1'];
        
        timeframes.forEach(tf => {
            const isSelected = this.config.activeTimeframes.includes(tf);
            const labelId = `tf${tf.replace(/\d+/, '')}`;
            const label = document.querySelector(`label[for="${labelId}"]`);
            
            if (label) {
                console.log(`Updating ${tf} label: selected=${isSelected}`);
                label.style.background = isSelected ? 'var(--mt5-accent-green)' : 'var(--mt5-bg-secondary)';
                label.style.borderColor = isSelected ? 'var(--mt5-accent-green)' : 'var(--mt5-border)';
                label.style.color = isSelected ? 'white' : 'var(--mt5-text-primary)';
            }
            
            // Update checkbox
            const checkbox = document.getElementById(labelId);
            if (checkbox) {
                checkbox.checked = isSelected;
            }
        });
        
        // Update count
        const countElement = document.getElementById('selectedTimeframesCount');
        if (countElement) {
            countElement.textContent = this.config.activeTimeframes.length;
        }
        
        // Show/hide consensus info
        const consensusInfo = document.getElementById('timeframeConsensusInfo');
        if (consensusInfo) {
            consensusInfo.style.display = this.config.activeTimeframes.length > 1 ? 'block' : 'none';
        }
    }
    
    selectAllTimeframes() {
        console.log('Selecting all timeframes...');
        const allTimeframes = ['M5', 'M15', 'H1', 'H4', 'D1'];
        this.config.activeTimeframes = [...allTimeframes];
        
        // Update UI
        this.updateTimeframeUI();
        
        this.updateStatusMessage('Multi-timeframe: All timeframes selected');
        this.savePreferences();
    }
    
    unselectAllTimeframes() {
        console.log('Unselecting all timeframes...');
        this.config.activeTimeframes = [];
        
        // Update UI
        this.updateTimeframeUI();
        
        this.updateStatusMessage('Multi-timeframe: No timeframes selected');
        this.savePreferences();
    }
    
    updateTimeframeStatusMessage() {
        // Sort timeframes in the order: H1, H4, D1, M5, M15
        const sortedTimeframes = [...this.config.activeTimeframes].sort((a, b) => {
            const order = ['H1', 'H4', 'D1', 'M5', 'M15'];
            return order.indexOf(a) - order.indexOf(b);
        });
        
        if (sortedTimeframes.length === 0) {
            this.updateStatusMessage('Multi-timeframe: No timeframes selected');
        } else if (sortedTimeframes.length === 5) {
            this.updateStatusMessage('Multi-timeframe: All timeframes selected');
        } else {
            this.updateStatusMessage(`Multi-timeframe: ${sortedTimeframes.join(', ')}`);
        }
    }
    
    // ==================== QUICK ACTION METHODS ====================
    
    handleQuickAction(action) {
        switch(action) {
            case 'buy':
                this.executeQuickTrade('BUY');
                break;
            case 'sell':
                this.executeQuickTrade('SELL');
                break;
            case 'closeSelected':
                this.closeSelectedTrades();
                break;
            case 'closeAll':
                this.closeAllTrades();
                break;
            case 'moveToBreakeven':
                this.moveToBreakeven();
                break;
            case 'enableTrailing':
                this.enableTrailingForSelected();
                break;
        }
    }
    
    executeQuickTrade(direction) {
        if (this.config.selectedSymbols.length === 0) {
            this.showAdvancedNotification('Warning', 'No Instrument Selected', 'warning');
            return;
        }
        
        const symbol = this.config.selectedSymbols[0];
        const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
        
        // Calculate position size based on risk
        const stopLoss = direction === 'BUY' ? price * 0.995 : price * 1.005;
        const volume = this.calculatePositionSize(symbol, price, stopLoss, direction);
        
        // Ask for confirmation
        const confirmed = confirm(`Execute ${direction} ${symbol} at ${price.toFixed(5)}?\nVolume: ${volume.toFixed(2)} lots\nRisk: $${this.positionSizeCalculator.riskAmount.toFixed(2)} (${this.positionSizeCalculator.accountRisk}%)`);
        if (!confirmed) return;
        
        const signal = {
            id: `QUICK_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
            strategy: 'Quick Manual Trade',
            symbol: symbol,
            direction: direction,
            entryPrice: price,
            stopLoss: stopLoss,
            takeProfit: direction === 'BUY' ? [price * 1.01, price * 1.02] : [price * 0.99, price * 0.98],
            confidence: 1.0,
            timestamp: new Date(),
            reason: 'Manual quick trade execution',
            volume: volume
        };
        
        // Show trade execution animation
        this.showTradeExecution({
            direction: direction,
            symbol: symbol,
            entryPrice: price,
            strategy: 'Quick Trade',
            volume: volume
        });
        
        // Execute the trade
        setTimeout(() => {
            this.executeTrade(signal);
        }, 500);
    }
    
    moveToBreakeven() {
        if (this.selectedTrades.size === 0) {
            const confirmed = confirm('No trades selected. Move ALL trades to breakeven?');
            if (!confirmed) return;
            
            // Move all active trades to breakeven
            this.trading.activeTrades.forEach(trade => {
                this.moveTradeToBreakeven(trade.id);
            });
        } else {
            // Move selected trades to breakeven
            Array.from(this.selectedTrades).forEach(tradeId => {
                this.moveTradeToBreakeven(tradeId);
            });
        }
        
        this.showAdvancedNotification('Breakeven', 'Stop losses moved to entry price', 'success');
    }
    
    moveTradeToBreakeven(tradeId) {
        const tradeIndex = this.trading.activeTrades.findIndex(t => t.id === tradeId);
        if (tradeIndex === -1) return;
        
        const trade = this.trading.activeTrades[tradeIndex];
        
        // Move stop loss to entry price (breakeven)
        trade.stopLoss = trade.entryPrice;
        
        // Show notification for this specific trade
        this.showAdvancedNotification(
            'Trade Modified',
            `${trade.direction} ${trade.symbol} moved to breakeven at ${trade.entryPrice.toFixed(5)}`,
            'info',
            { duration: 3000 }
        );
        
        // Update display
        this.updateActiveTradesDisplay();
    }
    
    enableTrailingForSelected() {
        if (this.selectedTrades.size === 0) {
            const confirmed = confirm('No trades selected. Enable trailing stop for ALL trades?');
            if (!confirmed) return;
            
            // Enable trailing for all active trades
            this.trading.activeTrades.forEach(trade => {
                this.enableTradeTrailing(trade.id);
            });
        } else {
            // Enable trailing for selected trades
            Array.from(this.selectedTrades).forEach(tradeId => {
                this.enableTradeTrailing(tradeId);
            });
        }
        
        this.showAdvancedNotification('Trailing Stop', 'Trailing stop enabled', 'success');
    }
    
    enableTradeTrailing(tradeId) {
        const tradeIndex = this.trading.activeTrades.findIndex(t => t.id === tradeId);
        if (tradeIndex === -1) return;
        
        const trade = this.trading.activeTrades[tradeIndex];
        
        // Enable trailing stop
        trade.trailingStop = true;
        trade.trailingDistance = this.config.riskManagement.trailingDistance || 0.002;
        
        // Show notification for this specific trade
        this.showAdvancedNotification(
            'Trade Modified',
            `Trailing stop enabled for ${trade.direction} ${trade.symbol}`,
            'info',
            { duration: 3000 }
        );
        
        // Update display
        this.updateActiveTradesDisplay();
    }
    
    handleStrategyToggle(e) {
        // Prevent event from bubbling to parent elements
        e.stopPropagation();
        
        // Find the closest toggle switch or slider
        const toggleSwitch = e.target.closest('.strategy-toggle-switch');
        const toggleSlider = e.target.closest('.strategy-toggle-slider');
        
        // Get the actual toggle element
        let targetElement;
        if (toggleSwitch) {
            targetElement = toggleSwitch;
        } else if (toggleSlider) {
            // If clicked directly on slider, find parent switch
            targetElement = toggleSlider.closest('.strategy-toggle-switch');
        }
        
        if (!targetElement) {
            console.log('No target element found for strategy toggle');
            return;
        }
        
        // Find the hidden checkbox
        const checkbox = targetElement.querySelector('.strategy-toggle-input');
        if (!checkbox) {
            console.log('No checkbox found in strategy toggle');
            return;
        }
        
        const strategyKey = checkbox.dataset.strategy;
        if (!strategyKey) {
            console.log('No strategy key found');
            return;
        }
        
        // Toggle the state
        const isChecked = !checkbox.checked;
        checkbox.checked = isChecked;
        
        // Update strategy state
        if (this.strategies[strategyKey]) {
            this.strategies[strategyKey].active = isChecked;
            
            // Update toggle visual
            const sliderElement = targetElement.querySelector('.strategy-toggle-slider');
            if (sliderElement) {
                sliderElement.style.background = isChecked ? this.strategies[strategyKey].color : 'var(--mt5-border)';
                const knob = sliderElement.querySelector('span');
                if (knob) {
                    knob.style.left = isChecked ? '23px' : '3px';
                }
            }
            
            // Update strategy status indicator
            const controlItem = targetElement.closest('.strategy-control-item');
            if (controlItem) {
                const statusIndicator = controlItem.querySelector('.strategy-status-indicator');
                if (statusIndicator) {
                    statusIndicator.style.background = isChecked ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)';
                }
            }
            
            // Update configuration panel
            this.updateStrategyConfigurationPanel();
            
            // Show notification
            this.showAdvancedNotification(
                'Strategy Updated',
                `${this.strategies[strategyKey].name} ${isChecked ? 'activated' : 'deactivated'}`,
                isChecked ? 'success' : 'warning'
            );
            
            // Update status message
            this.updateStatusMessage(`${this.strategies[strategyKey].name} ${isChecked ? 'activated' : 'deactivated'}`);
            
            // Play sound feedback
            if (this.ui.soundEnabled) {
                this.playToggleSound(isChecked);
            }
            
            // Log the change
            console.log(`${this.strategies[strategyKey].name} ${isChecked ? 'enabled' : 'disabled'}`);
        }
    }
    
    enableAllStrategies() {
        Object.keys(this.strategies).forEach(key => {
            this.strategies[key].active = true;
        });
        
        this.updateStrategyControlPanel();
        this.updateStrategyConfigurationPanel();
        this.showAdvancedNotification('All Strategies Enabled', 'All trading strategies are now active', 'success');
        this.updateStatusMessage('All strategies enabled');
    }
    
    disableAllStrategies() {
        Object.keys(this.strategies).forEach(key => {
            this.strategies[key].active = false;
        });
        
        this.updateStrategyControlPanel();
        this.updateStrategyConfigurationPanel();
        this.showAdvancedNotification('All Strategies Disabled', 'All trading strategies are now inactive', 'warning');
        this.updateStatusMessage('All strategies disabled');
    }
    
    updateStrategyControlPanel() {
        // Update all toggle switches in the control panel
        document.querySelectorAll('.strategy-toggle-input').forEach(checkbox => {
            const strategyKey = checkbox.dataset.strategy;
            const strategy = this.strategies[strategyKey];
            
            if (strategy) {
                checkbox.checked = strategy.active;
                
                const toggleSlider = checkbox.nextElementSibling;
                if (toggleSlider && toggleSlider.classList.contains('strategy-toggle-slider')) {
                    toggleSlider.style.background = strategy.active ? strategy.color : 'var(--mt5-border)';
                    const knob = toggleSlider.querySelector('span');
                    if (knob) {
                        knob.style.left = strategy.active ? '23px' : '3px';
                    }
                }
                
                // Update status indicator
                const controlItem = checkbox.closest('.strategy-control-item');
                if (controlItem) {
                    const statusIndicator = controlItem.querySelector('.strategy-status-indicator');
                    if (statusIndicator) {
                        statusIndicator.style.background = strategy.active ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)';
                    }
                }
            }
        });
    }
    
    updateStrategyConfigurationPanel() {
        // Update the configuration panel to reflect strategy status
        const strategyConfigs = document.querySelectorAll('.strategy-config');
        strategyConfigs.forEach(config => {
            const strategyNameElement = config.querySelector('div > div:first-child');
            if (!strategyNameElement) return;
            
            // Extract just the strategy name (remove icon HTML)
            const strategyName = strategyNameElement.textContent.trim();
            // Find strategy by name
            const strategyKey = Object.keys(this.strategies).find(key => 
                this.strategies[key].name === strategyName
            );
            
            if (!strategyKey) {
                // Try alternative method - look for any matching text
                const allText = strategyNameElement.innerHTML;
                Object.keys(this.strategies).forEach(key => {
                    if (allText.includes(this.strategies[key].name)) {
                        const strategy = this.strategies[key];
                        
                        // Update opacity based on active state
                        config.style.opacity = strategy.active ? '1' : '0.6';
                        
                        // Update status icon
                        const statusIcon = config.querySelector('i');
                        if (statusIcon) {
                            statusIcon.className = strategy.active ? 
                                'fas fa-play-circle' : 'fas fa-stop-circle';
                            statusIcon.style.color = strategy.active ? 
                                'var(--mt5-accent-green)' : 'var(--mt5-accent-red)';
                        }
                        
                        // Enable/disable confidence slider
                        const confidenceSlider = config.querySelector('input[type="range"]');
                        if (confidenceSlider) {
                            confidenceSlider.disabled = !strategy.active;
                        }
                    }
                });
            } else if (this.strategies[strategyKey]) {
                const strategy = this.strategies[strategyKey];
                
                // Update opacity based on active state
                config.style.opacity = strategy.active ? '1' : '0.6';
                
                // Update status icon
                const statusIcon = config.querySelector('i');
                if (statusIcon) {
                    statusIcon.className = strategy.active ? 
                        'fas fa-play-circle' : 'fas fa-stop-circle';
                    statusIcon.style.color = strategy.active ? 
                        'var(--mt5-accent-green)' : 'var(--mt5-accent-red)';
                }
                
                // Enable/disable confidence slider
                const confidenceSlider = config.querySelector('input[type="range"]');
                if (confidenceSlider) {
                    confidenceSlider.disabled = !strategy.active;
                }
            }
        });
    }
    
    playToggleSound(enabled) {
        // In a real implementation, this would play a sound
        console.log(`Playing toggle sound: ${enabled ? 'on' : 'off'}`);
    }
    
    handleInstrumentSelection(e) {
        const selector = e.target.closest('.instrument-selector');
        const checkbox = selector.querySelector('.instrument-checkbox');
        const symbol = checkbox.value;
        
        checkbox.checked = !checkbox.checked;
        
        // Update visual
        const visual = selector.querySelector('.instrument-checkbox-visual');
        const status = selector.querySelector('.instrument-status');
        
        if (checkbox.checked) {
            visual.style.background = 'var(--mt5-accent-teal)';
            visual.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>';
            status.style.background = 'var(--mt5-accent-green)';
            
            if (!this.config.selectedSymbols.includes(symbol)) {
                this.config.selectedSymbols.push(symbol);
            }
        } else {
            visual.style.background = 'transparent';
            visual.innerHTML = '';
            status.style.background = 'var(--mt5-accent-red)';
            
            const index = this.config.selectedSymbols.indexOf(symbol);
            if (index > -1) {
                this.config.selectedSymbols.splice(index, 1);
            }
        }
        
        // Update position size calculator with first selected symbol
        if (this.config.selectedSymbols.length > 0) {
            const firstSymbol = this.config.selectedSymbols[0];
            const price = this.marketData.prices[firstSymbol] || this.getBasePrice(firstSymbol);
            const stopLoss = price * 0.99; // Example
            this.calculatePositionSize(firstSymbol, price, stopLoss, 'BUY');
        }
        
        this.updateStatusMessage(`Selected instruments: ${this.config.selectedSymbols.join(', ')}`);
    }
    
    handleGroupSelection(e) {
        const btn = e.target.closest('.group-btn');
        const group = btn.dataset.group;
        const symbols = this.config.instrumentGroups[group] || [];
        
        // Update button state
        document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update instrument selection
        this.config.selectedSymbols = [...symbols];
        this.updateInstrumentSelection();
        
        // Update position size calculator with first symbol
        if (symbols.length > 0) {
            const firstSymbol = symbols[0];
            const price = this.marketData.prices[firstSymbol] || this.getBasePrice(firstSymbol);
            const stopLoss = price * 0.99; // Example
            this.calculatePositionSize(firstSymbol, price, stopLoss, 'BUY');
        }
        
        this.updateStatusMessage(`Selected ${group} group: ${symbols.join(', ')}`);
    }
    
    // ==================== BOT CONTROL METHODS ====================
    
    startBot() {
        console.log('ðŸš€ Starting Ultimate Trading System...');
        
        if (this.isRunning) return;
        
        if (this.config.selectedSymbols.length === 0) {
            this.showAdvancedNotification('Warning', 'No Instruments Selected', 'warning');
            return;
        }
        
        // Check if any strategies are active
        const activeStrategies = Object.values(this.strategies).filter(s => s.active);
        if (activeStrategies.length === 0) {
            this.showAdvancedNotification('Warning', 'No Strategies Active', 'warning');
            return;
        }
        
        this.isRunning = true;
        this.isPaused = false;
        this.botStatus = 'running';
        this.session.startTime = new Date();
        
        // Update UI
        this.updateBotStatus('RUNNING', 'var(--mt5-accent-green)');
        document.getElementById('botStartBtn').disabled = true;
        document.getElementById('botPauseBtn').disabled = false;
        document.getElementById('botStopBtn').disabled = false;
        document.getElementById('botStartBtn').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Running';
        
        // Show visual feedback
        this.showAdvancedNotification('System Starting', 'Market analysis initiated', 'success');
        this.log('ðŸ¤– ULTIMATE TRADING SYSTEM STARTED', 'success');
        
        // Start processes
        this.tradingLoopInterval = setInterval(() => this.tradingLoop(), this.config.updateInterval);
        
        // Show market scan
        setTimeout(() => this.showMarketScan(), 1000);
    }
    
    pauseBot() {
        console.log('Toggling pause...');
        
        if (!this.isRunning) return;
        
        if (this.isPaused) {
            // Resume
            this.isPaused = false;
            this.updateBotStatus('RUNNING', 'var(--mt5-accent-green)');
            document.getElementById('botPauseBtn').innerHTML = '<i class="fas fa-play"></i> Resume';
            this.showAdvancedNotification('System Resumed', 'Trading resumed', 'info');
            this.log('â–¶ï¸ SYSTEM RESUMED', 'success');
        } else {
            // Pause
            this.isPaused = true;
            this.updateBotStatus('PAUSED', 'var(--mt5-accent-yellow)');
            document.getElementById('botPauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';
            this.showAdvancedNotification('System Paused', 'All trading activities paused', 'warning');
            this.log('â¸ï¸ SYSTEM PAUSED', 'warning');
        }
    }
    
    stopBot() {
        console.log('ðŸ›‘ Stopping Ultimate Trading System...');
        
        this.isRunning = false;
        this.isPaused = false;
        this.botStatus = 'stopped';
        
        // Update UI
        this.updateBotStatus('STOPPED', 'var(--mt5-accent-red)');
        document.getElementById('botStartBtn').disabled = false;
        document.getElementById('botPauseBtn').disabled = true;
        document.getElementById('botStopBtn').disabled = true;
        document.getElementById('botStartBtn').innerHTML = '<i class="fas fa-play"></i> Start';
        document.getElementById('botPauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';
        
        // Clear intervals
        if (this.tradingLoopInterval) clearInterval(this.tradingLoopInterval);
        
        // Show feedback
        this.showAdvancedNotification('System Stopped', 'All processes terminated', 'info');
        this.log('ðŸ›‘ SYSTEM STOPPED', 'warning');
    }
    
    updateBotStatus(status, color) {
        const badge = document.getElementById('botStatusBadge');
        if (badge) {
            badge.innerHTML = `<span style="color: ${color}">â—</span> ${status}`;
        }
    }
    
    // ==================== ENHANCED TRADING METHODS ====================
    
    async tradingLoop() {
        if (this.isPaused || !this.isRunning) return;
        if (this.trading.activeTrades.length >= this.config.riskManagement.maxConcurrentTrades) return;
        
        try {
            // Analyze selected symbols with multi-timeframe analysis
            for (const symbol of this.config.selectedSymbols) {
                const analysis = await this.analyzeMultiTimeframe(symbol);
                
                if (analysis && analysis.confidence >= this.config.signalFilters.minConfidence) {
                    // Generate trading signals from each active strategy
                    for (const [key, strategy] of Object.entries(this.strategies)) {
                        if (strategy.active) {
                            const signal = await this.runStrategy(key, symbol, analysis);
                            if (signal && signal.confidence >= this.config.signalFilters.minConfidence) {
                                this.addTradingSignal(signal);
                                
                                // Auto-execute if confidence is high and auto mode is enabled
                                if (this.config.execution.mode === 'auto' && 
                                    signal.confidence >= this.config.execution.autoExecuteAbove) {
                                    
                                    // Check if it's Ibrahim Abu Strategy - use exact execution
                                    if (key === 'ibrahim' && this.strategies.ibrahim.exactExecution.enabled) {
                                        setTimeout(() => this.executeIbrahimAbuStrategy(signal), 500);
                                    } else {
                                        setTimeout(() => this.executeAdvancedOrder('market', signal), 500);
                                    }
                                }
                            }
                        }
                    }
                }
                
                await this.sleep(100);
            }
            
            // Update displays
            this.updateActiveTradesDisplay();
            this.updatePerformanceDisplay();
            
        } catch (error) {
            console.error('Error in trading loop:', error);
        }
    }
    
    async analyzeMultiTimeframe(symbol) {
        const analysis = {
            symbol: symbol,
            timeframes: {},
            consensus: null,
            confidence: 0,
            recommendation: null
        };
        
        // Only analyze selected timeframes
        for (const tf of this.config.activeTimeframes) {
            const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
            const trend = this.analyzeTrend(symbol, tf);
            const momentum = this.analyzeMomentum(symbol, tf);
            const volatility = this.marketData.volatility[symbol] || 0.002;
            
            analysis.timeframes[tf] = {
                trend: trend,
                momentum: momentum,
                volatility: volatility,
                support: this.calculateSupport(symbol, tf),
                resistance: this.calculateResistance(symbol, tf),
                score: this.calculateTimeframeScore(trend, momentum, volatility)
            };
        }
        
        // Generate consensus only if multiple timeframes are selected
        if (this.config.activeTimeframes.length > 1) {
            analysis.consensus = this.generateConsensus(analysis.timeframes);
            analysis.confidence = this.calculateConfidence(analysis.consensus);
            
            // Apply consensus enforcement: Only generate signals if there's agreement
            if (analysis.consensus.direction && analysis.consensus.confidence > 0.5) {
                analysis.recommendation = analysis.consensus.direction;
            } else {
                analysis.recommendation = null; // No consensus, no signal
            }
        } else {
            // Single timeframe mode - use that timeframe's analysis directly
            const tf = this.config.activeTimeframes[0];
            if (tf && analysis.timeframes[tf]) {
                analysis.consensus = {
                    direction: analysis.timeframes[tf].trend.direction,
                    confidence: analysis.timeframes[tf].score,
                    score: analysis.timeframes[tf].score
                };
                analysis.confidence = analysis.timeframes[tf].score;
                analysis.recommendation = analysis.timeframes[tf].trend.direction;
            }
        }
        
        return analysis;
    }
    
    async runStrategy(strategyKey, symbol, analysis) {
        // Check if strategy is active before running
        if (!this.strategies[strategyKey] || !this.strategies[strategyKey].active) {
            return null;
        }
        
        // Check if we have a consensus recommendation (only if multiple timeframes are selected)
        if (this.config.activeTimeframes.length > 1) {
            if (!analysis.recommendation || analysis.confidence < this.config.signalFilters.minConfidence) {
                return null; // No consensus or low confidence
            }
        }
        
        // Check for high-impact news if avoid news is enabled
        if (this.config.signalFilters.avoidNews) {
            const hasHighImpactNews = this.checkForHighImpactNews(symbol);
            if (hasHighImpactNews) {
                return null; // Avoid trading during high-impact news
            }
        }
        
        await this.sleep(50);
        
        const strategy = this.strategies[strategyKey];
        const price = this.marketData.prices[symbol];
        const trend = this.marketData.trends[symbol];
        
        // Base probability for signal generation
        if (Math.random() > 0.7) {
            let confidence = strategy.confidence * (0.8 + Math.random() * 0.4); // Vary confidence
            
            // Apply timeframe consensus to confidence
            if (this.config.activeTimeframes.length > 1) {
                // Boost confidence if multiple timeframes agree
                confidence *= (0.7 + analysis.consensus.confidence * 0.3);
            }
            
            if (confidence >= this.config.signalFilters.minConfidence) {
                // Use consensus direction if available, otherwise use trend
                const direction = analysis.recommendation || (trend === 'bullish' ? 'BUY' : 'SELL');
                
                const signal = {
                    id: `SIGNAL_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
                    strategy: strategy.name,
                    symbol: symbol,
                    direction: direction,
                    entryPrice: price,
                    stopLoss: this.calculateStopLoss(price, direction, strategyKey),
                    takeProfit: this.calculateTakeProfit(price, direction, strategyKey),
                    confidence: confidence,
                    timestamp: new Date(),
                    reason: this.getSignalReason(strategyKey, direction),
                    selected: false,
                    timeframeCount: this.config.activeTimeframes.length,
                    consensusStrength: analysis.consensus ? analysis.consensus.confidence : null
                };
                
                // Add to strategy signals
                strategy.signals.push(signal);
                if (strategy.signals.length > 100) strategy.signals.shift();
                
                return signal;
            }
        }
        
        return null;
    }
    
    // NEW: Check for high-impact news
    checkForHighImpactNews(symbol) {
        const now = new Date();
        const nextHour = new Date(now.getTime() + 3600000);
        
        return this.economicCalendar.events.some(event => {
            if (event.impact !== 'high') return false;
            
            const eventTime = new Date(event.date);
            const timeDiff = Math.abs(eventTime - now);
            
            // Check if event is within 1 hour and affects the symbol
            if (timeDiff <= 3600000) {
                const affectedSymbols = event.symbol.split(', ');
                return affectedSymbols.some(s => symbol.includes(s));
            }
            
            return false;
        });
    }
    
    calculateStopLoss(price, direction, strategy) {
        const baseRisk = 0.01; // 1% base risk
        const multipliers = {
            'ibrahim': 0.99,
            'marketdna': 0.992,
            'scalping': 0.998,
            'harmonic': 0.99,
            'momentum': 0.993,
            'breakout': 0.99
        };
        
        const multiplier = multipliers[strategy] || 0.99;
        return direction === 'BUY' ? price * multiplier : price * (2 - multiplier);
    }
    
    calculateTakeProfit(price, direction, strategy) {
        const baseReward = 0.02; // 2% base reward
        const multipliers = {
            'ibrahim': 1.02,
            'marketdna': 1.015,
            'scalping': 1.005,
            'harmonic': 1.03,
            'momentum': 1.02,
            'breakout': 1.025
        };
        
        const multiplier = multipliers[strategy] || 1.02;
        const tp1 = direction === 'BUY' ? price * multiplier : price * (2 - multiplier);
        const tp2 = direction === 'BUY' ? price * (multiplier + 0.01) : price * (2 - multiplier - 0.01);
        
        return [tp1, tp2];
    }
    
    getSignalReason(strategy, direction) {
        const reasons = {
            'ibrahim': [
                `Strong ${direction === 'BUY' ? 'bullish' : 'bearish'} momentum detected`,
                `Price action shows ${direction === 'BUY' ? 'bullish' : 'bearish'} divergence`,
                `Support/resistance break confirmed`
            ],
            'marketdna': [
                `${direction === 'BUY' ? 'Bullish' : 'Bearish'} pattern identified`,
                `Market structure favors ${direction} positions`,
                `Volume confirmation for ${direction} move`
            ],
            'scalping': [
                `Short-term ${direction === 'BUY' ? 'bullish' : 'bearish'} bias`,
                `Scalp setup with tight risk management`,
                `Quick ${direction} opportunity identified`
            ]
        };
        
        const strategyReasons = reasons[strategy] || reasons['ibrahim'];
        return strategyReasons[Math.floor(Math.random() * strategyReasons.length)];
    }
    
    // ==================== ENHANCED TRADE EXECUTION ====================
    
    executeAdvancedOrder(orderType, params) {
        if (this.trading.activeTrades.length >= this.config.riskManagement.maxConcurrentTrades) {
            this.showAdvancedNotification('Warning', 'Max Trades Reached', 'warning');
            return null;
        }
        
        // Check same symbol limit
        const sameSymbolCount = this.trading.activeTrades.filter(t => t.symbol === params.symbol).length;
        if (sameSymbolCount >= this.config.riskManagement.maxSameSymbolTrades) {
            this.showAdvancedNotification('Warning', `Max ${params.symbol} trades reached`, 'warning');
            return null;
        }
        
        // Calculate position size based on risk
        const riskAmount = this.currentAccount.equity * this.config.riskManagement.riskPerTrade;
        const riskPerUnit = Math.abs(params.entryPrice - params.stopLoss);
        const volume = params.volume || Math.max(0.01, Math.min(riskAmount / riskPerUnit / 100000, 10.0));
        
        // Update position size calculator
        this.calculatePositionSize(params.symbol, params.entryPrice, params.stopLoss, params.direction);
        
        const trade = {
            id: `TRADE_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
            type: orderType,
            strategy: params.strategy,
            symbol: params.symbol,
            direction: params.direction,
            entryPrice: params.entryPrice,
            stopLoss: params.stopLoss,
            takeProfit: params.takeProfit,
            volume: volume,
            status: 'OPEN',
            openedAt: new Date(),
            currentPrice: params.entryPrice,
            unrealizedPNL: 0,
            unrealizedPNLPercent: 0,
            trailingStop: this.config.riskManagement.trailingStop,
            trailingDistance: this.config.riskManagement.trailingDistance
        };
        
        this.trading.activeTrades.push(trade);
        this.performance.totalTrades++;
        
        // Update account
        this.currentAccount.margin += volume * params.entryPrice * 100000 * 0.01;
        this.currentAccount.freeMargin = this.currentAccount.equity - this.currentAccount.margin;
        this.currentAccount.marginLevel = (this.currentAccount.equity / this.currentAccount.margin) * 100;
        
        // Update main account for compatibility
        this.account = {...this.currentAccount};
        
        // Show visual feedback
        this.showTradeExecution(trade);
        
        // Update displays
        this.updateActiveTradesDisplay();
        this.updateAccountDisplay();
        this.updatePerformanceDisplay();
        
        this.log(`âœ… ${trade.strategy}: ${trade.direction} ${trade.symbol} @ ${trade.entryPrice.toFixed(5)} (${trade.volume.toFixed(2)} lots)`, 'success');
        
        return trade;
    }
    
    updateActiveTrades() {
        const now = new Date();
        
        this.trading.activeTrades.forEach(trade => {
            if (trade.status !== 'OPEN') return;
            
            const currentPrice = this.marketData.prices[trade.symbol] || trade.entryPrice;
            trade.currentPrice = currentPrice;
            
            // Calculate P&L
            const priceDiff = currentPrice - trade.entryPrice;
            trade.unrealizedPNL = trade.direction === 'BUY' 
                ? priceDiff * trade.volume * 100000 
                : -priceDiff * trade.volume * 100000;
            trade.unrealizedPNLPercent = (trade.unrealizedPNL / (trade.entryPrice * trade.volume * 100000)) * 100;
            
            // Update trailing stop
            if (trade.trailingStop) {
                this.updateTrailingStop(trade, currentPrice);
            }
            
            // Check stop loss
            if ((trade.direction === 'BUY' && currentPrice <= trade.stopLoss) ||
                (trade.direction === 'SELL' && currentPrice >= trade.stopLoss)) {
                this.closeTrade(trade.id, 'STOP_LOSS');
                return;
            }
            
            // Check take profit
            trade.takeProfit.forEach((tpLevel, index) => {
                if ((trade.direction === 'BUY' && currentPrice >= tpLevel) ||
                    (trade.direction === 'SELL' && currentPrice <= tpLevel)) {
                    this.closeTrade(trade.id, `TAKE_PROFIT_${index + 1}`);
                }
            });
        });
        
        // Remove closed trades
        this.trading.activeTrades = this.trading.activeTrades.filter(trade => trade.status === 'OPEN');
        
        // Update display
        this.updateActiveTradesDisplay();
        this.updatePerformanceDisplay();
    }
    
    updateTrailingStop(trade, currentPrice) {
        if (trade.direction === 'BUY') {
            const potentialNewStop = currentPrice * (1 - trade.trailingDistance);
            if (potentialNewStop > trade.stopLoss) {
                trade.stopLoss = potentialNewStop;
            }
        } else {
            const potentialNewStop = currentPrice * (1 + trade.trailingDistance);
            if (potentialNewStop < trade.stopLoss) {
                trade.stopLoss = potentialNewStop;
            }
        }
    }
    
    closeTrade(tradeId, reason) {
        const tradeIndex = this.trading.activeTrades.findIndex(t => t.id === tradeId);
        if (tradeIndex === -1) return;
        
        const trade = this.trading.activeTrades[tradeIndex];
        trade.status = 'CLOSED';
        trade.closedAt = new Date();
        trade.closeReason = reason;
        trade.closePrice = trade.currentPrice;
        
        // Calculate final P&L
        const priceDiff = trade.closePrice - trade.entryPrice;
        trade.realizedPNL = trade.direction === 'BUY' 
            ? priceDiff * trade.volume * 100000 
            : -priceDiff * trade.volume * 100000;
        trade.realizedPNLPercent = (trade.realizedPNL / (trade.entryPrice * trade.volume * 100000)) * 100;
        
        // Update account
        this.currentAccount.balance += trade.realizedPNL;
        this.currentAccount.equity = this.currentAccount.balance;
        this.currentAccount.margin -= trade.volume * trade.entryPrice * 100000 * 0.01;
        this.currentAccount.freeMargin = this.currentAccount.equity - this.currentAccount.margin;
        this.currentAccount.marginLevel = this.currentAccount.margin > 0 ? (this.currentAccount.equity / this.currentAccount.margin) * 100 : 0;
        
        // Update main account for compatibility
        this.account = {...this.currentAccount};
        
        // Update performance
        if (trade.realizedPNL > 0) {
            this.performance.winningTrades++;
            this.performance.dailyProfit += trade.realizedPNL;
        } else {
            this.performance.losingTrades++;
            this.performance.dailyProfit += trade.realizedPNL;
        }
        this.performance.totalProfit += trade.realizedPNL;
        
        // Update strategy performance
        this.updateStrategyPerformance(trade);
        
        // Update trade timing statistics
        this.updateTradeTimingStats();
        
        // Move to history
        this.trading.tradeHistory.unshift(trade);
        this.trading.activeTrades.splice(tradeIndex, 1);
        
        // Show visual feedback
        this.showTradeClosure(trade, reason);
        
        // Update displays
        this.updateActiveTradesDisplay();
        this.updateTradeHistoryDisplay();
        this.updateAccountDisplay();
        this.updatePerformanceDisplay();
    }
    
    updateStrategyPerformance(trade) {
        const strategyKey = Object.keys(this.strategies).find(
            key => this.strategies[key].name === trade.strategy
        );
        
        if (strategyKey) {
            if (!this.performance.strategyPerformance[strategyKey]) {
                this.performance.strategyPerformance[strategyKey] = {
                    totalTrades: 0,
                    winningTrades: 0,
                    totalProfit: 0,
                    winRate: 0
                };
            }
            
            const perf = this.performance.strategyPerformance[strategyKey];
            perf.totalTrades++;
            if (trade.realizedPNL > 0) perf.winningTrades++;
            perf.totalProfit += trade.realizedPNL;
            perf.winRate = perf.totalTrades > 0 ? (perf.winningTrades / perf.totalTrades) * 100 : 0;
            
            // Update strategy win rate
            this.strategies[strategyKey].winRate = perf.winRate / 100;
        }
    }
    
    // ==================== UI UPDATE METHODS ====================
    
    updateActiveTradesDisplay() {
        const container = document.getElementById('activeTradesList');
        if (!container) return;
        
        if (this.trading.activeTrades.length === 0) {
            container.innerHTML = `
                <div class="no-data-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--mt5-text-secondary); text-align: center;">
                    <i class="fas fa-coins" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div style="font-size: 16px; margin-bottom: 8px;">No active trades</div>
                    <div style="font-size: 13px;">Execute signals to start trading</div>
                </div>
            `;
        } else {
            container.innerHTML = this.trading.activeTrades.map(trade => {
                const progress = this.calculateTradeProgress(trade);
                const pnlSign = trade.unrealizedPNL >= 0 ? '+' : '';
                const isSelected = this.selectedTrades.has(trade.id);
                const borderStyle = isSelected ? '2px solid var(--mt5-accent-blue)' : '1px solid var(--mt5-border)';
                const borderLeftStyle = trade.direction === 'BUY' ? '4px solid var(--mt5-accent-green)' : '4px solid var(--mt5-accent-red)';
                
                return `
                    <div class="trade-card" data-trade-id="${trade.id}" 
                         style="background: var(--mt5-bg-tertiary); padding: 16px; border-radius: 6px; border: ${borderStyle}; 
                                border-left: ${borderLeftStyle}; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                        ${trade.trailingStop ? `
                            <div style="position: absolute; top: 8px; right: 8px; background: rgba(156, 39, 176, 0.2); color: var(--mt5-accent-purple); padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                                <i class="fas fa-sliders-h"></i> Trailing
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${isSelected ? `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--mt5-accent-blue);"></div>
                                ` : ''}
                                <strong style="font-size: 14px; color: var(--mt5-text-primary); font-weight: 700;">
                                    ${trade.direction} ${trade.symbol}
                                </strong>
                                <span style="font-size: 12px; color: var(--mt5-text-secondary);">${trade.strategy}</span>
                                <div style="font-size: 11px; padding: 2px 8px; background: var(--mt5-bg-secondary); border-radius: 10px;">
                                    ${trade.volume.toFixed(2)} lots
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 800; color: ${trade.unrealizedPNL >= 0 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">
                                    ${pnlSign}$${trade.unrealizedPNL.toFixed(2)}
                                </div>
                                <div style="font-size: 12px; color: ${trade.unrealizedPNL >= 0 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">
                                    ${pnlSign}${trade.unrealizedPNLPercent.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 6px;">
                                <span>Entry: ${trade.entryPrice.toFixed(5)}</span>
                                <span>Current: ${trade.currentPrice.toFixed(5)}</span>
                            </div>
                            <div style="height: 6px; background: var(--mt5-border); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: ${trade.direction === 'BUY' ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};"></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div style="background: rgba(244, 67, 54, 0.1); padding: 8px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-bottom: 2px;">Stop Loss</div>
                                <div style="font-size: 12px; color: var(--mt5-accent-red); font-weight: 600;">${trade.stopLoss.toFixed(5)}</div>
                            </div>
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 8px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-bottom: 2px;">Take Profit 1</div>
                                <div style="font-size: 12px; color: var(--mt5-accent-green); font-weight: 600;">${trade.takeProfit[0].toFixed(5)}</div>
                            </div>
                            ${trade.takeProfit[1] ? `
                                <div style="background: rgba(76, 175, 80, 0.1); padding: 8px; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-bottom: 2px;">Take Profit 2</div>
                                    <div style="font-size: 12px; color: var(--mt5-accent-green); font-weight: 600;">${trade.takeProfit[1].toFixed(5)}</div>
                                </div>
                            ` : `
                                <div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--mt5-text-secondary); margin-bottom: 2px;">Take Profit 2</div>
                                    <div style="font-size: 12px; color: var(--mt5-accent-yellow);">None</div>
                                </div>
                            `}
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button class="trade-action-btn" data-action="close" data-trade-id="${trade.id}" 
                                    style="flex: 1; background: rgba(244, 67, 54, 0.2); color: var(--mt5-accent-red); border: 1px solid var(--mt5-accent-red); 
                                           border-radius: 4px; padding: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <i class="fas fa-times"></i> Close Trade
                            </button>
                            <button class="trade-action-btn" data-action="details" data-trade-id="${trade.id}"
                                    style="flex: 1; background: rgba(0, 180, 160, 0.2); color: var(--mt5-accent-teal); border: 1px solid var(--mt5-accent-teal); 
                                           border-radius: 4px; padding: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            this.attachTradeCardHandlers();
        }
        
        // Update header
        const header = document.getElementById('tradesHeader');
        if (header) {
            const countElement = header.querySelector('div > div:last-child');
            if (countElement) {
                countElement.textContent = `${this.trading.activeTrades.length} active trades, ${this.selectedTrades.size} selected`;
            }
        }
        
        // Update active trades count display
        const countDisplay = document.getElementById('activeTradesCountDisplay');
        if (countDisplay) {
            countDisplay.textContent = this.trading.activeTrades.length;
        }
    }
    
    calculateTradeProgress(trade) {
        if (trade.direction === 'BUY') {
            const range = trade.takeProfit[0] - trade.stopLoss;
            const progress = ((trade.currentPrice - trade.stopLoss) / range) * 100;
            return Math.min(100, Math.max(0, progress));
        } else {
            const range = trade.stopLoss - trade.takeProfit[0];
            const progress = ((trade.stopLoss - trade.currentPrice) / range) * 100;
            return Math.min(100, Math.max(0, progress));
        }
    }
    
    addTradingSignal(signal) {
        // Check if similar signal already exists
        const existingSignal = this.tradingSignals.find(s => 
            s.symbol === signal.symbol && 
            s.direction === signal.direction &&
            Math.abs(s.entryPrice - signal.entryPrice) < signal.entryPrice * 0.001
        );
        
        if (!existingSignal) {
            this.tradingSignals.unshift(signal);
            
            // Keep only recent signals
            if (this.tradingSignals.length > 20) {
                this.tradingSignals.pop();
            }
            
            this.updateSignalsDisplay();
            
            // Show notification for high-confidence signals
            if (signal.confidence >= 0.8) {
                this.showSignalNotification(signal);
            }
        }
    }
    
    updateSignalsDisplay() {
        const container = document.getElementById('tradingSignalsList');
        if (!container) return;
        
        if (this.tradingSignals.length === 0) {
            container.innerHTML = `
                <div class="no-data-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--mt5-text-secondary); text-align: center;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div style="font-size: 16px; margin-bottom: 8px;">No trading signals yet</div>
                    <div style="font-size: 13px;">Start the bot to begin market analysis</div>
                </div>
            `;
        } else {
            container.innerHTML = this.tradingSignals.map(signal => {
                const time = new Date(signal.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const confidenceColor = signal.confidence >= 0.8 ? 'var(--mt5-accent-green)' : 
                                      signal.confidence >= 0.7 ? 'var(--mt5-accent-yellow)' : 'var(--mt5-accent-orange)';
                const borderStyle = signal.selected ? '2px solid var(--mt5-accent-teal)' : '1px solid var(--mt5-border)';
                
                // Get confidence level explanation
                let confidenceLevel = 'low';
                if (signal.confidence >= 0.75) confidenceLevel = 'high';
                else if (signal.confidence >= 0.6) confidenceLevel = 'medium';
                
                const confidenceExplanation = this.confidenceExplanations[confidenceLevel];
                
                return `
                    <div class="signal-card" data-signal-id="${signal.id}" 
                         style="background: var(--mt5-bg-tertiary); padding: 16px; border-radius: 6px; border: ${borderStyle}; 
                                cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <div style="font-size: 14px; font-weight: 700; color: var(--mt5-text-primary);">
                                        ${signal.strategy}
                                    </div>
                                    ${signal.strategy === this.strategies.ibrahim.name ? `
                                        <span style="font-size: 10px; background: rgba(0, 180, 160, 0.2); color: var(--mt5-accent-teal); padding: 2px 8px; border-radius: 10px;">
                                            <i class="fas fa-microchip"></i> Exact Execution
                                        </span>
                                    ` : ''}
                                    ${signal.timeframeCount > 1 ? `
                                        <span style="font-size: 10px; padding: 2px 6px; background: rgba(0, 180, 160, 0.2); color: var(--mt5-accent-teal); border-radius: 10px;">
                                            <i class="fas fa-layer-group"></i> ${signal.timeframeCount} TF
                                            ${signal.consensusStrength ? ` (${Math.round(signal.consensusStrength * 100)}%)` : ''}
                                        </span>
                                    ` : ''}
                                    <span style="font-size: 12px; padding: 4px 8px; background: ${signal.direction === 'BUY' ? 'rgba(38, 166, 154, 0.2)' : 'rgba(239, 83, 80, 0.2)'}; 
                                         color: ${signal.direction === 'BUY' ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'}; 
                                         border-radius: 4px; font-weight: 600;">
                                        ${signal.direction}
                                    </span>
                                </div>
                                <div style="font-size: 14px; color: var(--mt5-text-primary); font-weight: 700; margin-bottom: 4px;">
                                    ${signal.symbol} @ ${signal.entryPrice.toFixed(5)}
                                </div>
                                <div style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 8px;">
                                    ${signal.reason}
                                </div>
                                <div style="display: flex; gap: 12px; font-size: 11px; color: var(--mt5-text-secondary);">
                                    <span>SL: ${signal.stopLoss.toFixed(5)}</span>
                                    <span>TP1: ${signal.takeProfit[0].toFixed(5)}</span>
                                    ${signal.takeProfit[1] ? `<span>TP2: ${signal.takeProfit[1].toFixed(5)}</span>` : ''}
                                </div>
                                <div style="margin-top: 8px; font-size: 11px; color: ${confidenceExplanation.color}; background: rgba(0,0,0,0.1); padding: 6px 10px; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas ${confidenceExplanation.icon}"></i>
                                    <span><strong>${confidenceLevel.toUpperCase()}:</strong> ${confidenceExplanation.description}</span>
                                    <span style="margin-left: auto; font-weight: 600; color: ${confidenceExplanation.color};">Risk: ${confidenceExplanation.riskLevel}</span>
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 120px;">
                                <div style="font-size: 12px; color: var(--mt5-text-secondary); margin-bottom: 8px;">${time}</div>
                                <div class="confidence-tooltip" style="display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-bottom: 12px;">
                                    <span style="font-size: 20px; font-weight: 800; color: ${confidenceColor};">
                                        ${Math.round(signal.confidence * 100)}%
                                    </span>
                                    <i class="fas fa-info-circle" style="color: var(--mt5-text-secondary); font-size: 14px;"></i>
                                    <span class="tooltiptext">
                                        <strong style="color: ${confidenceExplanation.color};">${confidenceLevel.toUpperCase()} CONFIDENCE</strong><br>
                                        ${confidenceExplanation.description}<br><br>
                                        <strong>Action:</strong> ${confidenceExplanation.action}<br>
                                        <strong>Risk Level:</strong> ${confidenceExplanation.riskLevel}<br>
                                        <strong>Threshold:</strong> â‰¥${Math.round(confidenceExplanation.threshold * 100)}%
                                    </span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="signal-execute-btn" data-signal-id="${signal.id}" 
                                            style="background: var(--mt5-accent-teal); color: white; border: none; border-radius: 4px; 
                                                   padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; flex: 1;">
                                        Execute
                                    </button>
                                    <button class="signal-ignore-btn" data-signal-id="${signal.id}"
                                            style="background: var(--mt5-bg-secondary); color: var(--mt5-text-secondary); border: none; 
                                                   border-radius: 4px; padding: 8px 12px; font-size: 12px; cursor: pointer;">
                                        Ignore
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${signal.selected ? `
                            <div style="background: rgba(0, 180, 160, 0.1); padding: 8px; border-radius: 4px; margin-top: 12px; text-align: center; font-size: 12px; color: var(--mt5-accent-teal); font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Selected for execution
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            this.attachSignalCardHandlers();
        }
    }
    
    updateTradeHistoryDisplay() {
        const container = document.getElementById('tradeHistoryList');
        if (!container) return;
        
        if (this.trading.tradeHistory.length === 0) {
            container.innerHTML = `
                <div class="no-data-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--mt5-text-secondary); text-align: center;">
                    <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div style="font-size: 16px; margin-bottom: 8px;">No trade history</div>
                    <div style="font-size: 13px;">Closed trades will appear here</div>
                </div>
            `;
        } else {
            container.innerHTML = this.trading.tradeHistory.slice(0, 20).map(trade => {
                const time = new Date(trade.closedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const pnlSign = trade.realizedPNL >= 0 ? '+' : '';
                const borderLeftStyle = trade.realizedPNL >= 0 ? '4px solid var(--mt5-accent-green)' : '4px solid var(--mt5-accent-red)';
                
                return `
                    <div class="history-card" style="background: var(--mt5-bg-tertiary); padding: 12px; border-radius: 6px; border-left: ${borderLeftStyle}; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <strong style="font-size: 14px; color: var(--mt5-text-primary); font-weight: 700;">
                                    ${trade.direction} ${trade.symbol}
                                </strong>
                                <span style="font-size: 11px; padding: 2px 8px; background: var(--mt5-bg-secondary); border-radius: 10px;">
                                    ${trade.volume.toFixed(2)} lots
                                </span>
                                <span style="font-size: 11px; color: var(--mt5-text-secondary);">
                                    ${trade.strategy}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: var(--mt5-text-secondary);">${time}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: var(--mt5-text-secondary);">
                                Exit: ${trade.closeReason}
                            </div>
                            <div style="font-size: 14px; font-weight: 800; color: ${trade.realizedPNL >= 0 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">
                                ${pnlSign}$${trade.realizedPNL.toFixed(2)}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--mt5-text-secondary);">
                            <span>Entry: ${trade.entryPrice.toFixed(5)}</span>
                            <span>Exit: ${trade.closePrice.toFixed(5)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update header
        const header = document.getElementById('historyHeader');
        if (header) {
            const countElement = header.querySelector('div > div:last-child');
            if (countElement) {
                countElement.textContent = `Last ${Math.min(20, this.trading.tradeHistory.length)} of ${this.trading.tradeHistory.length} trades`;
            }
        }
    }
    
    updatePerformanceDisplay() {
        this.performance.winRate = this.performance.totalTrades > 0 
            ? (this.performance.winningTrades / this.performance.totalTrades) * 100 
            : 0;
        
        const winRateDisplay = document.getElementById('winRateDisplay');
        const totalProfitDisplay = document.getElementById('totalProfitDisplay');
        const totalTradesDisplay = document.getElementById('totalTradesDisplay');
        const activeTradesCountDisplay = document.getElementById('activeTradesCountDisplay');
        const navWinRate = document.getElementById('navWinRate');
        const navDailyPnL = document.getElementById('navDailyPnL');
        
        if (winRateDisplay) winRateDisplay.textContent = `${this.performance.winRate.toFixed(1)}%`;
        if (totalProfitDisplay) totalProfitDisplay.textContent = `$${this.performance.totalProfit.toFixed(2)}`;
        if (totalTradesDisplay) totalTradesDisplay.textContent = this.performance.totalTrades;
        if (activeTradesCountDisplay) activeTradesCountDisplay.textContent = this.trading.activeTrades.length;
        if (navWinRate) navWinRate.textContent = `${this.performance.winRate.toFixed(1)}%`;
        if (navDailyPnL) navDailyPnL.textContent = `$${this.performance.dailyProfit.toFixed(2)}`;
    }
    
    updateAccountDisplay() {
        // Update equity and free margin displays
        const equityElements = document.querySelectorAll('.bot-header div:last-child');
        if (equityElements.length > 0) {
            equityElements[0].innerHTML = `<i class="fas fa-wallet"></i> $${this.currentAccount.equity.toFixed(2)}`;
        }
    }
    
    updateMarketOverview() {
        const container = document.getElementById('marketOverview');
        if (!container) return;
        
        const symbols = ['XAUUSD', 'EURUSD', 'BTCUSD'];
        const html = symbols.map(symbol => {
            const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
            const change = ((price - this.getBasePrice(symbol)) / this.getBasePrice(symbol)) * 100;
            const isPositive = change >= 0;
            
            return `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">${symbol}</span>
                    <span style="font-size: 12px; color: ${isPositive ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'}; font-weight: 600;">
                        ${price.toFixed(symbol === 'XAUUSD' ? 2 : 5)} ${isPositive ? 'â†—' : 'â†˜'}
                    </span>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
    
    // NEW: Update economic calendar display
    updateEconomicCalendarDisplay() {
        const container = document.getElementById('economicCalendarList');
        if (!container) return;
        
        // Sort events by date
        const sortedEvents = [...this.economicCalendar.events].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        container.innerHTML = sortedEvents.map(event => {
            const eventDate = new Date(event.date);
            const now = new Date();
            const timeDiff = eventDate - now;
            const isToday = eventDate.toDateString() === now.toDateString();
            const isTomorrow = eventDate.toDateString() === new Date(now.getTime() + 86400000).toDateString();
            
            let dateDisplay = eventDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
            if (isToday) dateDisplay = 'Today';
            else if (isTomorrow) dateDisplay = 'Tomorrow';
            
            const timeDisplay = eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const impactColor = event.impact === 'high' ? 'var(--mt5-accent-red)' : 
                               event.impact === 'medium' ? 'var(--mt5-accent-yellow)' : 'var(--mt5-accent-teal)';
            
            return `
                <div class="calendar-event" style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid ${impactColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 13px; font-weight: 600; color: var(--mt5-text-primary);">${event.title}</span>
                            <span style="font-size: 11px; padding: 2px 8px; background: rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.8);">
                                ${event.country}
                            </span>
                        </div>
                        <span style="font-size: 11px; padding: 2px 8px; background: ${impactColor}20; color: ${impactColor}; border-radius: 10px; font-weight: 600;">
                            ${event.impact.toUpperCase()}
                        </span>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 11px; color: var(--mt5-text-secondary); margin-bottom: 6px;">
                        <span><i class="far fa-calendar"></i> ${dateDisplay} ${timeDisplay}</span>
                        <span><i class="fas fa-flag"></i> ${event.currency}</span>
                        <span><i class="fas fa-chart-line"></i> ${event.symbol}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div style="background: rgba(0,0,0,0.1); padding: 6px; border-radius: 4px; text-align: center;">
                            <span style="font-size: 10px; color: var(--mt5-text-secondary);">Forecast</span>
                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">${event.forecast || '-'}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.1); padding: 6px; border-radius: 4px; text-align: center;">
                            <span style="font-size: 10px; color: var(--mt5-text-secondary);">Previous</span>
                            <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">${event.previous || '-'}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.1); padding: 6px; border-radius: 4px; text-align: center;">
                            <span style="font-size: 10px; color: var(--mt5-text-secondary);">Actual</span>
                            <div style="font-size: 12px; font-weight: 600; color: ${event.actual ? 'var(--mt5-accent-green)' : 'rgba(255,255,255,0.5)'};">${event.actual || 'Pending'}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Update last update time
        const updateTimeElement = document.getElementById('calendarLastUpdate');
        if (updateTimeElement) {
            this.economicCalendar.lastUpdate = new Date();
            updateTimeElement.textContent = this.economicCalendar.lastUpdate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    }
    
    // NEW: Refresh economic calendar
    refreshEconomicCalendar() {
        this.showAdvancedNotification('Calendar', 'Refreshing economic calendar...', 'info');
        
        // Simulate API refresh
        setTimeout(() => {
            // Update some random values
            this.economicCalendar.events.forEach(event => {
                if (Math.random() > 0.7) {
                    event.forecast = (Math.random() * 10).toFixed(1) + '%';
                }
            });
            
            this.updateEconomicCalendarDisplay();
            this.showAdvancedNotification('Calendar', 'Economic calendar updated', 'success');
        }, 1000);
    }
    
    // NEW: Export economic calendar
    exportEconomicCalendar() {
        const data = this.economicCalendar.events.map(event => ({
            title: event.title,
            date: new Date(event.date).toLocaleString(),
            country: event.country,
            impact: event.impact,
            currency: event.currency,
            forecast: event.forecast,
            previous: event.previous,
            actual: event.actual || 'Pending'
        }));
        
        const csv = [
            ['Title', 'Date', 'Country', 'Impact', 'Currency', 'Forecast', 'Previous', 'Actual'],
            ...data.map(e => [e.title, e.date, e.country, e.impact, e.currency, e.forecast, e.previous, e.actual])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `economic-calendar-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        this.showAdvancedNotification('Calendar', 'Economic calendar exported', 'success');
    }
    
    // NEW: Switch account
    switchAccount(accountId) {
        const account = this.accounts.find(a => a.id === accountId);
        if (!account) return;
        
        // Update active status
        this.accounts.forEach(a => a.isActive = false);
        account.isActive = true;
        this.currentAccount = account;
        
        // Update main account for compatibility
        this.account = {...account};
        
        // Update UI
        this.updateAccountDisplay();
        
        // Recalculate position size
        if (this.config.selectedSymbols.length > 0) {
            const symbol = this.config.selectedSymbols[0];
            const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
            const stopLoss = price * 0.99;
            this.calculatePositionSize(symbol, price, stopLoss, 'BUY');
        }
        
        this.showAdvancedNotification('Account', `Switched to ${account.name}`, 'success');
        this.savePreferences();
    }
    
    // NEW: Show confidence level explanation
    showConfidenceExplanation(level) {
        const explanation = this.confidenceExplanations[level];
        if (!explanation) return;
        
        this.showAdvancedNotification(
            `${level.toUpperCase()} Confidence Level`,
            `${explanation.description}\nAction: ${explanation.action}\nRisk: ${explanation.riskLevel}`,
            level === 'high' ? 'success' : level === 'medium' ? 'warning' : 'info',
            { duration: 8000 }
        );
    }
    
    // ==================== ENHANCED VISUAL FEEDBACK ====================
    
    showAdvancedNotification(title, message, type = 'info', options = {}) {
        const notification = document.createElement('div');
        notification.className = `advanced-notification ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            warning: 'fa-exclamation-triangle',
            error: 'fa-times-circle',
            info: 'fa-info-circle',
            trade: 'fa-exchange-alt'
        };
        
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: ${this.getNotificationColor(type)};
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-left: 4px solid ${this.getNotificationBorderColor(type)};
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <i class="fas ${icons[type] || 'fa-info-circle'}" style="font-size: 20px; margin-top: 2px;"></i>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">${title}</div>
                    <div style="font-size: 13px; opacity: 0.9; white-space: pre-line;">${message}</div>
                </div>
                <button class="notification-close" style="background: none; border: none; color: rgba(255,255,255,0.7); 
                       cursor: pointer; padding: 4px; font-size: 12px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove
        const duration = options.duration || 5000;
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, duration);
        
        // Close button
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        });
        
        // Play sound if enabled
        if (this.ui.soundEnabled) {
            this.playNotificationSound(type);
        }
        
        return notification;
    }
    
    getNotificationColor(type) {
        const colors = {
            success: 'linear-gradient(135deg, #2e7d32, #4caf50)',
            warning: 'linear-gradient(135deg, #f57c00, #ff9800)',
            error: 'linear-gradient(135deg, #c62828, #f44336)',
            info: 'linear-gradient(135deg, #1565c0, #2196f3)',
            trade: 'linear-gradient(135deg, #6a1b9a, #9c27b0)'
        };
        return colors[type] || colors.info;
    }
    
    getNotificationBorderColor(type) {
        const colors = {
            success: '#2e7d32',
            warning: '#f57c00',
            error: '#c62828',
            info: '#1565c0',
            trade: '#6a1b9a'
        };
        return colors[type] || colors.info;
    }
    
    showTradeExecution(trade) {
        const overlay = document.createElement('div');
        overlay.className = 'trade-execution-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: ${trade.direction === 'BUY' ? 'rgba(38, 166, 154, 0.95)' : 'rgba(239, 83, 80, 0.95)'};
            color: white;
            padding: 30px 40px;
            border-radius: 10px;
            z-index: 10000;
            text-align: center;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            min-width: 350px;
            font-family: inherit;
        `;
        
        overlay.innerHTML = `
            <div style="font-size: 36px; margin-bottom: 16px;">
                ${trade.direction === 'BUY' ? 'ðŸ“ˆ' : 'ðŸ“‰'}
            </div>
            <div style="font-size: 22px; font-weight: 800; margin-bottom: 8px; text-transform: uppercase;">
                TRADE EXECUTED
            </div>
            <div style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">
                ${trade.direction} ${trade.symbol} @ ${trade.entryPrice.toFixed(5)}
            </div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
                ${trade.strategy} â€¢ ${trade.volume.toFixed(2)} lots
            </div>
            <div style="font-size: 13px; opacity: 0.8;">
                ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Remove after 2.5 seconds
        setTimeout(() => {
            overlay.style.animation = 'fadeOut 0.5s ease';
            setTimeout(() => overlay.remove(), 500);
        }, 2500);
    }
    
    showTradeClosure(trade, reason) {
        const notification = document.createElement('div');
        notification.className = 'trade-closure-notification';
        notification.style.cssText = `
            position: fixed;
            top: 120px;
            right: 20px;
            background: ${trade.realizedPNL >= 0 ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)'};
            color: white;
            padding: 16px 20px;
            border-radius: 6px;
            z-index: 9998;
            animation: slideInRight 0.3s ease;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: inherit;
        `;
        
        const pnlSign = trade.realizedPNL >= 0 ? '+' : '';
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <i class="fas fa-${trade.realizedPNL >= 0 ? 'check-circle' : 'times-circle'}" style="font-size: 16px;"></i>
                <strong style="font-size: 14px; font-weight: 700;">Trade Closed</strong>
            </div>
            <div style="font-size: 13px; margin-bottom: 6px;">
                ${trade.symbol} ${trade.direction} - ${reason}
            </div>
            <div style="font-size: 18px; font-weight: 800; margin-top: 6px;">
                P&L: ${pnlSign}$${trade.realizedPNL.toFixed(2)}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    showMarketScan() {
        if (!this.isRunning) return;
        
        const scan = document.createElement('div');
        scan.className = 'market-scan-visual';
        scan.style.cssText = `
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--mt5-bg-tertiary);
            border: 1px solid var(--mt5-border);
            border-radius: 6px;
            padding: 16px 24px;
            z-index: 9997;
            animation: slideInDown 0.3s ease;
            min-width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: inherit;
        `;
        
        const activeCount = Object.values(this.strategies).filter(s => s.active).length;
        
        scan.innerHTML = `
            <div style="font-size: 14px; font-weight: 700; color: var(--mt5-accent-teal); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-search"></i> Scanning Markets
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px; margin-bottom: 16px;">
                <div>
                    <div style="color: var(--mt5-text-secondary); margin-bottom: 4px;">Instruments</div>
                    <div style="color: var(--mt5-text-primary); font-weight: 800;">${this.config.selectedSymbols.length}</div>
                </div>
                <div>
                    <div style="color: var(--mt5-text-secondary); margin-bottom: 4px;">Active Strategies</div>
                    <div style="color: var(--mt5-text-primary); font-weight: 800;">${activeCount}</div>
                </div>
            </div>
            <div style="height: 6px; background: var(--mt5-border); border-radius: 3px; overflow: hidden;">
                <div id="scanProgress" style="width: 0%; height: 100%; background: var(--mt5-accent-teal); transition: width 2s ease;"></div>
            </div>
        `;
        
        document.body.appendChild(scan);
        
        // Animate progress bar
        setTimeout(() => {
            const progressBar = document.getElementById('scanProgress');
            if (progressBar) {
                progressBar.style.width = '100%';
            }
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            scan.style.animation = 'slideOutUp 0.3s ease';
            setTimeout(() => scan.remove(), 300);
        }, 3000);
    }
    
    showSignalNotification(signal) {
        const notification = document.createElement('div');
        notification.className = 'signal-notification';
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${signal.direction === 'BUY' ? 'rgba(38, 166, 154, 0.9)' : 'rgba(239, 83, 80, 0.9)'};
            color: white;
            padding: 16px 20px;
            border-radius: 6px;
            z-index: 9998;
            animation: slideInRight 0.3s ease;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            font-family: inherit;
        `;
        
        // Get confidence level explanation
        let confidenceLevel = 'low';
        if (signal.confidence >= 0.75) confidenceLevel = 'high';
        else if (signal.confidence >= 0.6) confidenceLevel = 'medium';
        const confidenceExplanation = this.confidenceExplanations[confidenceLevel];
        
        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 14px; font-weight: 700;">
                    ${signal.strategy}
                </div>
                <div style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                    ${Math.round(signal.confidence * 100)}% ${confidenceLevel.toUpperCase()}
                </div>
            </div>
            <div style="font-size: 13px; margin-bottom: 6px;">
                ${signal.direction} ${signal.symbol} @ ${signal.entryPrice.toFixed(5)}
            </div>
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 12px;">
                ${signal.reason}
            </div>
            <div style="font-size: 11px; margin-bottom: 12px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                <i class="fas ${confidenceExplanation.icon}"></i> ${confidenceExplanation.action}
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="signal-action-btn" data-action="execute" data-signal-id="${signal.id}" 
                        style="flex: 1; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                    Execute
                </button>
                <button class="signal-action-btn" data-action="ignore" data-signal-id="${signal.id}"
                        style="flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    Ignore
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Add click handlers
        notification.addEventListener('click', (e) => {
            if (e.target.classList.contains('signal-action-btn')) {
                const action = e.target.dataset.action;
                const signalId = e.target.dataset.signalId;
                
                if (action === 'execute') {
                    const signal = this.tradingSignals.find(s => s.id === signalId);
                    if (signal) {
                        // Check if it's Ibrahim Abu Strategy - use exact execution
                        if (signal.strategy === this.strategies.ibrahim.name) {
                            this.executeIbrahimAbuStrategy(signal);
                        } else {
                            this.executeTrade(signal);
                        }
                        this.removeSignal(signalId);
                    }
                } else if (action === 'ignore') {
                    this.removeSignal(signalId);
                }
                
                notification.remove();
            }
        });
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 10000);
    }
    
    // ==================== CONTROL METHODS ====================
    
    executeSelectedSignals() {
        const selectedSignals = this.tradingSignals.filter(signal => signal.selected);
        
        if (selectedSignals.length === 0) {
            this.showAdvancedNotification('Warning', 'No Signals Selected', 'warning');
            return;
        }
        
        this.showAdvancedNotification('Executing Trades', 
            `Executing ${selectedSignals.length} selected trades`, 'info');
        
        selectedSignals.forEach((signal, index) => {
            setTimeout(() => {
                // Check if it's Ibrahim Abu Strategy - use exact execution
                if (signal.strategy === this.strategies.ibrahim.name) {
                    this.executeIbrahimAbuStrategy(signal);
                } else {
                    this.executeTrade(signal);
                }
            }, index * 300);
        });
        
        // Clear selection after execution
        this.clearSignalSelection();
    }
    
    executeTrade(signal) {
        const orderParams = {
            strategy: signal.strategy,
            symbol: signal.symbol,
            direction: signal.direction,
            entryPrice: signal.entryPrice,
            stopLoss: signal.stopLoss,
            takeProfit: signal.takeProfit,
            volume: signal.volume
        };
        
        this.executeAdvancedOrder('market', orderParams);
    }
    
    closeSelectedTrades() {
        if (this.selectedTrades.size === 0) {
            this.showAdvancedNotification('Warning', 'No Trades Selected', 'warning');
            return;
        }
        
        this.showAdvancedNotification('Closing Trades', 
            `Closing ${this.selectedTrades.size} positions`, 'info');
        
        Array.from(this.selectedTrades).forEach((tradeId, index) => {
            setTimeout(() => {
                this.closeTrade(tradeId, 'MANUAL_CLOSE');
            }, index * 300);
        });
        
        this.selectedTrades.clear();
        this.updateSelectedCount();
    }
    
    closeAllTrades() {
        if (this.trading.activeTrades.length === 0) {
            this.showAdvancedNotification('Info', 'No Active Trades', 'info');
            return;
        }
        
        this.showAdvancedNotification('Closing All Trades', 
            `Closing ${this.trading.activeTrades.length} active positions`, 'warning');
        
        this.trading.activeTrades.forEach((trade, index) => {
            setTimeout(() => {
                this.closeTrade(trade.id, 'MANUAL_CLOSE');
            }, index * 300);
        });
    }
    
    selectAllInstruments() {
        this.config.selectedSymbols = [...this.config.symbols];
        this.updateInstrumentSelection();
        
        // Update position size calculator
        if (this.config.selectedSymbols.length > 0) {
            const symbol = this.config.selectedSymbols[0];
            const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
            const stopLoss = price * 0.99;
            this.calculatePositionSize(symbol, price, stopLoss, 'BUY');
        }
        
        this.updateStatusMessage('All instruments selected');
    }
    
    clearInstruments() {
        this.config.selectedSymbols = [];
        this.updateInstrumentSelection();
        this.updateStatusMessage('No instruments selected');
    }
    
    updateInstrumentSelection() {
        document.querySelectorAll('.instrument-selector').forEach(selector => {
            const checkbox = selector.querySelector('.instrument-checkbox');
            const symbol = checkbox.value;
            const isSelected = this.config.selectedSymbols.includes(symbol);
            
            checkbox.checked = isSelected;
            
            const visual = selector.querySelector('.instrument-checkbox-visual');
            const status = selector.querySelector('.instrument-status');
            
            if (isSelected) {
                visual.style.background = 'var(--mt5-accent-teal)';
                visual.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>';
                status.style.background = 'var(--mt5-accent-green)';
            } else {
                visual.style.background = 'transparent';
                visual.innerHTML = '';
                status.style.background = 'var(--mt5-accent-red)';
            }
        });
    }
    
    adjustSetting(target, change) {
        const settings = {
            'maxConcurrentTrades': {
                value: 'maxConcurrentTradesValue',
                min: 1,
                max: 20,
                config: 'riskManagement.maxConcurrentTrades'
            },
            'maxSameSymbol': {
                value: 'maxSameSymbolValue',
                min: 1,
                max: 5,
                config: 'riskManagement.maxSameSymbolTrades'
            }
        };
        
        const setting = settings[target];
        if (!setting) return;
        
        const currentElement = document.getElementById(setting.value);
        if (!currentElement) return;
        
        let currentValue = parseInt(currentElement.textContent);
        const newValue = Math.max(setting.min, Math.min(setting.max, currentValue + change));
        
        if (newValue !== currentValue) {
            currentElement.textContent = newValue;
            
            // Update config
            const configPath = setting.config.split('.');
            if (configPath.length === 2) {
                this.config[configPath[0]][configPath[1]] = newValue;
            }
            
            this.updateStatusMessage(`${target.replace(/([A-Z])/g, ' $1')} set to ${newValue}`);
        }
    }
    
    selectAllSignals() {
        this.tradingSignals.forEach(signal => {
            signal.selected = true;
        });
        this.updateSignalsDisplay();
        this.updateSelectedCount();
    }
    
    clearSignalSelection() {
        this.tradingSignals.forEach(signal => {
            signal.selected = false;
        });
        this.updateSignalsDisplay();
        this.updateSelectedCount();
    }
    
    removeSignal(signalId) {
        const index = this.tradingSignals.findIndex(s => s.id === signalId);
        if (index > -1) {
            this.tradingSignals.splice(index, 1);
            this.updateSignalsDisplay();
        }
    }
    
    clearTradeHistory() {
        if (this.trading.tradeHistory.length === 0) {
            this.showAdvancedNotification('Warning', 'No History', 'warning');
            return;
        }
        
        const confirmed = confirm(`Clear all ${this.trading.tradeHistory.length} trade history records?`);
        if (!confirmed) return;
        
        this.trading.tradeHistory = [];
        this.updateTradeHistoryDisplay();
        
        this.showAdvancedNotification('Success', 'Trade history cleared', 'success');
    }
    
    exportTradeHistory() {
        if (this.trading.tradeHistory.length === 0) {
            this.showAdvancedNotification('Warning', 'No History', 'warning');
            return;
        }
        
        // Simple CSV export
        const csv = this.generateTradeHistoryCSV();
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `trading-history-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        this.showAdvancedNotification('Success', 'Trade history exported to CSV', 'success');
    }
    
    switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.bot-tab').forEach(t => {
            t.style.borderBottomColor = 'transparent';
            t.style.color = 'var(--mt5-text-secondary)';
        });
        
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
            activeTab.style.borderBottomColor = 'var(--mt5-accent-teal)';
            activeTab.style.color = 'var(--mt5-text-primary)';
        }
        
        // Update content
        document.querySelectorAll('.bot-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        const activeContent = document.getElementById(`bot${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Content`);
        if (activeContent) {
            activeContent.style.display = 'block';
        }
        
        this.updateSelectedCount();
    }
    
    updateSelectedCount() {
        const selectedSignals = this.tradingSignals.filter(s => s.selected).length;
        const totalSelected = selectedSignals + this.selectedTrades.size;
        
        const countElement = document.getElementById('selectedCount');
        const countValue = document.getElementById('selectedCountValue');
        
        if (totalSelected > 0 && countElement && countValue) {
            countElement.style.display = 'flex';
            countValue.textContent = totalSelected;
        } else if (countElement) {
            countElement.style.display = 'none';
        }
    }
    
    updateStatusMessage(message) {
        const statusElement = document.getElementById('statusMessage');
        if (statusElement) {
            statusElement.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        }
    }
    
    // ==================== AUTO/MANUAL EXECUTION MODE METHODS ====================
    
    setExecutionMode(mode) {
        // Update config
        this.config.execution.mode = mode;
        
        // Update execution badge in status bar
        const badge = document.getElementById('executionModeBadge');
        if (badge) {
            if (mode === 'auto') {
                badge.style.background = 'rgba(0, 180, 160, 0.2)';
                badge.style.color = 'var(--mt5-accent-teal)';
                badge.style.borderColor = 'var(--mt5-accent-teal)';
                badge.innerHTML = 'AUTO EXECUTION';
                
                // Show desktop notification for auto mode
                if (this.config.notifications.desktopAlerts && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification("AUTO EXECUTION ENABLED", {
                        body: "High-confidence trades will execute automatically",
                        icon: "https://cdn-icons-png.flaticon.com/512/1828/1828884.png"
                    });
                } else if (this.config.notifications.desktopAlerts && 'Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification("AUTO EXECUTION ENABLED", {
                                body: "High-confidence trades will execute automatically",
                                icon: "https://cdn-icons-png.flaticon.com/512/1828/1828884.png"
                            });
                        }
                    });
                }
                
                this.showAdvancedNotification('Execution Mode Changed', 'AUTO EXECUTION ENABLED - High-confidence trades will execute automatically', 'success');
            } else {
                badge.style.background = 'rgba(255, 193, 7, 0.2)';
                badge.style.color = 'var(--mt5-accent-yellow)';
                badge.style.borderColor = 'var(--mt5-accent-yellow)';
                badge.innerHTML = 'MANUAL EXECUTION';
                
                this.showAdvancedNotification('Execution Mode Changed', 'MANUAL EXECUTION ENABLED - All trades require manual confirmation', 'info');
            }
        }
        
        // Update ultimate dashboard if visible
        if (this.ultimateContainer && this.ultimateContainer.style.display === 'flex') {
            const autoBtn = this.ultimateContainer.querySelector('#autoExecutionBtn');
            const manualBtn = this.ultimateContainer.querySelector('#manualExecutionBtn');
            
            if (autoBtn && manualBtn) {
                if (mode === 'auto') {
                    autoBtn.style.background = 'var(--mt5-accent-teal)';
                    autoBtn.style.color = 'white';
                    autoBtn.style.borderColor = 'var(--mt5-accent-teal)';
                    autoBtn.style.boxShadow = '0 0 10px rgba(0, 180, 160, 0.5)';
                    manualBtn.style.background = 'rgba(255,255,255,0.1)';
                    manualBtn.style.color = 'var(--mt5-text-secondary)';
                    manualBtn.style.borderColor = 'rgba(255,255,255,0.2)';
                    manualBtn.style.boxShadow = 'none';
                } else {
                    manualBtn.style.background = 'var(--mt5-accent-yellow)';
                    manualBtn.style.color = 'white';
                    manualBtn.style.borderColor = 'var(--mt5-accent-yellow)';
                    manualBtn.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.5)';
                    autoBtn.style.background = 'rgba(255,255,255,0.1)';
                    autoBtn.style.color = 'var(--mt5-text-secondary)';
                    autoBtn.style.borderColor = 'rgba(255,255,255,0.2)';
                    autoBtn.style.boxShadow = 'none';
                }
            }
        }
        
        // Save preference
        this.savePreferences();
        
        this.log(`Execution mode set to: ${mode.toUpperCase()}`, 'info');
    }
    
    // ==================== ULTIMATE DASHBOARD ====================
    
    showUltimateDashboard() {
        if (this.ultimateContainer) {
            this.ultimateContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Create ultimate dashboard content with all integrated features including Auto/Manual buttons
            this.createUltimateDashboard();
            
            this.log('Ultimate Dashboard displayed', 'info');
        }
    }
    
    createUltimateDashboard() {
        this.ultimateContainer.innerHTML = `
            <!-- Ultimate Dashboard Navigation -->
            <div class="system-navbar" style="background: linear-gradient(135deg, var(--mt5-bg-tertiary) 0%, #1a1f2e 100%); border-bottom: 1px solid var(--mt5-border); padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--mt5-accent-teal), #26c6da); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: 700; color: white; letter-spacing: 0.5px;">
                                XNets Ultimate Trading System
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 8px;">
                                <span id="ultimateStatus" style="color: ${this.isRunning ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">â— ${this.isRunning ? 'RUNNING' : 'STOPPED'}</span>
                                <span>â€¢</span>
                                <span>Active Account: <strong style="color: var(--mt5-accent-teal);">${this.currentAccount.name}</strong></span>
                                <span>â€¢</span>
                                <span>Active: <strong style="color: var(--mt5-accent-yellow);">${this.trading.activeTrades.length}</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button id="closeUltimateBtn" class="bot-control-btn" style="background: rgba(255,255,255,0.1); color: white;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <!-- Ultimate Dashboard Content - SCROLLABLE GRID LAYOUT -->
            <div style="flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: start;">
                
                <!-- COLUMN 1: Performance & Account Summary -->
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Performance Summary Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-trophy"></i>
                            <span>Performance Summary</span>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div class="metric">
                                    <div class="metric-label">Total Profit</div>
                                    <div class="metric-value" style="color: ${this.performance.totalProfit >= 0 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">$${this.performance.totalProfit.toFixed(2)}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Win Rate</div>
                                    <div class="metric-value" style="color: var(--mt5-accent-green);">${this.performance.winRate.toFixed(1)}%</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Total Trades</div>
                                    <div class="metric-value">${this.performance.totalTrades}</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Active Trades</div>
                                    <div class="metric-value">${this.trading.activeTrades.length}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Status Card (Multiple Accounts Feature) -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-wallet"></i>
                            <span>Account Management</span>
                        </div>
                        <div class="card-content">
                            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                                ${this.accounts.map(account => `
                                    <div class="account-selector-item ${account.isActive ? 'active' : ''}" 
                                         data-account-id="${account.id}"
                                         style="display: flex; align-items: center; gap: 12px; padding: 10px; background: ${account.isActive ? 'rgba(0, 180, 160, 0.1)' : 'rgba(0,0,0,0.1)'}; border-radius: 6px; cursor: pointer; border-left: ${account.isActive ? '4px solid var(--mt5-accent-teal)' : '4px solid transparent'};">
                                        <div style="width: 32px; height: 32px; background: ${account.isActive ? 'linear-gradient(135deg, var(--mt5-accent-teal), #26c6da)' : 'var(--mt5-bg-tertiary)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-user" style="color: ${account.isActive ? 'white' : 'var(--mt5-text-secondary)'};"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 600; color: var(--mt5-text-primary);">${account.name}</div>
                                            <div style="font-size: 11px; color: var(--mt5-text-secondary); display: flex; gap: 8px;">
                                                <span>Balance: $${account.balance.toFixed(2)}</span>
                                                <span>Leverage: 1:${account.leverage}</span>
                                            </div>
                                        </div>
                                        ${account.isActive ? `
                                            <span style="font-size: 11px; padding: 2px 8px; background: var(--mt5-accent-teal); color: white; border-radius: 10px;">
                                                Active
                                            </span>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="background: var(--mt5-bg-tertiary); padding: 12px; border-radius: 6px; margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: var(--mt5-text-secondary);">Current Balance</span>
                                    <span style="font-size: 16px; font-weight: 800; color: var(--mt5-accent-teal);">$${this.currentAccount.balance.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: var(--mt5-text-secondary);">Equity</span>
                                    <span style="font-size: 14px; font-weight: 700; color: var(--mt5-text-primary);">$${this.currentAccount.equity.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-size: 12px; color: var(--mt5-text-secondary);">Free Margin</span>
                                    <span style="font-size: 14px; font-weight: 700; color: ${this.currentAccount.freeMargin > 1000 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'};">$${this.currentAccount.freeMargin.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Size Calculator Card (Number of Trades / Risk per Trade Feature) -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-calculator"></i>
                            <span>Position Size & Risk</span>
                        </div>
                        <div class="card-content">
                            <div style="background: linear-gradient(135deg, #1a237e, #283593); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Risk per Trade</span>
                                    <span style="font-size: 20px; font-weight: 800; color: white;">${(this.config.riskManagement.riskPerTrade * 100).toFixed(1)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Risk Amount</span>
                                    <span style="font-size: 16px; font-weight: 800; color: white;">$${(this.currentAccount.equity * this.config.riskManagement.riskPerTrade).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Calculated Lots</span>
                                    <span style="font-size: 24px; font-weight: 800; color: var(--mt5-accent-teal);">${this.positionSizeCalculator.calculatedLots.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8);">Max Loss</span>
                                    <span style="font-size: 14px; font-weight: 700; color: var(--mt5-accent-red);">$${this.positionSizeCalculator.maxLoss.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--mt5-text-secondary); text-align: center;">
                                <i class="fas fa-info-circle"></i> Position size is automatically calculated based on account balance and risk per trade
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Timing Statistics Card (Timing of the Trade Feature) -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-hourglass-half"></i>
                            <span>Trade Timing Statistics</span>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div style="background: rgba(76, 175, 80, 0.1); padding: 16px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 800; color: var(--mt5-accent-green);">${this.tradeTiming.dependentTP}</div>
                                    <div style="font-size: 12px; color: var(--mt5-text-secondary);">TP Hit</div>
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5);">Dependent TP</div>
                                </div>
                                <div style="background: rgba(244, 67, 54, 0.1); padding: 16px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 800; color: var(--mt5-accent-red);">${this.tradeTiming.dependentSL}</div>
                                    <div style="font-size: 12px; color: var(--mt5-text-secondary);">SL Hit</div>
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5);">Dependent SL</div>
                                </div>
                            </div>
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 16px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800; color: var(--mt5-accent-yellow);">${this.tradeTiming.manualExits}</div>
                                <div style="font-size: 12px; color: var(--mt5-text-secondary);">Manual Exits</div>
                                <div style="font-size: 10px; color: rgba(255,255,255,0.5);">Manual Trade Closure</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 2: Strategy & Calendar -->
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- AUTO/MANUAL EXECUTION MODE CARD - YOUR INTEGRATED FEATURE -->
                    <div class="dashboard-card" style="border: 1px solid var(--mt5-accent-teal);">
                        <div class="card-header" style="border-bottom: 2px solid var(--mt5-accent-teal);">
                            <i class="fas fa-cog"></i>
                            <span>Execution Mode</span>
                        </div>
                        <div class="card-content">
                            <div style="display: flex; gap: 16px; align-items: center; justify-content: center; padding: 8px 0;">
                                <button id="autoExecutionBtn" class="bot-control-btn" 
                                        style="flex: 1; padding: 14px 20px; background: ${this.config.execution.mode === 'auto' ? 'var(--mt5-accent-teal)' : 'rgba(255,255,255,0.1)'}; 
                                               color: ${this.config.execution.mode === 'auto' ? 'white' : 'var(--mt5-text-secondary)'}; 
                                               border: 2px solid ${this.config.execution.mode === 'auto' ? 'var(--mt5-accent-teal)' : 'rgba(255,255,255,0.2)'}; 
                                               border-radius: 8px; font-size: 14px; font-weight: 700; 
                                               box-shadow: ${this.config.execution.mode === 'auto' ? '0 0 15px rgba(0, 180, 160, 0.5)' : 'none'};
                                               transition: all 0.3s;">
                                    <i class="fas fa-robot"></i> AUTO EXECUTION
                                </button>
                                <button id="manualExecutionBtn" class="bot-control-btn" 
                                        style="flex: 1; padding: 14px 20px; background: ${this.config.execution.mode === 'manual' ? 'var(--mt5-accent-yellow)' : 'rgba(255,255,255,0.1)'}; 
                                               color: ${this.config.execution.mode === 'manual' ? 'white' : 'var(--mt5-text-secondary)'}; 
                                               border: 2px solid ${this.config.execution.mode === 'manual' ? 'var(--mt5-accent-yellow)' : 'rgba(255,255,255,0.2)'}; 
                                               border-radius: 8px; font-size: 14px; font-weight: 700;
                                               box-shadow: ${this.config.execution.mode === 'manual' ? '0 0 15px rgba(255, 193, 7, 0.5)' : 'none'};
                                               transition: all 0.3s;">
                                    <i class="fas fa-user"></i> MANUAL EXECUTION
                                </button>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas ${this.config.execution.mode === 'auto' ? 'fa-check-circle' : 'fa-info-circle'}" 
                                   style="font-size: 16px; color: ${this.config.execution.mode === 'auto' ? 'var(--mt5-accent-teal)' : 'var(--mt5-accent-yellow)'};"></i>
                                <span style="font-size: 12px; color: var(--mt5-text-secondary);">
                                    ${this.config.execution.mode === 'auto' 
                                        ? 'âœ“ AUTO EXECUTION ENABLED: High-confidence trades (â‰¥75%) will execute automatically' 
                                        : 'â„¹ MANUAL EXECUTION ENABLED: All trades require manual confirmation'}
                                </span>
                            </div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--mt5-border); font-size: 11px; color: var(--mt5-text-secondary); text-align: center;">
                                <i class="fas fa-bell"></i> Trader informed â€¢ No ambiguity
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strategy Performance Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-brain"></i>
                            <span>Strategy Performance</span>
                        </div>
                        <div class="card-content">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${Object.entries(this.strategies).map(([key, strategy]) => {
                                    const perf = this.performance.strategyPerformance[key] || { totalTrades: 0, winRate: 0, totalProfit: 0 };
                                    return `
                                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; border-left: 4px solid ${strategy.color};">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <div style="font-weight: 600; color: var(--mt5-text-primary);">${strategy.name}</div>
                                                ${key === 'ibrahim' ? `
                                                    <span style="font-size: 10px; background: rgba(0, 180, 160, 0.2); color: var(--mt5-accent-teal); padding: 2px 8px; border-radius: 10px;">
                                                        <i class="fas fa-microchip"></i> Exact: ${strategy.exactExecution.enabled ? 'ON' : 'OFF'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 11px;">
                                                <div>
                                                    <div style="color: var(--mt5-text-secondary);">Trades</div>
                                                    <div style="color: var(--mt5-text-primary); font-weight: 700;">${perf.totalTrades}</div>
                                                </div>
                                                <div>
                                                    <div style="color: var(--mt5-text-secondary);">Win Rate</div>
                                                    <div style="color: ${perf.winRate >= 50 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'}; font-weight: 700;">${perf.winRate.toFixed(1)}%</div>
                                                </div>
                                                <div>
                                                    <div style="color: var(--mt5-text-secondary);">P&L</div>
                                                    <div style="color: ${perf.totalProfit >= 0 ? 'var(--mt5-accent-green)' : 'var(--mt5-accent-red)'}; font-weight: 700;">$${perf.totalProfit.toFixed(2)}</div>
                                                </div>
                                            </div>
                                            ${key === 'ibrahim' ? `
                                                <div style="margin-top: 8px; font-size: 11px; color: var(--mt5-text-secondary); display: flex; justify-content: space-between; align-items: center;">
                                                    <span><i class="fas fa-clock"></i> Last: ${strategy.exactExecution.lastExecution ? new Date(strategy.exactExecution.lastExecution).toLocaleTimeString() : 'Never'}</span>
                                                    <span><i class="fas fa-chart-line"></i> Executions: ${strategy.exactExecution.executionCount}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confidence Level Explanation Card (Confidence Level Explained Feature) -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i>
                            <span>Confidence Level Explained</span>
                        </div>
                        <div class="card-content">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div class="confidence-tooltip" style="background: rgba(76, 175, 80, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-green); display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; background: var(--mt5-accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check-circle" style="color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="font-weight: 700; color: var(--mt5-accent-green);">HIGH Confidence (â‰¥75%)</span>
                                            <button class="confidence-help-btn" data-level="high" style="background: none; border: none; color: var(--mt5-text-secondary); cursor: pointer;">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                        </div>
                                        <span style="font-size: 11px; color: var(--mt5-text-secondary);">${this.confidenceExplanations.high.description}</span>
                                    </div>
                                </div>
                                
                                <div class="confidence-tooltip" style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-yellow); display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; background: var(--mt5-accent-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-exclamation-triangle" style="color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="font-weight: 700; color: var(--mt5-accent-yellow);">MEDIUM Confidence (60-74%)</span>
                                            <button class="confidence-help-btn" data-level="medium" style="background: none; border: none; color: var(--mt5-text-secondary); cursor: pointer;">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                        </div>
                                        <span style="font-size: 11px; color: var(--mt5-text-secondary);">${this.confidenceExplanations.medium.description}</span>
                                    </div>
                                </div>
                                
                                <div class="confidence-tooltip" style="background: rgba(255, 152, 0, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid var(--mt5-accent-orange); display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; background: var(--mt5-accent-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-question-circle" style="color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="font-weight: 700; color: var(--mt5-accent-orange);">LOW Confidence (50-59%)</span>
                                            <button class="confidence-help-btn" data-level="low" style="background: none; border: none; color: var(--mt5-text-secondary); cursor: pointer;">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                        </div>
                                        <span style="font-size: 11px; color: var(--mt5-text-secondary);">${this.confidenceExplanations.low.description}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ibrahim Abu Strategy Card (Ibrahim Abu Strategy Feature) -->
                    <div class="dashboard-card">
                        <div class="card-header" style="border-bottom: 2px solid #00b4a0;">
                            <i class="fas fa-microchip"></i>
                            <span>Ibrahim Abu Strategy - Exact Execution</span>
                        </div>
                        <div class="card-content">
                            <div style="background: linear-gradient(135deg, #00b4a0, #008080); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 14px; font-weight: 700; color: white;">Strategy Status</span>
                                    <span style="font-size: 12px; padding: 4px 12px; background: rgba(255,255,255,0.2); color: white; border-radius: 20px;">
                                        ${this.strategies.ibrahim.exactExecution.enabled ? 'EXACT EXECUTION ACTIVE' : 'EXACT EXECUTION OFF'}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Execution Count</div>
                                        <div style="font-size: 24px; font-weight: 800; color: white;">${this.strategies.ibrahim.exactExecution.executionCount}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Win Rate</div>
                                        <div style="font-size: 24px; font-weight: 800; color: white;">${Math.round(this.strategies.ibrahim.winRate * 100)}%</div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.8);">
                                        <span><i class="fas fa-check-circle"></i> Strict Entry Criteria</span>
                                        <span><i class="fas fa-chart-line"></i> Confirmation Candles: ${this.strategies.ibrahim.exactExecution.parameters.confirmationCandles}</span>
                                        <span><i class="fas fa-volume-up"></i> Volume Required: ${this.strategies.ibrahim.exactExecution.parameters.requireVolume ? 'Yes' : 'No'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary);">Strategy Description</span>
                                </div>
                                <p style="font-size: 12px; color: var(--mt5-text-secondary); margin: 0; line-height: 1.5;">
                                    ${this.strategies.ibrahim.description} The system executes trades exactly as computed by the Ibrahim Abu algorithm, 
                                    with strict entry criteria including trend confirmation, volume validation, and multi-candle pattern verification.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 3: Economic Calendar & Quick Actions -->
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Economic Calendar Card (Calendar linked with API Feature) -->
                    <div class="dashboard-card" style="grid-column: span 1;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Economic Calendar</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="refreshCalendarBtn" class="small-btn" style="background: rgba(255,255,255,0.1); color: var(--mt5-text-primary); padding: 4px 10px;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button id="exportCalendarBtn" class="small-btn" style="background: rgba(255,255,255,0.1); color: var(--mt5-text-primary); padding: 4px 10px;">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="card-content" style="max-height: 400px; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--mt5-border);">
                                <span style="font-size: 11px; color: var(--mt5-text-secondary);">
                                    <i class="fas fa-database"></i> Forex Factory Integration
                                </span>
                                <span style="font-size: 11px; color: var(--mt5-text-secondary);" id="calendarLastUpdate">
                                    ${this.economicCalendar.lastUpdate ? this.economicCalendar.lastUpdate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Not updated'}
                                </span>
                            </div>
                            <div id="economicCalendarList" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- Dynamically populated -->
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--mt5-border); font-size: 11px; color: var(--mt5-text-secondary); text-align: center;">
                                <i class="fas fa-shield-alt"></i> High-impact news events are automatically filtered from trading signals
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-bolt"></i>
                            <span>Quick Actions</span>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <button class="quick-action-btn" data-action="start" style="background: var(--mt5-accent-teal); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-play"></i> Start System
                                </button>
                                <button class="quick-action-btn" data-action="stop" style="background: var(--mt5-accent-red); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-stop"></i> Stop System
                                </button>
                                <button class="quick-action-btn" data-action="closeAll" style="background: var(--mt5-accent-yellow); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-times"></i> Close All Trades
                                </button>
                                <button class="quick-action-btn" data-action="refreshCalendar" style="background: var(--mt5-accent-purple); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-calendar-alt"></i> Refresh Calendar
                                </button>
                            </div>
                            
                            <div style="margin-top: 16px; background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--mt5-text-primary); margin-bottom: 8px;">Keyboard Shortcuts</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: var(--mt5-text-secondary);">
                                    <span><span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Ctrl+B</span> Quick Buy</span>
                                    <span><span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Ctrl+S</span> Quick Sell</span>
                                    <span><span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Ctrl+P</span> Pause/Resume</span>
                                    <span><span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">F9</span> Start</span>
                                    <span><span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">F12</span> Stop</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add event listeners for ultimate dashboard
        this.ultimateContainer.querySelector('#closeUltimateBtn').addEventListener('click', () => {
            this.ultimateContainer.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Quick action buttons
        this.ultimateContainer.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.closest('.quick-action-btn').dataset.action;
                switch(action) {
                    case 'start':
                        this.startBot();
                        break;
                    case 'stop':
                        this.stopBot();
                        break;
                    case 'closeAll':
                        this.closeAllTrades();
                        break;
                    case 'refreshCalendar':
                        this.refreshEconomicCalendar();
                        break;
                }
            });
        });
        
        // Account switching
        this.ultimateContainer.querySelectorAll('.account-selector-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const accountId = item.dataset.accountId;
                this.switchAccount(accountId);
                
                // Update UI to reflect active account
                this.ultimateContainer.querySelectorAll('.account-selector-item').forEach(el => {
                    el.classList.remove('active');
                    el.style.background = 'rgba(0,0,0,0.1)';
                    el.style.borderLeft = '4px solid transparent';
                });
                
                item.classList.add('active');
                item.style.background = 'rgba(0, 180, 160, 0.1)';
                item.style.borderLeft = '4px solid var(--mt5-accent-teal)';
            });
        });
        
        // Confidence help buttons
        this.ultimateContainer.querySelectorAll('.confidence-help-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const level = btn.dataset.level;
                this.showConfidenceExplanation(level);
            });
        });
        
        // Refresh calendar button
        const refreshBtn = this.ultimateContainer.querySelector('#refreshCalendarBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.refreshEconomicCalendar());
        }
        
        // Export calendar button
        const exportBtn = this.ultimateContainer.querySelector('#exportCalendarBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportEconomicCalendar());
        }
        
        // AUTO/MANUAL EXECUTION MODE BUTTONS - YOUR INTEGRATED FEATURE
        const autoBtn = this.ultimateContainer.querySelector('#autoExecutionBtn');
        const manualBtn = this.ultimateContainer.querySelector('#manualExecutionBtn');
        
        if (autoBtn) {
            autoBtn.addEventListener('click', () => this.setExecutionMode('auto'));
        }
        
        if (manualBtn) {
            manualBtn.addEventListener('click', () => this.setExecutionMode('manual'));
        }
        
        // Update economic calendar display
        this.updateEconomicCalendarDisplay();
    }
    
    // ==================== UTILITY METHODS ====================
    
    showBotInterface() {
        console.log('Showing bot interface...');
        
        // Hide all chart containers
        document.querySelectorAll('.chart-container > *').forEach(element => {
            if (!element.classList.contains('bot-workspace-container')) {
                element.style.display = 'none';
            }
        });
        
        // Show bot container
        if (this.botContainer) {
            this.botContainer.style.display = 'flex';
        }
        
        // Update tab states
        this.updateTabStates();
    }
    
    hideBotInterface() {
        console.log('Hiding bot interface...');
        
        // Show chart content
        document.querySelectorAll('.chart-container > *').forEach(element => {
            element.style.display = '';
        });
        
        // Hide bot container
        if (this.botContainer) {
            this.botContainer.style.display = 'none';
        }
    }
    
    updateTabStates() {
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        if (this.botTab) {
            this.botTab.classList.add('active');
        }
    }
    
    addToolbarButtons() {
        console.log('Adding toolbar buttons...');
        const toolbar = document.querySelector('.toolbar-shortcuts');
        if (!toolbar) {
            setTimeout(() => this.addToolbarButtons(), 500);
            return;
        }
        
        // Remove existing buttons if any
        const existingBtn = document.getElementById('ultimateToolbarButton');
        if (existingBtn) existingBtn.remove();
        
        // Create ultimate button
        const ultimateButton = document.createElement('button');
        ultimateButton.id = 'ultimateToolbarButton';
        ultimateButton.className = 'shortcut-btn';
        ultimateButton.innerHTML = '<i class="fas fa-rocket"></i> Ultimate System';
        ultimateButton.style.cssText = 'background: linear-gradient(135deg, var(--mt5-accent-teal), #26c6da); color: white; border: none; font-weight: 700; box-shadow: 0 2px 8px rgba(0, 180, 160, 0.3);';
        
        ultimateButton.addEventListener('click', () => {
            this.showUltimateDashboard();
        });
        
        toolbar.appendChild(ultimateButton);
        console.log('Toolbar buttons added');
    }
    
    loadPreferences() {
        try {
            const saved = localStorage.getItem('ultimateTradingPreferences');
            if (saved) {
                const prefs = JSON.parse(saved);
                Object.assign(this.config, prefs.config || {});
                
                // Load accounts
                if (prefs.accounts) {
                    this.accounts = prefs.accounts;
                    const activeAccount = this.accounts.find(a => a.isActive) || this.accounts[0];
                    this.currentAccount = activeAccount;
                    this.account = {...activeAccount};
                }
                
                // Load strategy states
                if (prefs.strategies) {
                    Object.keys(prefs.strategies).forEach(key => {
                        if (this.strategies[key] && prefs.strategies[key]) {
                            this.strategies[key].active = prefs.strategies[key].active || false;
                            if (prefs.strategies[key].exactExecution) {
                                this.strategies[key].exactExecution = {
                                    ...this.strategies[key].exactExecution,
                                    ...prefs.strategies[key].exactExecution
                                };
                            }
                        }
                    });
                }
                
                // Restore selected symbols
                if (prefs.config && prefs.config.selectedSymbols) {
                    this.config.selectedSymbols = prefs.config.selectedSymbols;
                }
                
                // Restore timeframe selections
                if (prefs.config && prefs.config.activeTimeframes) {
                    this.config.activeTimeframes = prefs.config.activeTimeframes;
                }
            }
        } catch (e) {
            console.log('No saved preferences found');
        }
    }
    
    savePreferences() {
        const prefs = {
            config: this.config,
            accounts: this.accounts,
            strategies: this.strategies
        };
        localStorage.setItem('ultimateTradingPreferences', JSON.stringify(prefs));
    }
    
    log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const typeIcon = {
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            info: 'â„¹ï¸'
        }[type] || 'â„¹ï¸';
        
        console.log(`${typeIcon} [${timestamp}] ${message}`);
        
        // Add to trade journal
        this.trading.tradeJournal.push({
            timestamp: new Date(),
            type: type,
            message: message
        });
    }
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    getBasePrice(symbol) {
        const prices = {
            'XAUUSD': 2025.46,
            'EURUSD': 1.08032,
            'GBPUSD': 1.24742,
            'BTCUSD': 42653.9,
            'USDJPY': 148.50,
            'AUDUSD': 0.6575,
            'USDCAD': 1.3520,
            'NZDUSD': 0.6125
        };
        return prices[symbol] || 100.00;
    }
    
    generateTradeHistoryCSV() {
        const headers = ['Time', 'Symbol', 'Direction', 'Strategy', 'Entry', 'Exit', 'Volume', 'P&L', 'Result'];
        const rows = this.trading.tradeHistory.map(trade => [
            trade.closedAt.toLocaleString(),
            trade.symbol,
            trade.direction,
            trade.strategy,
            trade.entryPrice.toFixed(5),
            trade.closePrice.toFixed(5),
            trade.volume.toFixed(2),
            trade.realizedPNL.toFixed(2),
            trade.realizedPNL >= 0 ? 'WIN' : 'LOSS'
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }
    
    showWelcomeMessage() {
        // Show welcome in the trading signals area
        const container = document.getElementById('tradingSignalsList');
        if (container) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--mt5-text-secondary); text-align: center; padding: 40px 20px;">
                    <div style="font-size: 32px; color: var(--mt5-accent-teal); margin-bottom: 16px;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--mt5-text-primary); margin-bottom: 12px;">
                        Welcome to XNets Ultimate Trading System
                    </div>
                    <div style="font-size: 14px; color: var(--mt5-text-secondary); margin-bottom: 32px; max-width: 600px;">
                        Professional-grade trading platform with AI-powered analysis, advanced risk management, and comprehensive analytics
                    </div>
                    <button id="getStartedBtn" style="padding: 12px 32px; background: var(--mt5-accent-teal); 
                           color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-rocket"></i> Get Started
                    </button>
                </div>
            `;
            
            document.getElementById('getStartedBtn')?.addEventListener('click', () => {
                this.startBot();
            });
        }
    }
    
    // ==================== ANALYTICS HELPER METHODS ====================
    
    analyzeTrend(symbol, timeframe) {
        const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
        const volatility = this.marketData.volatility[symbol] || 0.002;
        
        // Simulate trend analysis
        const trendStrength = Math.random();
        const direction = this.marketData.trends[symbol];
        
        return {
            direction: direction,
            strength: trendStrength,
            momentum: trendStrength * (direction === 'bullish' ? 1 : -1)
        };
    }
    
    analyzeMomentum(symbol, timeframe) {
        // Simulate momentum analysis
        return {
            rsi: 30 + Math.random() * 40,
            macd: (Math.random() - 0.5) * 0.02,
            stochastic: Math.random() * 100
        };
    }
    
    calculateSupport(symbol, timeframe) {
        const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
        return price * (0.99 + Math.random() * 0.01);
    }
    
    calculateResistance(symbol, timeframe) {
        const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
        return price * (1.01 + Math.random() * 0.01);
    }
    
    calculateTimeframeScore(trend, momentum, volatility) {
        let score = 0;
        score += trend.strength * 0.3;
        score += (momentum.rsi > 30 && momentum.rsi < 70 ? 0.2 : 0.1);
        score += (Math.abs(momentum.macd) > 0.01 ? 0.2 : 0.1);
        score += (volatility < 0.005 ? 0.3 : 0.1);
        return score;
    }
    
    generateConsensus(timeframes) {
        let bullish = 0;
        let bearish = 0;
        let totalScore = 0;
        
        Object.values(timeframes).forEach(tf => {
            if (tf.trend.direction === 'bullish') bullish += tf.score;
            else bearish += tf.score;
            totalScore += tf.score;
        });
        
        return {
            direction: bullish > bearish ? 'bullish' : 'bearish',
            confidence: totalScore / Object.keys(timeframes).length,
            score: Math.max(bullish, bearish) / totalScore
        };
    }
    
    calculateConfidence(consensus) {
        return consensus.confidence * consensus.score;
    }
    
    playNotificationSound(type) {
        // In a real implementation, this would play actual sounds
        console.log(`Playing ${type} notification sound`);
    }
    
    // ==================== EVENT HANDLER ATTACHMENT ====================
    
    attachTradeCardHandlers() {
        const container = document.getElementById('activeTradesList');
        if (!container) return;
        
        // Trade card click handlers
        container.querySelectorAll('.trade-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.trade-action-btn')) {
                    const tradeId = card.dataset.tradeId;
                    this.toggleTradeSelection(tradeId);
                }
            });
        });
        
        // Action button handlers
        container.querySelectorAll('.trade-action-btn[data-action="close"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const tradeId = btn.dataset.tradeId;
                const trade = this.trading.activeTrades.find(t => t.id === tradeId);
                if (trade) {
                    const confirmed = confirm(`Close ${trade.direction} ${trade.symbol} at ${trade.currentPrice.toFixed(5)}?`);
                    if (confirmed) {
                        this.closeTrade(tradeId, 'MANUAL_CLOSE');
                    }
                }
            });
        });
        
        container.querySelectorAll('.trade-action-btn[data-action="details"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const tradeId = btn.dataset.tradeId;
                const trade = this.trading.activeTrades.find(t => t.id === tradeId);
                if (trade) {
                    this.showTradeDetails(trade);
                }
            });
        });
    }
    
    attachSignalCardHandlers() {
        const container = document.getElementById('tradingSignalsList');
        if (!container) return;
        
        // Signal card click handlers
        container.querySelectorAll('.signal-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.signal-execute-btn') && !e.target.closest('.signal-ignore-btn')) {
                    const signalId = card.dataset.signalId;
                    this.toggleSignalSelection(signalId);
                }
            });
        });
    }
    
    showTradeDetails(trade) {
        const details = `
            <div style="padding: 20px;">
                <h3 style="color: var(--mt5-text-primary); margin-bottom: 16px;">Trade Details</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div><strong>Symbol:</strong> ${trade.symbol}</div>
                    <div><strong>Direction:</strong> ${trade.direction}</div>
                    <div><strong>Strategy:</strong> ${trade.strategy}</div>
                    <div><strong>Volume:</strong> ${trade.volume} lots</div>
                    <div><strong>Entry Price:</strong> ${trade.entryPrice.toFixed(5)}</div>
                    <div><strong>Current Price:</strong> ${trade.currentPrice.toFixed(5)}</div>
                    <div><strong>Stop Loss:</strong> ${trade.stopLoss.toFixed(5)}</div>
                    <div><strong>Take Profit:</strong> ${trade.takeProfit.map(tp => tp.toFixed(5)).join(', ')}</div>
                    <div><strong>Unrealized P&L:</strong> $${trade.unrealizedPNL.toFixed(2)}</div>
                    <div><strong>Opened:</strong> ${trade.openedAt.toLocaleString()}</div>
                </div>
            </div>
        `;
        
        alert(details);
    }
    
    showQuickTradeDialog(direction) {
        if (this.config.selectedSymbols.length === 0) {
            this.showAdvancedNotification('Warning', 'No Instrument Selected', 'warning');
            return;
        }
        
        const symbol = this.config.selectedSymbols[0];
        const price = this.marketData.prices[symbol] || this.getBasePrice(symbol);
        
        // Calculate position size based on risk
        const stopLoss = direction === 'BUY' ? price * 0.995 : price * 1.005;
        const volume = this.calculatePositionSize(symbol, price, stopLoss, direction);
        
        const signal = {
            id: `QUICK_${Date.now()}`,
            strategy: 'Manual Quick Trade',
            symbol: symbol,
            direction: direction,
            entryPrice: price,
            stopLoss: stopLoss,
            takeProfit: direction === 'BUY' ? [price * 1.01, price * 1.02] : [price * 0.99, price * 0.98],
            confidence: 1.0,
            timestamp: new Date(),
            reason: 'Manual quick trade execution',
            volume: volume
        };
        
        this.showTradeExecution({
            direction: direction,
            symbol: symbol,
            entryPrice: price,
            strategy: 'Quick Trade',
            volume: volume
        });
        this.executeTrade(signal);
    }
    
    toggleTradeSelection(tradeId) {
        if (this.selectedTrades.has(tradeId)) {
            this.selectedTrades.delete(tradeId);
        } else {
            this.selectedTrades.add(tradeId);
        }
        
        this.updateActiveTradesDisplay();
        this.updateSelectedCount();
    }
    
    toggleSignalSelection(signalId) {
        const signal = this.tradingSignals.find(s => s.id === signalId);
        if (signal) {
            signal.selected = !signal.selected;
            this.updateSignalsDisplay();
            this.updateSelectedCount();
        }
    }
}

// ==============================================
// INITIALIZATION
// ==============================================

// Initialize when platform loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸš€ Loading Ultimate Trading System...');
    setTimeout(() => {
        if (typeof window.xnetsPlatform !== 'undefined') {
            console.log('Platform found, creating ultimate system instance...');
            window.ultimateTradingSystem = new XNetsUltimateTradingSystem();
            console.log('XNets Ultimate Trading System initialized successfully!');
        } else {
            console.log('Platform not ready, creating ultimate system anyway...');
            window.ultimateTradingSystem = new XNetsUltimateTradingSystem();
            console.log('XNets Ultimate Trading System initialized (standalone mode)');
        }
    }, 2000);
});

// Make class globally available
if (typeof window !== 'undefined') {
    window.XNetsUltimateTradingSystem = XNetsUltimateTradingSystem;
}
    </script>
</body>
</html>